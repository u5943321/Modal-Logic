\documentclass[letterpaper]{article}

\setlength{\voffset}{-0.5in}
\setlength{\textheight}{710pt}


\usepackage[margin=1in,footskip=0.25in]{geometry}
\usepackage{holtexbasic}
\usepackage{ stmaryrd }
\usepackage{amsthm}
\usepackage{proof}
\newtheorem{defn}{Definition}

\renewcommand{\HOLConst}[1]{{\textsf{\upshape\small #1}}}
\renewcommand{\HOLinline}[1]{\ensuremath{#1}}
\newcommand{\holthmenv}[1]{\begin{array}[t]{l}#1\end{array}}
\renewcommand{\HOLKeyword}[1]{\texttt{#1}}

\newenvironment{holmath}{\begin{displaymath}\begin{array}{l}}{\end{array}\end{displaymath}\ignorespacesafterend}
\newenvironment{solution}{\begin{proof}[Solution]}{\end{proof}}
\renewcommand{\baselinestretch}{1.4}

\title{Modal Logic Mechanisation in HOL4}
\author{Yiming Xu}
\date{15/6/2018}

\begin{document}

\maketitle

\section{Getting Start}

In our formalisation, we only consider the most standard modal language, called the basic modal language. The basic modal language is defined using a set $\Phi$ of propositional formulas, and only one modal operator $\Diamond$. A formula in the basic modal language is either a propositional symbol $p$ where $p\in \Phi$, or a disjunction $\psi\lor\phi$  of prmodal formulas $\psi$ and $\phi$, or the negation $\lnot \phi$ of a modal formula $\phi$, or else of the form $\Diamond \phi$ obtained by putting a diamond before a modal formula. In the HOL, we create a datatype called `form' of the formulas of this modal language. 

\begin{holmath}
  \ensuremath{\alpha}\;\HOLTyOp{chap1\$form}\;=\\
\;\;\;\;\HOLConst{VAR}\;\ensuremath{\alpha}\\
\;\;\HOLTokenBar{}\;\HOLConst{DISJ}\;(\ensuremath{\alpha}\;\HOLTyOp{chap1\$form})\;(\ensuremath{\alpha}\;\HOLTyOp{chap1\$form})\\
\;\;\HOLTokenBar{}\;\HOLSymConst{\ensuremath{\bot}}\\
\;\;\HOLTokenBar{}\;(\HOLSymConst{\HOLTokenNeg{}})\;(\ensuremath{\alpha}\;\HOLTyOp{chap1\$form})\\
\;\;\HOLTokenBar{}\;\HOLSymConst{\ensuremath{\Diamond}}\;(\ensuremath{\alpha}\;\HOLTyOp{chap1\$form})
\end{holmath}

When we say an `$\alpha$ form', we mean a formula in the basic modal language defined on a set $\Phi$ with elements of type $\alpha$, such a set is called an $\alpha$ set, and of type $\alpha \to bool$. Note that we have the notion of the conjunction `$\land$', the implication $\to$, and the truth `$\top$', but they are not primitive, and defined as:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{DISJ}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{2}}})
  \ensuremath{\HOLTokenTurnstile}(\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\ensuremath{\rightarrow}}\;\HOLFreeVar{f\sb{\mathrm{2}}})\;\HOLSymConst{=}\;\HOLConst{DISJ}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLFreeVar{f\sb{\mathrm{2}}}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{TRUE}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenNeg{}}\HOLSymConst{\ensuremath{\bot}}
\end{holmath}

As an analogue of the duality of the universal quantifier is the dual of the existential quantifier, in the sense that $\exists$ is defined to be $\lnot\forall\lnot$, we have a modal operator that is dual to the diamond, defined by $\Box \phi:= \lnot\Diamond \lnot \phi$. 

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLSymConst{\ensuremath{\Box}}\;\HOLFreeVar{\ensuremath{\phi}}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenNeg{}}\HOLSymConst{\ensuremath{\Diamond}}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{\ensuremath{\phi}})
\end{holmath}

If a modal formula does not use any diamond, then it is also a propositional formula:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p}.\;\HOLConst{propform}\;(\HOLConst{VAR}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{T})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\phi\sb{1}}}\;\HOLBoundVar{\ensuremath{\phi\sb{2}}}.\;\HOLConst{propform}\;(\HOLConst{DISJ}\;\HOLBoundVar{\ensuremath{\phi\sb{1}}}\;\HOLBoundVar{\ensuremath{\phi\sb{2}}})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{propform}\;\HOLBoundVar{\ensuremath{\phi\sb{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{propform}\;\HOLBoundVar{\ensuremath{\phi\sb{2}}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLConst{propform}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{f})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{propform}\;\HOLBoundVar{f})\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLConst{propform}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{T})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLConst{propform}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{f})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F}
\end{holmath}

Knowing how does the modal formulas we are interested in look like, now we want to consider what does they mean. If the modal formula defined using propositional symbols in an $\alpha$-set $\Phi$ is a propositional formula, then to talk about its truth value, what we need is just an assignment of truth value of the propositional letters in $\Phi$, that is, a function $\Phi\to bool$. In the HOL, to define a function from an $\alpha$-set, where $\alpha$ is any type, we are not allowed to only assign values to the elements of the set, instead, we must define the function on for all the terms that has type $\alpha$. Hence we can define the function of evaluating propositional formulas as takes a function $\sigma:\alpha\to bool$ and an $\alpha$ propositional formula, and let it spit out the truth value of the propositional formula under the assignment $\sigma$.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{p}.\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;(\HOLConst{VAR}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;(\HOLConst{DISJ}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenDisj{}}\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{f\sb{\mathrm{2}}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}.\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{f}.\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{f})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{f})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{f}.\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{f})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F}
\end{holmath}

However, to interpret a modal formula that involves diamonds, an assignment of truth value is not enough. We need a model of our language. A model of the basic modal language consists of two pieces of informations. The first thing we need is a frame. A frame consists of two things, a set, and a relation defined on elements in this set. If the underlying set of a frame is an $\beta$-set, then the frame is called an $\beta$-frame.
\begin{holmath}
  \ensuremath{\alpha}\;\HOLTyOp{frame} = \HOLTokenLeftrec{}\;\HOLFieldName{world}\;:\;\ensuremath{\alpha}\;\ensuremath{\rightarrow}\;\HOLTyOp{bool};\;\HOLFieldName{rel}\;:\;\ensuremath{\alpha}\;\ensuremath{\rightarrow}\;\ensuremath{\alpha}\;\ensuremath{\rightarrow}\;\HOLTyOp{bool}\;\HOLTokenRightrec{}
\end{holmath}

The second thing we need is a valuation. If we are taking about interpret an $\alpha$-form on a $\beta$-frame, a valuation is a function of type $\beta\to\alpha\to bool$. The information that a valuation gives is that, for each point in the frame, an assignment of truth value of each propositional symbol. We get a model by putting a frame and a valuation together.

\begin{holmath}
  (\ensuremath{\alpha},\;\ensuremath{\beta})\;\HOLTyOp{chap1\$model} = \HOLTokenLeftrec{}\\
\;\;\;\HOLFieldName{frame}\;:\;\ensuremath{\beta}\;\HOLTyOp{frame};\\
\;\;\;\HOLFieldName{valt}\;:\;\ensuremath{\alpha}\;\ensuremath{\rightarrow}\;\ensuremath{\beta}\;\ensuremath{\rightarrow}\;\HOLTyOp{bool}\\
\HOLTokenRightrec{}
\end{holmath}

When we say an $(\alpha,\beta)$-model, we mean a model for $\alpha$-forms with a $\beta$-set as its underlying set.

Now we can interpret modal formulas in the basic modal language on a model by defining satisfication.
\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{p}.\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLConst{VAR}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\phi}}.\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{\ensuremath{\phi}})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\phi}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\phi\sb{1}}}\;\HOLBoundVar{\ensuremath{\phi\sb{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLConst{DISJ}\;\HOLBoundVar{\ensuremath{\phi\sb{1}}}\;\HOLBoundVar{\ensuremath{\phi\sb{2}}})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\phi\sb{1}}}\;\HOLSymConst{\HOLTokenDisj{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\phi\sb{2}}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\phi}}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{\ensuremath{\phi}})\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{v}\;\HOLBoundVar{\ensuremath{\phi}}
\end{holmath}

(insert an example of model and satisfication here)

Just as in first order logic and propositional logic, we can define the notion of logical equivalence of modal formulas which is an equivalence relation between formulas which use propositional symbols of the same type:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{equiv0}\;\HOLFreeVar{tyi}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{f\sb{\mathrm{2}}}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLConst{equiv_on}\;\HOLFreeVar{s}
\end{holmath}

A notable thing is that \HOLinline{\HOLConst{equiv0}} need to take a type itself, denoted as \HOLinline{\HOLFreeVar{\ensuremath{\mu}}}, and if \HOLinline{\HOLFreeVar{\ensuremath{\mu}}} denotes the type \HOLinline{\HOLFreeVar{\ensuremath{\alpha}}} itself and \HOLinline{\HOLFreeVar{f\sb{\mathrm{1}}}}, \HOLinline{\HOLFreeVar{f\sb{\mathrm{2}}}} are \HOLinline{\HOLFreeVar{\ensuremath{\beta}}} formulas, \HOLinline{\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}}} means for any $(\alpha,\beta)$-model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and any world \HOLinline{\HOLFreeVar{w}} in it, we have \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f\sb{\mathrm{2}}}}. We are not allowed to omit the \HOLinline{\HOLFreeVar{\ensuremath{\mu}}} in the definition, since then we will introduce a type, namely the type of models \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, that only appear on the right hand side but not on the left hand side of the definition, which is not allowed. Also we are not allowed to quantify over the \HOLinline{\HOLFreeVar{\ensuremath{\mu}}}, and something like `equiv f1 f2 $\Leftrightarrow$ !$\mu$. equiv0 $\mu$ f1 f2' is also not allowed. This is actually a inconvenience of the HOL, since when we mention equivalence of formulas in usual mathematical language, we are implicitly taking about the class of all models, but the constrain here bans us from talking about all models at once.

We can immediately prove that for $\mu$ denotes any type, if \HOLinline{\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f}\;\HOLFreeVar{g}} then \HOLinline{\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{f})\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{g})}, but the converse does not hold under our definition. In the usual mathematical notion of equivalence, if two diamond formulas \HOLinline{\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{f}} and \HOLinline{\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{g}} are equivalent, then \HOLinline{\HOLFreeVar{f}} and \HOLinline{\HOLFreeVar{g}} must be equivalent. It is because if $f$ and $g$ are not equivalent, then there eixsts a model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and a world $w$ such that $w$ satisfies $f$ but not $g$, then we can attach a world that is only linked to $w$, and the world we add is a witness of the fact that \HOLinline{\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{f}} and \HOLinline{\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{g}} are not equivalent. But under our definition in the HOL, if the $\mu$ denotes a finite type, then it is possible that we have \HOLinline{\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{f})\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{g})} but \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f}\;\HOLFreeVar{g}}. For example, consider the type that has only two inhabitants $a,b$, then in the model below, we have \HOLinline{\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;(\HOLConst{VAR}\;\HOLFreeVar{p}))\;(\HOLSymConst{\ensuremath{\Diamond}}\;(\HOLConst{VAR}\;\HOLFreeVar{q}))} but \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;(\HOLConst{VAR}\;\HOLFreeVar{p})\;(\HOLConst{VAR}\;\HOLFreeVar{q})}.

(add the picture of example, how to draw it?)

As the situition above is only because of our special definition, such case is uninteresting. For any model, regardless its world set is of a finite type or not, we can always create a copy of the model in an infinite type. So it is harmless to just consider equivalence of formulas for models whose underlying set is of an infinite type. When $\mu$ denotes an infinite type, as we can always come up with a fresh world that allows the proof of equivalence between $f$ and $g$ from the equivalence of $\Diamond f$ and $\Diamond g$ as in the usual sense to go through, we do have a double implication:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{INFINITE}\;\ensuremath{\cal{U}}(:\ensuremath{\beta})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{f})\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{g})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f}\;\HOLFreeVar{g})
\end{holmath}


Given a modal formula, we can extract the set of propositional symbols appear in it, as:
\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p}.\;\HOLConst{prop_letters}\;(\HOLConst{VAR}\;\HOLBoundVar{p})\;\HOLSymConst{=}\;\HOLTokenLeftbrace{}\HOLBoundVar{p}\HOLTokenRightbrace{})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{prop_letters}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{prop_letters}\;(\HOLConst{DISJ}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}})\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{prop_letters}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLConst{prop_letters}\;\HOLBoundVar{f\sb{\mathrm{2}}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLConst{prop_letters}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{f})\;\HOLSymConst{=}\;\HOLConst{prop_letters}\;\HOLBoundVar{f})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLConst{prop_letters}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{f})\;\HOLSymConst{=}\;\HOLConst{prop_letters}\;\HOLBoundVar{f}
\end{holmath}

Then we can show when evaluating a formula $\phi$ on a model, the only relevant information in the valuation is the assignment it makes to the propositional letters actually occurring in $\phi$:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}\;\HOLSymConst{=}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p}.\;\HOLBoundVar{p}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{prop_letters}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{valt}\;\HOLBoundVar{p}\;\HOLSymConst{=}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{valt}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLBoundVar{w}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLBoundVar{w}\;\HOLFreeVar{phi})
\end{holmath}

In particular, if we are interpreting a propositional formula, then we do not need the relation on the model, as we can prove from definition:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{propform}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{peval}\;(\HOLTokenLambda{}\HOLBoundVar{a}.\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{a})\;\HOLFreeVar{f})
\end{holmath}

Moreover, we only need the truth values of the propositional symbols that appears in the formula:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{propform}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{VAR}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{peval}\;((\HOLTokenLambda{}\HOLBoundVar{a}.\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{a})\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{s})\;\HOLFreeVar{f})
\end{holmath}

One may confused why are we allowed to write $\lambda \ a. w \in M.valt \ a) \cap s$ here, for $\lambda \ a. (w \in M.valt\ a)$ is a function but $s$ is a set. This is because both the $\alpha$-set $s$ and the function $\lambda \ a. (w \in M.valt)$ has type $\alpha\to bool$, so they can be feeded to the function $\cap$, which has type $(\alpha\to bool)\to (\alpha\to bool)\to (\alpha\to bool)$. Hence for the set $s$, we can either view it as a collection of elements of type $\alpha$, or a function that assigns each term of type $\alpha$ a truth value, where the truth value assigned to $a:\alpha$ is $T$ if and only if $a\in s$.

(change subforms to propsyms later?)

\section{Invariant results and bisimulations}


The key concept we are interested in this chapter is called `modal equivalent', by `two worlds $w\in M.frame.world,w'\in M'.frame.world$ are modal equivalent', we mean they satisfies exactly the same modal formulas.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\phi}}.\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLBoundVar{\ensuremath{\phi}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w\sp{\prime}}\;\HOLBoundVar{\ensuremath{\phi}}
\end{holmath}

In this chapter, we investigate when can we get modal equivalence. In the first section, we talk about how can we get new models from old models without affect modal satisfication, and then we introduce morphisms between models, and find out under which condition we can map a point of a model to another model and preserve satisfication. In the second section, we investigate a kind of relation between models, called bisimulation, that gives arise to modal equivalence, in the sense of two worlds that are related by a bisimulation satisfies the same modal formulas.


\subsection{Operations on models}

Here we introduce two operations on models, called disjoint union and generated submodels respectively. 

The operation on models that leads to invarience of formulas in the most straightforward way is the disjoint union:

\begin{holmath}
   \HOLConst{DU}\;(\HOLFreeVar{f}\HOLSymConst{,}\HOLFreeVar{dom})\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{frame}\;:=\\
\;\;\;\;\HOLTokenLeftrec{}\HOLFieldName{world}\;:=\\
\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{w}\;\HOLTokenBar{}\;\HOLConst{FST}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{dom}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{SND}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{f}\;(\HOLConst{FST}\;\HOLBoundVar{w})).\HOLFieldName{frame}.\HOLFieldName{world}\HOLTokenRightbrace{};\\
\;\;\;\;\;\;\HOLFieldName{rel}\;:=\\
\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{FST}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLConst{FST}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FST}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLFreeVar{f}\;(\HOLConst{FST}\;\HOLBoundVar{w\sb{\mathrm{1}}})).\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLConst{SND}\;\HOLBoundVar{w\sb{\mathrm{1}}})\;(\HOLConst{SND}\;\HOLBoundVar{w\sb{\mathrm{2}}}))\HOLTokenRightrec{};\\
\;\;\HOLFieldName{valt}\;:=\;(\HOLTokenLambda{}\HOLBoundVar{v}\;\HOLBoundVar{w}.\;(\HOLFreeVar{f}\;(\HOLConst{FST}\;\HOLBoundVar{w})).\HOLFieldName{valt}\;\HOLBoundVar{v}\;(\HOLConst{SND}\;\HOLBoundVar{w}))\HOLTokenRightrec{}
\end{holmath} 


Disjoint union is defined as a function that takes a function that takes a function $f:\beta\to (\alpha,\gamma)$-model and a $\beta$-set $dom$, which plays the role of the index set that we take the disjoint union over. The function $f$ are defined for all terms of type $\beta$, but actually we only need its value on elements in $dom$. Given a family of models indexed by the set $dom$, the world set of the disjoint union of this family has elements of form $(i,w)$ where $i\in dom$ and $w\in (f \ i).frame.world$. For a propositional letter $p$ and a world $(i,w)$, we have $DU \ (f,dom).valt \ p\ (i,w)$ iff $(f \ i).valt \ p \ w$, and $DU \ (f,dom).rel \ (i,w) \ (i',w')$ iff $i=i'$ and $(f\ i).frame.rel \ w \ w'$, means that $(i,w)$ and $(i',w')$ come from the same model and are related by the relation in that model. 

The disjoint union does nothing except for collecting a set of models together, so it is unsurprising that we can prove by induction that:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FST}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{dom}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{satis}\;(\HOLFreeVar{f}\;(\HOLConst{FST}\;\HOLFreeVar{w}))\;(\HOLConst{SND}\;\HOLFreeVar{w})\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\HOLConst{satis}\;(\HOLConst{DU}\;(\HOLFreeVar{f}\HOLSymConst{,}\HOLFreeVar{dom}))\;\HOLFreeVar{w}\;\HOLFreeVar{phi})
\end{holmath}

Disjoint union is the operation we use when we want to expand out scope from a smaller model to a large model. Accordingly, we have an operation that allows us to restrict our scope to a smaller model, this is called `generated submodel' construction. 

When we say `$M_1$ is a submodel of $M_2$, we mean $M_1$ is a part of $M_2$.

\begin{holmath}
  \HOLConst{SUBMODEL}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w\sb{\mathrm{1}}}.\\
\;\;\;\;\;\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}.\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{valt}\;\HOLBoundVar{v}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{valt}\;\HOLBoundVar{v}\;\HOLBoundVar{w\sb{\mathrm{1}}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;(\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}})
\end{holmath}

It is not necessary that submodel construction preserves modal satisfication, since we can discard relations between worlds and hence destroy the satisfication of formulas with diamonds. 


%(Give an easy example?)

But after adding some constrains to the relations that we need to preserve, we can have a special kind of submodels, called generated submodels, that preserves modal satisfication.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{GENSUBMODEL}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\HOLConst{SUBMODEL}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w\sb{\mathrm{1}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}
\end{holmath}

Note that for a model $M_1$ to be a generated submodel of $M_2$, we only require all the worlds $w'$ which have a link from a world $w$ in $M_1$ to be also included in the world set of $M_1$, and we are allowed to completely ignore everthing that is linked to a world in $M_1$. This is because modal formulas cannot `look back', in the sense that linking or discard links to a world does not change the set of satisfied formulas at the world. 

%(prove a little proposition about it?)

Also by induction, we can prove the invariance of modal satisfication under taking generated submodels:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{GENSUBMODEL}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLFreeVar{n}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLFreeVar{n}\;\HOLFreeVar{phi})
\end{holmath}


\subsection{Morphisms between models}

In this section, we talk about various kind of `morphisms' between models. Similar as in mathematics, the notion of `morphism' here is used to describe maps that preserves structures. For instance, a homomorphism is a rather notion of `structure-preserving':

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{hom}\;\HOLFreeVar{f}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{f}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{valt}\;\HOLBoundVar{p}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{f}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{valt}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{u}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{w})\;(\HOLFreeVar{f}\;\HOLBoundVar{u})
\end{holmath}

Although a homomorphism preserves link between worlds in the source model, we allow the existence of extra link in the target model which has no counterpart in the source. Because of this, we cannot guarentee any world in the source is mapped to a world that satisfies exactly the same set of modal formulas under a homomorphism. As an attempt to obtain an equivlence, we strongthen the condition of being a homomorphism, and what we get after strengthening is called a strong homomorphism:

\begin{holmath}
  \HOLConst{strong_hom}\;\HOLFreeVar{f}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}.\\
\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLFreeVar{f}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{valt}\;\HOLBoundVar{p}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLFreeVar{f}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{valt}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{u}.\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;(\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{w})\;(\HOLFreeVar{f}\;\HOLBoundVar{u}))
\end{holmath}

A strong homomorphism that is a bijection on the world set is called an isomorphism, and an isomorphism will certainly preserves everthing. Just for the sake of modal equivalence, we do not really require an isomorphism, instead, a surjective strong morphism is enough:

\begin{holmath}
   \ensuremath{\HOLTokenTurnstile}\HOLConst{strong_hom}\;\HOLFreeVar{f}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLFreeVar{w}\;\HOLSymConst{=}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLConst{SURJ}\;\HOLFreeVar{f}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}
\end{holmath}

Now we have a desired modal equivalence from strong homomorphism. The problem is that the condition of being a strong homomorphism is too strong. We want a suitably weakened condition on a morphism that gives arise of such equivalence, our answer is bounded morphism:

\begin{holmath}
   \HOLConst{bounded_mor}\;\HOLFreeVar{f}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}.\\
\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLFreeVar{f}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLConst{VAR}\;\HOLBoundVar{a})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;(\HOLFreeVar{f}\;\HOLBoundVar{w})\;(\HOLConst{VAR}\;\HOLBoundVar{a}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{w})\;(\HOLFreeVar{f}\;\HOLBoundVar{v}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v\sp{\prime}}.\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{w})\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{v}.\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLBoundVar{v}\;\HOLSymConst{=}\;\HOLBoundVar{v\sp{\prime}}
\end{holmath}

%(the book says many invarient map are not strong homomorphism, but do not say every map that give arise to equivalence is bounded morphism, strongthen into a characterisation?)

The invariance result that bounded morphism gives is stated as:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{bounded_mor}\;\HOLFreeVar{f}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\phi}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;(\HOLFreeVar{f}\;\HOLFreeVar{w})\;\HOLFreeVar{\ensuremath{\phi}})
\end{holmath}


As an application, we will use it to prove the tree-like property of modal formulas. The tree-like property of modal formula says that for any formula $\phi$ satisfied on any point in any model, there exists a tree-like model such that $\phi$ is satisfied at the root of the tree. As the name indicates, a tree-like model is a model such that its underlying frame is a tree. Formally, a tree is defined as:

\begin{holmath}
   \HOLConst{tree}\;\HOLFreeVar{S}\;\HOLFreeVar{r}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLFreeVar{r}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{S}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{t}.\;\HOLBoundVar{t}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{S}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLConst{RESTRICT}\;\HOLFreeVar{S}.\HOLFieldName{rel}\;\HOLFreeVar{S}.\HOLFieldName{world})\HOLSymConst{\HOLTokenSupStar{}}\;\HOLFreeVar{r}\;\HOLBoundVar{t})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{r\sb{\mathrm{0}}}.\;\HOLBoundVar{r\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{S}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{S}.\HOLFieldName{rel}\;\HOLBoundVar{r\sb{\mathrm{0}}}\;\HOLFreeVar{r})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{t}.\;\HOLBoundVar{t}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{S}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{t}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLFreeVar{r}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenUnique{}}\HOLBoundVar{t\sb{\mathrm{0}}}.\;\HOLBoundVar{t\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{S}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{S}.\HOLFieldName{rel}\;\HOLBoundVar{t\sb{\mathrm{0}}}\;\HOLBoundVar{t}
\end{holmath}

Here \HOLinline{\HOLConst{RTC}} denotes the reflexive and transitive closure, and \HOLinline{\HOLConst{RESTRICT}} is a function that takes a relation and a set and return a relation that can only possibly hold on the set we give:

\begin{holmath}
  \HOLConst{RESTRICT}\;\HOLFreeVar{R}\;\HOLFreeVar{s}\;\HOLFreeVar{x}\;\HOLFreeVar{y}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLFreeVar{R}\;\HOLFreeVar{x}\;\HOLFreeVar{y}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{y}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}
\end{holmath}

We read `$tree \ S \ r$' as `$S$ is a tree with root $r$'. By definition, any tree like model is rooted. An induction on reflextive and transitive closure proves a tree has no loop:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{tree}\;\HOLFreeVar{s}\;\HOLFreeVar{r}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{t\sb{\mathrm{0}}}\;\HOLBoundVar{t}.\;(\HOLConst{RESTRICT}\;\HOLFreeVar{s}.\HOLFieldName{rel}\;\HOLFreeVar{s}.\HOLFieldName{world})\HOLSymConst{\HOLTokenSupPlus{}}\;\HOLBoundVar{t\sb{\mathrm{0}}}\;\HOLBoundVar{t}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{t\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLBoundVar{t}
\end{holmath}


We now prove the tree-like property of modal formulas:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\phi}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{MODEL}\;\HOLBoundVar{s}.\;\HOLConst{tree}\;\HOLBoundVar{MODEL}.\HOLFieldName{frame}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLBoundVar{MODEL}\;\HOLBoundVar{s}\;\HOLFreeVar{\ensuremath{\phi}}
\end{holmath}

Proof:
  Suppose \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{phi}} By the invariance result of rooted model, we have \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{phi}} where \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is the rooted model generated by \HOLinline{\HOLFreeVar{w}}. By the invariance result for bounded morphisms, it suffices to prove \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} is the image of some bounded morphism from some tree-like model where the root of the tree is mapped to the root of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}}. We construct such a model \HOLinline{\HOLFreeVar{M\sp{\prime\prime}}} as follows: Take the set of worlds to be the finite sequences [$w=u_0;u_1;\cdots ;u_n$] such that $n>0$ and $M.frame.rel \ u_i\ u_{i+1}$ for all $i$. Define $M''.frame.rel \ [w;u_1;\cdots ;u_n]\ [w;v_1;\cdots ;v_m]$ iff $m=n+1$, $m_i=v_i$ for $i\le n$ and $M.frame.rel \ u_n\ v_m$. The valuation is given by $[w;u_1;\cdots;u_n]\in M''.valt \ p$ iff $u_n\in M.valt \ p$. In the HOL, such a model looks like:

\begin{holmath}
  \HOLConst{bounded_preimage_rooted}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{frame}\;:=\\
\;\;\;\;\HOLTokenLeftrec{}\HOLFieldName{world}\;:=\\
\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{l}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\HOLConst{HD}\;\HOLBoundVar{l}\;\HOLSymConst{=}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{LENGTH}\;\HOLBoundVar{l}\;\HOLSymConst{\HOLTokenGt{}}\;\HOLNumLit{0}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{m}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{m}\;\HOLSymConst{\HOLTokenLt{}}\;\HOLConst{LENGTH}\;\HOLBoundVar{l}\;\HOLSymConst{\ensuremath{-}}\;\HOLNumLit{1}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{RESTRICT}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;(\HOLConst{EL}\;\HOLBoundVar{m}\;\HOLBoundVar{l})\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{EL}\;(\HOLBoundVar{m}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})\;\HOLBoundVar{l})\HOLTokenRightbrace{};\\
\;\;\;\;\;\;\HOLFieldName{rel}\;:=\\
\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{l\sb{\mathrm{1}}}\;\HOLBoundVar{l\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{LENGTH}\;\HOLBoundVar{l\sb{\mathrm{1}}}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}\;\HOLSymConst{=}\;\HOLConst{LENGTH}\;\HOLBoundVar{l\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{RESTRICT}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;(\HOLConst{LAST}\;\HOLBoundVar{l\sb{\mathrm{1}}})\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{LAST}\;\HOLBoundVar{l\sb{\mathrm{2}}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{m}.\;\HOLBoundVar{m}\;\HOLSymConst{\HOLTokenLt{}}\;\HOLConst{LENGTH}\;\HOLBoundVar{l\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{EL}\;\HOLBoundVar{m}\;\HOLBoundVar{l\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLConst{EL}\;\HOLBoundVar{m}\;\HOLBoundVar{l\sb{\mathrm{2}}})\HOLTokenRightrec{};\\
\;\;\HOLFieldName{valt}\;:=\;(\HOLTokenLambda{}\HOLBoundVar{v}\;\HOLBoundVar{n}.\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{v}\;(\HOLConst{LAST}\;\HOLBoundVar{n}))\HOLTokenRightrec{}
\end{holmath}  

It is straightforward to check the map that sends a world in \HOLinline{\HOLConst{bounded_preimage_rooted}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}} to its last member is a bounded morphism, and $[w]$ in \HOLinline{\HOLFreeVar{M\sp{\prime\prime}}} is sent to $w$ in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}}, as desired.



\subsection{Bisimulation}

The three approachs to obtain modal equivalence has a common feature: all of them leads to a relation between models such that related states satisfies exactly the same set of propositional letters, and once we are able to make a transition in one model, we can make a corresponding transition in the other. This observation leads us to the concept of bisimulation: 

\begin{holmath}
  \HOLConst{bisim}\;\HOLFreeVar{Z}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}\;\HOLBoundVar{w\sp{\prime}}.\\
\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{Z}\;\HOLBoundVar{w}\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLConst{VAR}\;\HOLBoundVar{a})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w\sp{\prime}}\;(\HOLConst{VAR}\;\HOLBoundVar{a}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{v\sp{\prime}}.\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{Z}\;\HOLBoundVar{v}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w\sp{\prime}}\;\HOLBoundVar{v\sp{\prime}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v\sp{\prime}}.\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w\sp{\prime}}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{v}.\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{Z}\;\HOLBoundVar{v}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}
\end{holmath}

If we have \HOLinline{\HOLConst{bisim}\;\HOLFreeVar{Z}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}}, it means that \HOLinline{\HOLFreeVar{Z}} is a bisimulation relation between worlds in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}}. We require any two worlds related by a bisimulation to have same atomic information and matching transition possibilities. We can see all of the three constructions we introduced before give arise to bisimulations:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{dom}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{f}\;\HOLFreeVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{bisim_world}\;(\HOLFreeVar{f}\;\HOLFreeVar{i})\;(\HOLConst{DU}\;(\HOLFreeVar{f}\HOLSymConst{,}\HOLFreeVar{dom}))\;\HOLFreeVar{w}\;(\HOLFreeVar{i}\HOLSymConst{,}\HOLFreeVar{w})
  \ensuremath{\HOLTokenTurnstile}\HOLConst{GENSUBMODEL}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{bisim_world}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w}\;\HOLBoundVar{w}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{bounded_mor_image}\;\HOLFreeVar{f}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{bisim_world}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w}\;(\HOLFreeVar{f}\;\HOLBoundVar{w})
\end{holmath}

Proof: For (i), the bisimulation relation is \HOLinline{\HOLTokenLambda{}\HOLBoundVar{a}\;\HOLBoundVar{b}.\;\HOLBoundVar{b}\;\HOLSymConst{=}\;(\HOLFreeVar{i}\HOLSymConst{,}\HOLBoundVar{a})}, which is linking a world to its corresponding copy in the disjoint union. For (ii), the relation is \HOLinline{\HOLTokenLambda{}\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{n\sb{\mathrm{2}}}.\;\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLBoundVar{n\sb{\mathrm{2}}}}. And for (iii), the relation is \HOLinline{\HOLTokenLambda{}\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{n\sb{\mathrm{2}}}.\;\HOLBoundVar{n\sb{\mathrm{2}}}\;\HOLSymConst{=}\;\HOLFreeVar{f}\;\HOLBoundVar{n\sb{\mathrm{1}}}}


The clauses on forth and back condition for a bisimulation relation provide precisely the information to push the induction on formula for proving the following invariance theorem about bisimulations through:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{bisim_world}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}
\end{holmath}

The theorem above provides alternative proofs to the invariance theorems for disjoint union, generated submodels, and bounded morphisms. Hence we can say the three former constructions is actually `the same thing'. But it is not the end of the story. A natural question to ask is : is bisimulation and modal equivalence the `same thing'? More precisely, a bisimulation will always give a modal equivalence, conversely, is that the fact that a modal equivalence always give a bisimulation?

The answer is no. Nonetheless, we can prove the converse of the theorem above with an extra condition on the models. A model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is called image finite if for any world \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}, there are only finitely many worlds in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} that is related to \HOLinline{\HOLFreeVar{w}}.

\begin{holmath}
  \HOLConst{image_finite}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{x}.\\
\;\;\;\;\;\;\HOLBoundVar{x}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLConst{FINITE}\;\HOLTokenLeftbrace{}\HOLBoundVar{y}\;\HOLTokenBar{}\;\HOLBoundVar{y}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{x}\;\HOLBoundVar{y}\HOLTokenRightbrace{}
\end{holmath}

Our main theorem is called Hennessy-Milner theorem, it says that for image finite models, modal equivalence and bisimulation coincides:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{image_finite}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{image_finite}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{bisim_world}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}})
\end{holmath}

Proof:
The implication from right to left is just the invariance theorem for bisimulation. We prove the implication from left to right. Given \HOLinline{\HOLFreeVar{w}} and \HOLinline{\HOLFreeVar{w\sp{\prime}}} are worlds in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} which are modal equivalent, we prove the relation \HOLinline{\HOLTokenLambda{}\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{n\sb{\mathrm{2}}}.\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\phi}}.\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{\ensuremath{\phi}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{n\sb{\mathrm{2}}}\;\HOLBoundVar{\ensuremath{\phi}}} gives a bisimulation. The first clause is immediate to check. For the second one, assume \HOLinline{\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{n\sb{\mathrm{1}}}\;\HOLFreeVar{n\sb{\mathrm{2}}}} and \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{n\sb{\mathrm{1}}}\;\HOLFreeVar{n\sb{\mathrm{1}}\sp{\prime}}} for some \HOLinline{\HOLFreeVar{n\sb{\mathrm{1}}\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}, we prove the existence of the world \HOLinline{\HOLFreeVar{n\sb{\mathrm{2}}\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}} such that \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{n\sb{\mathrm{2}}}\;\HOLFreeVar{n\sb{\mathrm{2}}\sp{\prime}}} and \HOLinline{\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{n\sb{\mathrm{1}}\sp{\prime}}\;\HOLFreeVar{n\sb{\mathrm{2}}\sp{\prime}}}. Suppose such a \HOLinline{\HOLFreeVar{n\sb{\mathrm{2}}\sp{\prime}}} does not exist, we derive a contradiction. Consider the set $S :=$\HOLinline{\HOLFreeVar{u\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{n\sb{\mathrm{2}}}\;\HOLFreeVar{u\sp{\prime}}}%how to do set!!!
, the first claim is that this set is finite and nonempty. Finiteness comes from the fact that \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} is image finite, and if the set is empty, then \HOLinline{\HOLSymConst{\ensuremath{\Box}}\;\HOLSymConst{\ensuremath{\bot}}} will be a formula which holds for \HOLinline{\HOLFreeVar{n\sb{\mathrm{2}}}} but not for \HOLinline{\HOLFreeVar{n\sb{\mathrm{1}}}}, contradicts the modal equivalence between \HOLinline{\HOLFreeVar{n\sb{\mathrm{1}}}} and \HOLinline{\HOLFreeVar{n\sb{\mathrm{2}}}}. By assumption, for each world in $S$, there is a formula \HOLinline{\HOLFreeVar{phi}} such that \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{n\sb{\mathrm{1}}\sp{\prime}}\;\HOLFreeVar{phi}} but \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{n\sb{\mathrm{2}}\sp{\prime}}\;\HOLFreeVar{phi}}. As the set $S$ is finite, the set of such \HOLinline{\HOLFreeVar{phi}}s is finite. Then we can take the conjunction of such \HOLinline{\HOLFreeVar{phi}}s to obtain a formula \HOLinline{\HOLFreeVar{psi}}. Then we will have \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{n\sb{\mathrm{1}}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{psi})} but \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{n\sb{\mathrm{2}}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{psi})}.

The trick is what to do to capture the big conjunction. Certainly we can define a big conjunction inductively as a function that takes a finite set and give us the formula that conjuncts them together, but here is a much more direct approach such that allows us to directly obtain the \HOLinline{\HOLFreeVar{psi}}. We can prove:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v\sp{\prime}}.\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{phi}.\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{v\sp{\prime}}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{psi}.\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;\HOLBoundVar{psi}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v\sp{\prime}}.\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{v\sp{\prime}}\;\HOLBoundVar{psi}
\end{holmath}

Using this lemma, we obtain the \HOLinline{\HOLFreeVar{psi}} we want by plugging in $S$ to be the $s$. 

\section{Finite model property}

In this chapter, we prove the finite model property of our modal language, which says if a modal formula is satisfied on an arbitary mode, then it can be satisfied on a finite model, where finite model means the finitness of the set of worlds. We will discuss two methods for building finite models for satisfiable modal formulas, namely via filteration and selection.

\subsection{Finite model property via filteration}

One way to get a finite model is by taking the quotient of the world set. The quotient model we will get is called filtration of a model. The equivalence relation that we will use for taking the quotient is defined using the concept of `closed under subformulas'. Firstly, subformulas is a function that takes a formula and gives a set of the subformulas of this formula, defined by:

\begin{holmath}
  \HOLConst{subforms}\;(\HOLConst{VAR}\;\HOLFreeVar{a})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLTokenLeftbrace{}\HOLConst{VAR}\;\HOLFreeVar{a}\HOLTokenRightbrace{}\\
\HOLConst{subforms}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLTokenLeftbrace{}\HOLSymConst{\ensuremath{\bot}}\HOLTokenRightbrace{}\\
\HOLConst{subforms}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f}\;\HOLConst{INSERT}\;\HOLConst{subforms}\;\HOLFreeVar{f}\\
\HOLConst{subforms}\;(\HOLConst{DISJ}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}})\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{DISJ}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;\HOLConst{INSERT}\;\HOLConst{subforms}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLConst{subforms}\;\HOLFreeVar{f\sb{\mathrm{2}}}\\
\HOLConst{subforms}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{f})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{f}\;\HOLConst{INSERT}\;\HOLConst{subforms}\;\HOLFreeVar{f}
\end{holmath}

The definition says a subformula of a formula is a part of a formula which is itself a formula. Some properties of subformulas can be proved immediately, for instance, we have any formula is a subformula of itself. Also subformulas are transitive, and the set of subformulas for any formula is finite. 

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLFreeVar{phi}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLFreeVar{psi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLFreeVar{psi}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;(\HOLConst{subforms}\;\HOLFreeVar{phi})
\end{holmath}

We say a set \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} is closed under formula if for any formula \HOLinline{\HOLFreeVar{phi}} in the set, any subformula of \HOLinline{\HOLFreeVar{phi}} is also in \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}}.

\begin{holmath}
  \HOLConst{CUS}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}\;\HOLBoundVar{f\sp{\prime}}.\\
\;\;\;\;\;\;(\HOLConst{DISJ}\;\HOLBoundVar{f}\;\HOLBoundVar{f\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{f\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;(\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}})\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}})
\end{holmath}

We can easily check the set of subformulas of any formulas is closed under subformulas:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{CUS}\;(\HOLConst{subforms}\;\HOLFreeVar{phi})
\end{holmath}

And for a model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, the equivalence relation we will use to filtrate its world set is:

\begin{holmath}
  \HOLConst{REL_CUS}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;(\HOLTokenLambda{}\HOLBoundVar{w}\;\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{v}\;\HOLBoundVar{phi}))
\end{holmath}


Under this equivalence relation, for any world \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}, the equivalence class it belongs to looks like:

\begin{holmath}
  \HOLConst{EC_CUS}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLTokenLeftbrace{}\HOLBoundVar{v}\;\HOLTokenBar{}\;\HOLConst{REL_CUS}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLBoundVar{v}\HOLTokenRightbrace{}
\end{holmath}

We can take these equivalence class to be the set of worlds for the filtrated model, but then the model we get will have different type from the original model. To avoid changing the type, we define \HOLinline{\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}} to be the representative from the equivalence class where \HOLinline{\HOLFreeVar{w}} lives in, and we will use \HOLinline{\HOLConst{EC_REP_SET}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}} to be the set of worlds for the filtrated model.

\begin{holmath}
  \HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{CHOICE}\;(\HOLConst{EC_CUS}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w})
  \HOLConst{EC_REP_SET}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{n}\;\HOLTokenBar{}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{w}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\HOLTokenRightbrace{}
\end{holmath}

The definition of filtration of a model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} via a subformula-closed set is given by a relation, we read as \HOLinline{\HOLConst{filtration}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\Sigma}}} $FLT$ as `$FLT$ is a filteration of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} under \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}}.

\begin{holmath}
  \HOLConst{filtration}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{FLT}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{CUS}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{FLT}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{=}\;\HOLConst{EC_REP_SET}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}\;\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\HOLFreeVar{FLT}.\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w})\;(\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{v}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}\;\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\HOLFreeVar{FLT}.\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w})\;(\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{v})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}\;\HOLBoundVar{psi}.\\
\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{phi}\;\HOLSymConst{=}\;\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{psi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{v}\;\HOLBoundVar{psi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p}\;\HOLBoundVar{s}.\\
\;\;\;\;\;\;\HOLFreeVar{FLT}.\HOLFieldName{valt}\;\HOLBoundVar{p}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{w}.\;\HOLBoundVar{s}\;\HOLSymConst{=}\;\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLConst{VAR}\;\HOLBoundVar{p})
\end{holmath}

The definition above forces filtration to only make sense for subformula closed sets. For any model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and set \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} which is closed under subformulas, we can find some model such that it is a filtration of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} under \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}}. One construction of filtration is given by:

\begin{holmath}
  \HOLConst{FLT}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{frame}\;:=\\
\;\;\;\;\HOLTokenLeftrec{}\HOLFieldName{world}\;:=\;\HOLConst{EC_REP_SET}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}};\\
\;\;\;\;\;\;\HOLFieldName{rel}\;:=\\
\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{n\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{n\sb{\mathrm{2}}}\;\HOLSymConst{=}\;\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{w\sp{\prime}}\;\HOLBoundVar{v\sp{\prime}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{EC_CUS}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{EC_CUS}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w\sp{\prime}}\;\HOLBoundVar{v\sp{\prime}})\HOLTokenRightrec{};\\
\;\;\HOLFieldName{valt}\;:=\;(\HOLTokenLambda{}\HOLBoundVar{p}\;\HOLBoundVar{s}.\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{w}.\;\HOLBoundVar{s}\;\HOLSymConst{=}\;\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLConst{VAR}\;\HOLBoundVar{p}))\HOLTokenRightrec{}
\end{holmath}

In fact, it is not the fact that we always have a unique filtration of a model under a subformula closed set, but we will just use the one defined above. It is routine to check the above definition does give a filtration:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{CUS}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{filtration}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;(\HOLConst{FLT}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\Sigma}})
\end{holmath}

We are interested in two properties of filtration of models that directly give the proof of finite model property. Firstly, filtrating a model using a finite set gives a finite model:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{filtration}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{FLT}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{CARD}\;\HOLFreeVar{FLT}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLNumLit{2}\;\HOLSymConst{\HOLTokenExp{}}\;\HOLConst{CARD}\;\HOLFreeVar{\ensuremath{\Sigma}}
\end{holmath}

Proof: As \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} is finite, it suffices to give an injection from the world set of $FLT$ to \HOLinline{\HOLConst{POW}\;\HOLFreeVar{\ensuremath{\Sigma}}}. Such an injection is given by sending a world $w$ to the set of formulas in \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} that is satisfies at $w$. % unable to use set...


Secondly, we need the satisfication of modal formula to be preserved under filtration, in the following sense:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{filtration}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{FLT}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{FLT}\;(\HOLConst{EC_REP}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w})\;\HOLFreeVar{phi})
\end{holmath}


Putting the last two theorems together and we get the finite model property via filtration:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w\sp{\prime}}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w\sp{\prime}}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{FINITE}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}
\end{holmath}

\subsection{Finite model property via selection}

Another method to build finite models for an arbitary model is by selection. The intuition of this method is that only finitely many diamonds can occur in a modal formula, so any formula can only capture the information of finitely depth. To make the notion of `depth' precise, we define the degree of a modal formula, which count the diamonds appear in a model formula and hence measure how much of the model can a modal formula see from the current state:

\begin{holmath}
  \HOLConst{DEG}\;(\HOLConst{VAR}\;\HOLFreeVar{p})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLNumLit{0}\\
\HOLConst{DEG}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLNumLit{0}\\
\HOLConst{DEG}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{\ensuremath{\phi}})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{DEG}\;\HOLFreeVar{\ensuremath{\phi}}\\
\HOLConst{DEG}\;(\HOLConst{DISJ}\;\HOLFreeVar{\ensuremath{\phi\sb{1}}}\;\HOLFreeVar{\ensuremath{\phi\sb{2}}})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{MAX}\;(\HOLConst{DEG}\;\HOLFreeVar{\ensuremath{\phi\sb{1}}})\;(\HOLConst{DEG}\;\HOLFreeVar{\ensuremath{\phi\sb{2}}})\\
\HOLConst{DEG}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{\ensuremath{\phi}})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{DEG}\;\HOLFreeVar{\ensuremath{\phi}}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}
\end{holmath}

A modal formula of degree zero is exactly a propositional formula:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DEG}\;\HOLFreeVar{f}\;\HOLSymConst{=}\;\HOLNumLit{0}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{propform}\;\HOLFreeVar{f}
\end{holmath}

The crucial fact that we will use about the degree of formulas is the following lemma:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{INFINITE}\;\ensuremath{\cal{U}}(:\ensuremath{\beta})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{FINITE}\\
\;\;\;\;\;\;\;\;\;\;\;(\HOLTokenLeftbrace{}\HOLBoundVar{f}\;\HOLTokenBar{}\;\HOLConst{DEG}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{VAR}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\HOLTokenRightbrace{}\HOLSymConst{//E}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{\ensuremath{\mu}})
\end{holmath}

The proof of this lemma is by induction on the degree $n$. We prove it in the following interlude:

\subsection{Interlude I: Finiteness of non-equivalent modal formulas in each degree}

\subsubsection{Base case}
For the base case, we need to prove if we only use propositional letters in $s$ where $s$ is a finite set, then up to equivalence, we can only onbtain finitely many propositional formulas. To prove this, it suffices to find out an injection from the set of equivalence class of propositional formulas that only uses propositional letters in $s$ to a finite set. We will prove the function that sends an equivalence class of formulas to its image under the function $\lambda f. \{\sigma \mid peval\ \sigma\ f\} \cap (POW \ s)$, which sends a formula $f$ to the set $\{\sigma \mid peval\ \sigma\ f\} \cap (POW \ s)$ of assignments of truth value on propositional letters in $s$ that makes $f$ holds, is an injection to the finite set \HOLinline{\HOLConst{POW}\;(\HOLConst{POW}\;(\HOLConst{POW}\;\HOLFreeVar{s}))}. We can see the function we define has correct codomain: A formula $f$ is sent to a set of subsets of $s$, which is an element of \HOLinline{\HOLConst{POW}\;(\HOLConst{POW}\;\HOLFreeVar{s})}, so a equivalence class has image as a set of elements in \HOLinline{\HOLConst{POW}\;(\HOLConst{POW}\;\HOLFreeVar{s})}, which lies in \HOLinline{\HOLConst{POW}\;(\HOLConst{POW}\;(\HOLConst{POW}\;\HOLFreeVar{s}))}.

Let us firstly investigate what the function $\lambda f. \{\sigma \mid peval\ \sigma\ f\} \cap (POW \ s)$ does. We claim the image of each equivalence class of this function is a singleton:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenIn{}}\\
\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{f}\;\HOLTokenBar{}\;\HOLConst{propform}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{VAR}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\HOLTokenRightbrace{}\HOLSymConst{//E}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLFreeVar{\ensuremath{\phi}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{IMAGE}\;(\HOLTokenLambda{}\HOLBoundVar{f}.\;\HOLTokenLeftbrace{}\HOLBoundVar{\ensuremath{\sigma}}\;\HOLTokenBar{}\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{f}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLConst{POW}\;\HOLFreeVar{s})\;\HOLFreeVar{x}\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLTokenLeftbrace{}\HOLBoundVar{\ensuremath{\sigma}}\;\HOLTokenBar{}\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{\ensuremath{\phi}}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLConst{POW}\;\HOLFreeVar{s}\HOLTokenRightbrace{}
\end{holmath}

Indeed, if two $f1$ and $f2$ formulas are equivalent, then for any assignment of truth value of propositional symbols, it makes $f1$ true iff it makes $f2$ true:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{propform}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{propform}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{f\sb{\mathrm{2}}})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}.\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{f\sb{\mathrm{2}}}
\end{holmath}

It is because if we have a \HOLinline{\HOLConst{peval}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{peval}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{f\sb{\mathrm{2}}}}, then we can construct a model with only one world $w$, no relation, and define the valuation at $w$ for propositional symbols to be $\sigma$. Then by \texttt{peval_satis}, we get \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f\sb{\mathrm{2}}}}, a contradiction. As a consequence, we have:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{propform}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{propform}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{f}\;\HOLBoundVar{s}.\;\HOLConst{peval}\;\HOLBoundVar{s}\;\HOLBoundVar{f})\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{=}\;(\HOLTokenLambda{}\HOLBoundVar{f}\;\HOLBoundVar{s}.\;\HOLConst{peval}\;\HOLBoundVar{s}\;\HOLBoundVar{f})\;\HOLFreeVar{f\sb{\mathrm{2}}}
\end{holmath}

which says if two formulas are equivalent, then the sets of valuations that makes them hold are identical. As a consequence, these two sets will still be equal after taking inter section with $POW\ s$. This proves \texttt{IMAGE_peval_singlton_strengthen}.

Recall we proved the condition for a propositional formula to hold as the lemma \texttt{peval_satis_strengthen}, it gives arise to this useful lemma:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{propform}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{propform}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{VAR}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{VAR}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}.\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{POW}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{f\sb{\mathrm{2}}}))\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{f\sb{\mathrm{2}}}
\end{holmath}

Proof: Suppose \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f\sb{\mathrm{1}}}} for some model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, then by \texttt{peval_satis_strengthen}, we have \HOLinline{\HOLConst{peval}\;((\HOLTokenLambda{}\HOLBoundVar{a}.\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{a})\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{s})\;\HOLFreeVar{f\sb{\mathrm{1}}}}. As \HOLinline{(\HOLTokenLambda{}\HOLBoundVar{a}.\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{a})\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{s}} gives a subset of $s$, we conclude \HOLinline{\HOLConst{peval}\;((\HOLTokenLambda{}\HOLBoundVar{a}.\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{a})\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{s})\;\HOLFreeVar{f\sb{\mathrm{2}}}} by assumption, and then \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f\sb{\mathrm{2}}}} by \texttt{peval_satis_strengthen} again. The other direction is the same.


We can now prove the injection:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{INJ}\;(\HOLTokenLambda{}\HOLBoundVar{eqc}.\;\HOLConst{IMAGE}\;(\HOLTokenLambda{}\HOLBoundVar{f}.\;\HOLTokenLeftbrace{}\HOLBoundVar{s}\;\HOLTokenBar{}\;\HOLConst{peval}\;\HOLBoundVar{s}\;\HOLBoundVar{f}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLConst{POW}\;\HOLFreeVar{s})\;\HOLBoundVar{eqc})\\
\;\;\;\;\;\;\;(\HOLTokenLeftbrace{}\HOLBoundVar{f}\;\HOLTokenBar{}\;\HOLConst{propform}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{VAR}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\HOLTokenRightbrace{}\HOLSymConst{//E}\;\HOLFreeVar{\ensuremath{\mu}})\\
\;\;\;\;\;\;\;(\HOLConst{POW}\;(\HOLConst{POW}\;(\HOLConst{POW}\;\HOLFreeVar{s})))
\end{holmath}

Proof: If two equivalence classes represented by $x$ and $x'$ respectively has identical image under the function $\lambda f. \{s \mid peval\ s f\} \cap POW \ s$, then by \texttt{IMAGE_peval_singlton_strengthen}, it gives $ \{\{\sigma \mid peval\ \sigma x\} \cap POW\ s\}$. This means \HOLinline{\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}.\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{POW}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{peval}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{x\sp{\prime}}}, which means $x$ and $x'$ are equivalent by \texttt{equiv0_peval_strengthen}.



\subsubsection{Step case}

The key observation for proving the step case is that any formulas which only uses propositional letters in a fixed finite set $ss$ and of degree no more than $n+1$ is obtained by boolean combination on the set $s$ formed by formulas of form \HOLinline{\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{phi}} which also only uses propositional letters in $ss$ where \HOLinline{\HOLConst{DEG}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}} and propositional letters in $ss$. Saying a formula $f$ is a boolean combination of a set $s$ of formulas is to say $f$ is either itself an element in $s$, or can be obtained by combining elements in $s$ using the connectives $\lnot$ and $\lor$. We define boolean combination as an inductive relation, where \HOLinline{\HOLConst{IBC}\;\HOLFreeVar{f}\;\HOLFreeVar{s}} reads `$f$ is a boolean combination of elements in the set $s$':

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLBoundVar{s}.\;\HOLConst{IBC}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{IBC}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{IBC}\;(\HOLConst{DISJ}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}})\;\HOLBoundVar{s})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{s}.\;\HOLConst{IBC}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLBoundVar{s})\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}\;\HOLBoundVar{s}.\;\HOLConst{IBC}\;\HOLBoundVar{f}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{IBC}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{f})\;\HOLBoundVar{s})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}\;\HOLBoundVar{s}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{IBC}\;\HOLBoundVar{f}\;\HOLBoundVar{s}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLBoundVar{s}.\;\HOLFreeVar{IBC\sp{\prime}}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{IBC\sp{\prime}}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{IBC\sp{\prime}}\;(\HOLConst{DISJ}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}})\;\HOLBoundVar{s})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{s}.\;\HOLFreeVar{IBC\sp{\prime}}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLBoundVar{s})\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}\;\HOLBoundVar{s}.\;\HOLFreeVar{IBC\sp{\prime}}\;\HOLBoundVar{f}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{IBC\sp{\prime}}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{f})\;\HOLBoundVar{s})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}\;\HOLBoundVar{s}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{IBC\sp{\prime}}\;\HOLBoundVar{f}\;\HOLBoundVar{s})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a\sb{\mathrm{0}}}\;\HOLBoundVar{a\sb{\mathrm{1}}}.\;\HOLConst{IBC}\;\HOLBoundVar{a\sb{\mathrm{0}}}\;\HOLBoundVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{IBC\sp{\prime}}\;\HOLBoundVar{a\sb{\mathrm{0}}}\;\HOLBoundVar{a\sb{\mathrm{1}}}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{IBC}\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLFreeVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}.\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLSymConst{=}\;\HOLConst{DISJ}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{IBC}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{IBC}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLFreeVar{a\sb{\mathrm{1}}})\;\HOLSymConst{\HOLTokenDisj{}}\\
\;\;\;\;\;\;\;\;\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLSymConst{=}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{\HOLTokenDisj{}}\;(\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{IBC}\;\HOLBoundVar{f}\;\HOLFreeVar{a\sb{\mathrm{1}}})\;\HOLSymConst{\HOLTokenDisj{}}\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{a\sb{\mathrm{1}}}
\end{holmath}

We can prove our claim in the last paragraph with induction:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DEG}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{VAR}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s})\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\HOLConst{IBC}\;\HOLFreeVar{x}\\
\;\;\;\;\;\;\;\;\;\;\;(\HOLTokenLeftbrace{}\HOLConst{VAR}\;\HOLBoundVar{v}\;\HOLTokenBar{}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenUnion{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{psi}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{DEG}\;\HOLBoundVar{psi}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{VAR}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLBoundVar{psi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\HOLTokenRightbrace{})
\end{holmath}


Observe a formula which is a boolean combinations on an empty set is either equivalent to $\bot$ or $\top$:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{IBC}\;\HOLFreeVar{f}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{s}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f}\;\HOLConst{TRUE}\;\HOLSymConst{\HOLTokenDisj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f}\;\HOLSymConst{\ensuremath{\bot}}
\end{holmath}

so we are interested in boolean combination of non-empty sets along our proof, and leave the empty case to be treat separately at the very end. Our aim is to prove the set of boolean combinations on a set which contains only finitely many non-equivalent formulas only contain finitely many non-equivalent formulas:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{FINITE}\;(\HOLFreeVar{fs}\HOLSymConst{//E}\;\HOLFreeVar{\ensuremath{\mu}})\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{FINITE}\;(\HOLTokenLeftbrace{}\HOLBoundVar{f}\;\HOLTokenBar{}\;\HOLConst{IBC}\;\HOLBoundVar{f}\;\HOLFreeVar{fs}\HOLTokenRightbrace{}\HOLSymConst{//E}\;\HOLFreeVar{\ensuremath{\mu}})
\end{holmath}

Note that it suffices to prove the set of formulas obtained by boolean combination on a finite set is finite up to equivalence. Since then as $fs$ have only finitely many non-equivalent formulas, the set \HOLinline{\HOLConst{IMAGE}\;\HOLConst{CHOICE}\;(\HOLFreeVar{fs}\HOLSymConst{//E}\;\HOLFreeVar{\ensuremath{\mu}})} of representatives of the equivalence classes is finite. There is a surjection $\lambda s. \{y \mid IBC\ y\ fs \land !f. f \in s \implies equiv0\ \mu\ y\ f\}$ from 
$\{f \mid IBC\ f\ (IMAGE\ CHOICE\ (fs//E\ \mu))\}//E\ \mu$ to $\{f \mid IBC\ f\ fs\}//E\ \mu$ is a surjection, showing the codomain is finite. 

The strategy we used to prove this is to prove that any formula obtained by a boolean combination on a set is equivalent to a formula in disjunction normal form on the same set. The disjunction normal form is defined by:

\begin{holmath}
  \HOLConst{DNF_OF}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{DISJ_OF}\;\HOLFreeVar{f}\;\HOLTokenLeftbrace{}\HOLBoundVar{c}\;\HOLTokenBar{}\;\HOLConst{CONJ_OF}\;\HOLBoundVar{c}\;\HOLFreeVar{fs}\HOLTokenRightbrace{}
\end{holmath}

where \HOLinline{\HOLConst{CONJ_OF}} is defined by:
\[
\begin{array}{c}
  \infer{\HOLinline{\HOLConst{CONJ_OF}\;\HOLFreeVar{c}\;\HOLTokenLeftbrace{}\HOLFreeVar{c\sb{\mathrm{0}}}\HOLTokenRightbrace{}}}{\HOLinline{\HOLFreeVar{c}\;\HOLSymConst{=}\;\HOLFreeVar{c\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenDisj{}}\;\HOLFreeVar{c}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{c\sb{\mathrm{0}}}}}\\[3mm]
  \infer{\HOLinline{\HOLConst{CONJ_OF}\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}})\;\HOLFreeVar{fs}}}{\HOLinline{\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLFreeVar{f\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenDisj{}}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{0}}}}&\HOLinline{\HOLFreeVar{f\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{fs}}&\HOLinline{\HOLConst{CONJ_OF}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;(\HOLFreeVar{fs}\;\HOLConst{DELETE}\;\HOLFreeVar{f\sb{\mathrm{0}}})}}\\
\end{array}
\]

and for a formula $f$, we say \HOLinline{\HOLConst{DISJ_OF}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}} when $f$ is either the `$\bot$' or a formula such that \HOLinline{\HOLConst{DISJ_OF0}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}}

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}\;\HOLBoundVar{fs}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{f}\;\HOLBoundVar{fs})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLBoundVar{fs}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;(\HOLBoundVar{fs}\;\HOLConst{DELETE}\;\HOLBoundVar{f\sb{\mathrm{1}}})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{DISJ_OF0}\;(\HOLConst{DISJ}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}})\;\HOLBoundVar{fs}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}\;\HOLBoundVar{fs}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{DISJ\HOLTokenUnderscore{}OF\sb{\mathrm{0}}\sp{\prime}}\;\HOLBoundVar{f}\;\HOLBoundVar{fs})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLBoundVar{fs}.\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{DISJ\HOLTokenUnderscore{}OF\sb{\mathrm{0}}\sp{\prime}}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;(\HOLBoundVar{fs}\;\HOLConst{DELETE}\;\HOLBoundVar{f\sb{\mathrm{1}}})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{DISJ\HOLTokenUnderscore{}OF\sb{\mathrm{0}}\sp{\prime}}\;(\HOLConst{DISJ}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}})\;\HOLBoundVar{fs})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a\sb{\mathrm{0}}}\;\HOLBoundVar{a\sb{\mathrm{1}}}.\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{a\sb{\mathrm{0}}}\;\HOLBoundVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{DISJ\HOLTokenUnderscore{}OF\sb{\mathrm{0}}\sp{\prime}}\;\HOLBoundVar{a\sb{\mathrm{0}}}\;\HOLBoundVar{a\sb{\mathrm{1}}}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DISJ_OF0}\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLFreeVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenDisj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLSymConst{=}\;\HOLConst{DISJ}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;(\HOLFreeVar{a\sb{\mathrm{1}}}\;\HOLConst{DELETE}\;\HOLBoundVar{f\sb{\mathrm{1}}})
  \HOLConst{DISJ_OF}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLFreeVar{f}\;\HOLSymConst{=}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{\HOLTokenDisj{}}\;\HOLConst{DISJ_OF0}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}
\end{holmath}

As an example, the four \HOLinline{\HOLConst{CONJ_OF}} formulas on the set $\{f1,f2\}$ are \HOLinline{\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}}}, \HOLinline{\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLFreeVar{f\sb{\mathrm{2}}}} \HOLinline{\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{2}}})} and \HOLinline{\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{2}}})}. For another example, consider the set $fs:=\{f1,f2,f3\}$ of three formulas, we can say \HOLinline{\HOLConst{CONJ_OF}\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{3}}}\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}}))\;\HOLFreeVar{fs}}, \HOLinline{\HOLConst{CONJ_OF}\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;(\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLFreeVar{f\sb{\mathrm{3}}}))\;\HOLFreeVar{fs}}, \HOLinline{\HOLConst{CONJ_OF}\;(\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{3}}})\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;\HOLFreeVar{f\sb{\mathrm{1}}}))\;\HOLFreeVar{fs}} and so on. But it is not the fact that \HOLinline{\HOLConst{CONJ_OF}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{fs}}, since from the definition, any element of fs or its negation must appear exactly once in a \HOLinline{\HOLConst{CONJ_OF}} formula on $fs$. Let $CO:=\{f\mid$\HOLinline{\HOLConst{CONJ_OF}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}}$\}$, then we can say \HOLinline{\HOLConst{DISJ_OF}\\
\;\;(\HOLConst{DISJ}\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{3}}}\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}}))\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;(\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLFreeVar{f\sb{\mathrm{3}}})))\;\HOLFreeVar{CO}}, \HOLinline{\HOLConst{DISJ_OF}\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;(\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLFreeVar{f\sb{\mathrm{3}}}))\;\HOLFreeVar{CO}} and so on, so both these two formulas are disjunction normal form on $fs$, but we cannot say \HOLinline{\HOLConst{DISJ_OF}\\
\;\;(\HOLConst{DISJ}\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;(\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLFreeVar{f\sb{\mathrm{3}}}))\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;(\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLFreeVar{f\sb{\mathrm{3}}})))\;\HOLFreeVar{CO}} or \HOLinline{\HOLConst{DISJ_OF}\\
\;\;(\HOLConst{DISJ}\;(\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;(\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLFreeVar{f\sb{\mathrm{3}}}))\;(\HOLSymConst{\HOLTokenNeg{}}\HOLConst{AND}\;\HOLFreeVar{f\sb{\mathrm{2}}}\;(\HOLConst{AND}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLFreeVar{f\sb{\mathrm{3}}})))\;\HOLFreeVar{CO}}, since any formula in $CO$ or its negation is only allowed to appear in a \HOLinline{\HOLConst{DISJ_OF}} formula on $CO$ for at most once, so these two are not in disjunction normal form.

If we start with a finite set, by induction on finiteness using \texttt{FINITE_COMPLETE_INDUCTION} , we conclude the set of \HOLinline{\HOLConst{CONJ_OF}} formulas and \HOLinline{\HOLConst{DISJ_OF0}}, hence the \HOLinline{\HOLConst{DNF_OF}} formulas on this set is finite:
\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{FINITE}\;\HOLTokenLeftbrace{}\HOLBoundVar{f}\;\HOLTokenBar{}\;\HOLConst{CONJ_OF}\;\HOLBoundVar{f}\;\HOLFreeVar{s}\HOLTokenRightbrace{}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{FINITE}\;\HOLTokenLeftbrace{}\HOLBoundVar{f}\;\HOLTokenBar{}\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{f}\;\HOLFreeVar{s}\HOLTokenRightbrace{}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{FINITE}\;\HOLTokenLeftbrace{}\HOLBoundVar{f}\;\HOLTokenBar{}\;\HOLConst{DNF_OF}\;\HOLBoundVar{f}\;\HOLFreeVar{fs}\HOLTokenRightbrace{}
\end{holmath}

Once we prove:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{IBC}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{FINITE}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{p}.\;\HOLConst{DNF_OF}\;\HOLBoundVar{p}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f}\;\HOLBoundVar{p}
\end{holmath}

we get \texttt{FINITE_FINITE_IBC}, which leads to a proof of the step case of \texttt{prop_2_29_strengthen} goes as follows: 
Suppose $\{f | DEG\ f \le n \land \forall a. VAR \ a \in subforms\ f \implies a \in s\}//E \ \mu$ is finite and let $A = (\{VAR\ v | v \in s\} \cup \{\Diamond psi | DEG \ psi \le n \land \forall a. (VAR\ a) \in subforms\ psi \implies a \in s\})$. By \texttt{DEG_IBC_strengthen}, we have $B:=\{f | DEG\ f \le n+1 \land \forall a. VAR \ a \in subforms\ f \implies a \in s\}=\{phi | IBC\ phi \ A\}$, we prove $B$ is finite up to equivalence. If $A=\emptyset$, then by \texttt{IBC_EMPTY_lemma}, $B$ contains only two non-equivaelent formulas $\bot$ and $\top$. Otherwise, by \texttt{FINITE_FINITE_IBC}, it suffices to prove $A$ is finite up to equivalence. Under the assumption \HOLinline{\HOLConst{INFINITE}\;\ensuremath{\cal{U}}(:\ensuremath{\beta})}, \HOLinline{\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{f})\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{g})} iff \HOLinline{\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f}\;\HOLFreeVar{g}}, so the inductive hypothesis together  with the assumption \HOLinline{\HOLConst{FINITE}\;\HOLFreeVar{s}} gives the finiteness of $A$.

Therefore, it remains to give a proof of \texttt{IBC_DNF_EXISTS}. The proof is by rule induction on \HOLinline{\HOLConst{IBC}}, the things to prove are:

Base case:
\begin{itemize}
  \item The falsity $\bot$ is equivalent to a disjunction normal form on $fs$.
  \item For any element $f\in fs$, it is equivalent to a disjunction normal form on $fs$.
\end{itemize}

Step case:

\begin{itemize}
  \item Under the assumption that $fs$ is finite and non-empty, if $f1,f2$ are boolean combination of the set $fs$ which are equivalent to $p1,p2$ of disjunction normal form respectively, then \HOLinline{\HOLConst{DISJ}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{f\sb{\mathrm{2}}}} is equivalent to a formula in disjunction normal form.
  \item With the same assumption on $fs$, if $f$ is a boolean combination of $fs$ and equivalent to $p$ in disjunction normal form, then \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f}} is equivalent to a formula in disjunction normal form.
\end{itemize}


The first item of base case is trivial since $\bot$ itself is in disjunction normal form, we begin by proving the second item of the base case.

\subsubsection{Case for $f\in fs$}

We aim to prove:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{p}.\;\HOLConst{DNF_OF}\;\HOLBoundVar{p}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLBoundVar{f}\;\HOLBoundVar{p}
\end{holmath}

Let us consider what does the \HOLinline{\HOLConst{DNF_OF}} formula $p$ on $fs$ that is equivalent to and element of $fs$ look like: We require $p$ to be satisfied if and only if $f$ is satisfied. As $p$ is of disjunction normal form, $p$ is satisfied once some of its disjuncts is satisfied. Hence we require the satisfication of each disjuncts of $p$ to imply the satisfication of $f$, that is, $f$ is a conjunct of each disjunct of $p$. So up to rearrangement, $p$ is a disjunction of conjunctions $f\land f_1\cdots f_n$ where each formula in $fs/\{f\}$ or its negation appears exactly once in these $f_i$'s. Such a formula is equivalent to $f\land g$, where $g$ is the disjunction of the formulas obtained by taking $f$ out of each conjunct of $p$. And $f\land g$ is equivalent to $f$ if and only if $g$ is equivalent to $\top$. Hence, $g$ must be the disjunction of all the \HOLinline{\HOLConst{CONJ_OF}} formulas on $fs/\{f\}$. By conclusion, a disjunction normal form we need can be taken as the disjunction of conjunctions starting with $f$, with its tail ranging over all possible combination of negated and unnegated formulas in $fs/\{f\}$. Use the set $\{f_1,f_2,f_3\}$ as example again, an example of disjunction normal form equivalent to $f_1$ is the formula $(f_1\land f_2\land f_3)\lor (f_1\land\lnot f_2\land f_3)\lor (f_1\land f_2\land \lnot f_3)\lor (f_1\land \lnot f_2\land\lnot f_3)$, note that such a formula is equivalent to $f_1\land ((f_2\land f_3)\lor (\lnot f_2\land f_3)\lor (f_2\land \lnot f_3)\lor (\lnot n_2\land \lnot f_3))$, where $(f_2\land f_3)\lor (\lnot f_2\land f_3)\lor (f_2\land \lnot f_3)\lor (\lnot f_2\land \lnot f_3)$ is equivalent to \HOLinline{\HOLConst{TRUE}}.

To formalise the idea above, we want to be able to building disjunction normal form piece by piece. We use the following definitions as our tool:

\begin{holmath}
  \HOLConst{negf}\;(\HOLFreeVar{f}\HOLSymConst{,}\HOLConst{T})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLFreeVar{f}\\
\HOLConst{negf}\;(\HOLFreeVar{f}\HOLSymConst{,}\HOLConst{F})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f}
  \HOLConst{lit_list_to_form}\;[]\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{TRUE}\\
\HOLConst{lit_list_to_form}\;[\HOLFreeVar{fb}]\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{negf}\;\HOLFreeVar{fb}\\
\HOLConst{lit_list_to_form}\;(\HOLFreeVar{fb}\HOLSymConst{::}\HOLFreeVar{v\sb{\mathrm{2}}}\HOLSymConst{::}\HOLFreeVar{v\sb{\mathrm{3}}})\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{AND}\;(\HOLConst{negf}\;\HOLFreeVar{fb})\;(\HOLConst{lit_list_to_form}\;(\HOLFreeVar{v\sb{\mathrm{2}}}\HOLSymConst{::}\HOLFreeVar{v\sb{\mathrm{3}}}))
  \HOLConst{lit_list_to_form2}\;[]\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\ensuremath{\bot}}\\
\HOLConst{lit_list_to_form2}\;[\HOLFreeVar{fb}]\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLFreeVar{fb}\\
\HOLConst{lit_list_to_form2}\;(\HOLFreeVar{fb}\HOLSymConst{::}\HOLFreeVar{v\sb{\mathrm{2}}}\HOLSymConst{::}\HOLFreeVar{v\sb{\mathrm{3}}})\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{DISJ}\;\HOLFreeVar{fb}\;(\HOLConst{lit_list_to_form2}\;(\HOLFreeVar{v\sb{\mathrm{2}}}\HOLSymConst{::}\HOLFreeVar{v\sb{\mathrm{3}}}))
\end{holmath}

A pair $(f,tv)$ where $f\in fs$ and $tv$ is a truth value is called a literal, it encodes a formula in $fs$ or its negation. Such a pair is turned to a formula $f$ or $\lnot f$ by \HOLinline{\HOLConst{negf}}, depends on the truth value given in its second coordinate.  For a finite $fs$, we are interested in non-empty lists of literals with the condition that \HOLinline{\HOLConst{set}\;(\HOLConst{MAP}\;\HOLConst{FST}\;\HOLFreeVar{l})\;\HOLSymConst{=}\;\HOLFreeVar{fs}} and \HOLinline{\HOLConst{ALL_DISTINCT}\;(\HOLConst{MAP}\;\HOLConst{FST}\;\HOLFreeVar{l})}, where \HOLinline{\HOLConst{MAP}} takes a function $f$ and a list $[a_1;\cdots,a_n]$, and return the list $[f(a_1);\cdots;f(a_n)]$. The function \HOLinline{\HOLConst{set}} takes a list and gives the set of its members, and \HOLinline{\HOLConst{ALL_DISTINCT}} takes a list and return the truth value of whether all the member of the list. These conditions precisely say that each member of $fs$ occurs exactly once in the list. As a consequence, we can build \HOLinline{\HOLConst{CONJ_OF}} formulas from such list using  \texttt{lit_list_to_form}. Conversely, each \HOLinline{\HOLConst{CONJ_OF}} formula can be obtained from such a list.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{l}\;\HOLSymConst{\HOLTokenNotEqual{}}\;[]\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{set}\;(\HOLConst{MAP}\;\HOLConst{FST}\;\HOLFreeVar{l})\;\HOLSymConst{=}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{ALL_DISTINCT}\;(\HOLConst{MAP}\;\HOLConst{FST}\;\HOLFreeVar{l})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{CONJ_OF}\;(\HOLConst{lit_list_to_form}\;\HOLFreeVar{l})\;\HOLFreeVar{fs}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{CONJ_OF}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{l}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{set}\;(\HOLConst{MAP}\;\HOLConst{FST}\;\HOLBoundVar{l})\;\HOLSymConst{=}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{ALL_DISTINCT}\;(\HOLConst{MAP}\;\HOLConst{FST}\;\HOLBoundVar{l})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLFreeVar{f}\;\HOLSymConst{=}\;\HOLConst{lit_list_to_form}\;\HOLBoundVar{l}
\end{holmath}

Under the same condition on the list, the corresponding result holds for \texttt{lit_list_to_form} and \HOLinline{\HOLConst{DISJ_OF0}}:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{l}\;\HOLSymConst{\HOLTokenNotEqual{}}\;[]\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{set}\;\HOLFreeVar{l}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{ALL_DISTINCT}\;\HOLFreeVar{l}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{DISJ_OF0}\;(\HOLConst{lit_list_to_form2}\;\HOLFreeVar{l})\;\HOLFreeVar{fs}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DISJ_OF0}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{l}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{l}\;\HOLSymConst{\HOLTokenNotEqual{}}\;[]\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{set}\;\HOLBoundVar{l}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLSymConst{=}\;\HOLConst{lit_list_to_form2}\;\HOLBoundVar{l}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{ALL_DISTINCT}\;\HOLBoundVar{l}
\end{holmath}

Put the two things together, we can build \HOLinline{\HOLConst{DNF_OF}} formulas using \texttt{lit_list_to_form} and \texttt{list_list_to_form2}

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{ld}\;\HOLSymConst{\HOLTokenNotEqual{}}\;[]\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{ALL_DISTINCT}\;\HOLFreeVar{ld}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{d}.\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{MEM}\;\HOLBoundVar{d}\;\HOLFreeVar{ld}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{lc}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{lc}\;\HOLSymConst{\HOLTokenNotEqual{}}\;[]\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{d}\;\HOLSymConst{=}\;\HOLConst{lit_list_to_form}\;\HOLBoundVar{lc}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{set}\;(\HOLConst{MAP}\;\HOLConst{FST}\;\HOLBoundVar{lc})\;\HOLSymConst{=}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{ALL_DISTINCT}\;(\HOLConst{MAP}\;\HOLConst{FST}\;\HOLBoundVar{lc}))\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{DNF_OF}\;(\HOLConst{lit_list_to_form2}\;\HOLFreeVar{ld})\;\HOLFreeVar{fs}
\end{holmath}

By induction on list, we can prove the distributivity and symmetry of \texttt{lit_list_to_form2}:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{l}\;\HOLSymConst{\HOLTokenNotEqual{}}\;[]\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;(\HOLConst{AND}\;\HOLFreeVar{e}\;(\HOLConst{lit_list_to_form2}\;\HOLFreeVar{l}))\\
\;\;\;\;\;\;\;(\HOLConst{lit_list_to_form2}\;(\HOLConst{MAP}\;(\HOLTokenLambda{}\HOLBoundVar{a}.\;\HOLConst{AND}\;\HOLFreeVar{e}\;\HOLBoundVar{a})\;\HOLFreeVar{l}))
  \ensuremath{\HOLTokenTurnstile}\HOLConst{set}\;\HOLFreeVar{l\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLConst{set}\;\HOLFreeVar{l\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;(\HOLConst{lit_list_to_form2}\;\HOLFreeVar{l\sb{\mathrm{1}}})\;(\HOLConst{lit_list_to_form2}\;\HOLFreeVar{l\sb{\mathrm{2}}})
\end{holmath}



Use the lemmas above, by induction on finiteness, we prove the disjunction of all possible conjunctions is equivalent to the truth:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\\
\;\;\;\;\;\;\;(\HOLConst{lit_list_to_form2}\;(\HOLConst{SET_TO_LIST}\;\HOLTokenLeftbrace{}\HOLBoundVar{c}\;\HOLTokenBar{}\;\HOLConst{CONJ_OF}\;\HOLBoundVar{c}\;\HOLFreeVar{fs}\HOLTokenRightbrace{}))\\
\;\;\;\;\;\;\;\HOLConst{TRUE}
\end{holmath}

Now we launch on the proof of \texttt{IBC_DNF_EXISTS_case4}:

Given an $f\in fs$, the desired $p$ is given by $\phi:=$\HOLinline{\HOLConst{lit_list_to_form}}(\HOLinline{\HOLConst{SET_TO_LIST}} $\{f\land c\mid c\mid CONJ\_OF \ c \ (fs/\{f\})\}$. Here \HOLinline{\HOLConst{SET_TO_LIST}} is a function takes a set and form a list with all the elements of the set as members. There are two things to check: Using \HOLinline{\HOLFreeVar{CONJ\HOLTokenUnderscore{}OF\HOLTokenUnderscore{}AND\HOLTokenUnderscore{}lemma}} and \texttt{list_to_DNF_lemma}, it is immediate to prove $\phi$ is in disjunction normal form. To prove $\phi$ is equivalent to $f$, we have:

\HOLinline{\HOLConst{lit_list_to_form}}(\HOLinline{\HOLConst{SET_TO_LIST}} $\{f\land c\mid c\mid CONJ\_OF \ c \ (fs/\{f\})\}$

=\HOLinline{\HOLConst{lit_list_to_form}}(\HOLinline{\HOLConst{MAP}\;(\HOLTokenLambda{}\HOLBoundVar{a}.\;\HOLConst{AND}\;\HOLFreeVar{f}\;\HOLBoundVar{a})}(\HOLinline{\HOLConst{SET_TO_LIST}} $\{c\mid CONJ\_OF \ c \ (fs/\{f\})\}$))

$\overset{\text{list\_demorgan}}\equiv f\land$ \HOLinline{\HOLConst{lit_list_to_form}}(\HOLinline{\HOLConst{SET_TO_LIST}}$\{c\mid CONJ\_OF \ c \ (fs/\{f\})\}$)

$\overset{\text{ALL\_POSSIBLE\_VALUE\_TRUE}}\equiv f \land \top$

$\equiv f$

Hence we are done with the base case of \texttt{IBC_DNF_EXISTS}.

\subsubsection{Case for disjunction}

The following lemma directly implies our goal by the fact that if $f1$ is equivalent $p1$ and $f2$ is equivalent to $p2$, then $f1\lor f2$ is equivalent to $p1\lor p2$ and the transitivity of being equivalent.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DNF_OF}\;\HOLFreeVar{p\sb{\mathrm{1}}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{DNF_OF}\;\HOLFreeVar{p\sb{\mathrm{2}}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLConst{DNF_OF}\;\HOLBoundVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLBoundVar{f}\;(\HOLConst{DISJ}\;\HOLFreeVar{p\sb{\mathrm{1}}}\;\HOLFreeVar{p\sb{\mathrm{2}}})
\end{holmath}

Expanding the definition of \HOLinline{\HOLConst{DNF_OF}} and \HOLinline{\HOLConst{DISJ_OF0}} gives four cases, the only interesting one among them is stated as this lemma:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DISJ_OF0}\;\HOLFreeVar{p\sb{\mathrm{1}}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p\sb{\mathrm{2}}}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{p\sb{\mathrm{2}}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLBoundVar{f}\;(\HOLConst{DISJ}\;\HOLFreeVar{p\sb{\mathrm{1}}}\;\HOLBoundVar{p\sb{\mathrm{2}}})
\end{holmath}

Proof:
By induction on \HOLinline{\HOLConst{DISJ_OF0}}, the base case is by a straightfoward two-layer induction, for the step case, suppose \HOLinline{\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{fs}} and \HOLinline{\HOLConst{DISJ_OF0}\;\HOLFreeVar{p\sb{\mathrm{1}}}\;(\HOLFreeVar{fs}\;\HOLConst{DELETE}\;\HOLFreeVar{f\sb{\mathrm{1}}})} and \HOLinline{\HOLConst{DISJ_OF0}\;\HOLFreeVar{p\sb{\mathrm{2}}}\;\HOLFreeVar{fs}}, we are asked to prove:

 \HOLinline{\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\\
\;\;\;\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLBoundVar{f}\;(\HOLConst{DISJ}\;(\HOLConst{DISJ}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLFreeVar{p\sb{\mathrm{1}}})\;\HOLFreeVar{p\sb{\mathrm{2}}})}
from the inductive hypothesis 

\HOLinline{\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p\sb{\mathrm{2}}}.\\
\;\;\;\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{p\sb{\mathrm{2}}}\;(\HOLFreeVar{fs}\;\HOLConst{DELETE}\;\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLConst{DISJ_OF0}\;\HOLBoundVar{f}\;(\HOLFreeVar{fs}\;\HOLConst{DELETE}\;\HOLFreeVar{f\sb{\mathrm{1}}})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLBoundVar{f}\;(\HOLConst{DISJ}\;\HOLFreeVar{p\sb{\mathrm{1}}}\;\HOLBoundVar{p\sb{\mathrm{2}}})}

If \HOLinline{\HOLConst{DISJ_OF0}\;\HOLFreeVar{p\sb{\mathrm{2}}}\;(\HOLFreeVar{fs}\;\HOLConst{DELETE}\;\HOLFreeVar{f\sb{\mathrm{1}}})}, then we are done by inductive hypothesis, otherwise we need a trick: If \HOLinline{\HOLConst{DISJ_OF0}\;\HOLFreeVar{p\sb{\mathrm{2}}}\;\HOLFreeVar{fs}} but \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLConst{DISJ_OF0}\;\HOLFreeVar{p\sb{\mathrm{2}}}\;(\HOLFreeVar{fs}\;\HOLConst{DELETE}\;\HOLFreeVar{f\sb{\mathrm{1}}})}, it must be the case that $f_1$ appears in $p_2$, hence we can extract $f_1$ out of $p_2$ to split $p_2$ as a disjunction $t\lor f_1$, using the following lemma proved by induction on \HOLinline{\HOLConst{DISJ_OF0}}:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DISJ_OF0}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{t}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{t}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{DISJ_OF0}\;\HOLFreeVar{f}\;(\HOLFreeVar{fs}\;\HOLConst{DELETE}\;\HOLBoundVar{t})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{p}.\;\HOLConst{DISJ_OF}\;\HOLBoundVar{p}\;(\HOLFreeVar{fs}\;\HOLConst{DELETE}\;\HOLBoundVar{t})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f}\;(\HOLConst{DISJ}\;\HOLBoundVar{t}\;\HOLBoundVar{p})
\end{holmath}
Applying the lemma above allows us to finish the proof by using the inductive hypothesis.


\subsubsection{Case for negation}

Let us consider our last case, which amounts to prove:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DNF_OF}\;\HOLFreeVar{p}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FINITE}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLConst{DNF_OF}\;\HOLBoundVar{f}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{p})\;\HOLBoundVar{f}
\end{holmath}

The idea of this proof is to use the concept `complement'. Consider a disjunction normal form $p$ on a finite set $fs$, we find a formula of disjunction normal form $f$ which is its negation, that is, we require $f$ to be satisfied if and only if $\lnot p$ is satisfied. As $p$ is a disjunction, $\lnot p$ is satisfied once none of $p$'s conjuncts is satisfied. As a disjunction normal form, all of $p$'s disjuncts are taken from the set of all of the \HOLinline{\HOLConst{CONJ_OF}} formulas on $fs$, and these disjuncts form a subset of $ss\subseteq\{c\mid CONJ\_OF \ c \ fs\}$. Since none of these conjunctions is satisfied, it must be the case that the satisfied conjunction is in $\{c\mid CONJ\_OF \ c \ fs\}/ss$. Again, let $fs = \{f_1,f_2\}$ and $p:= (f_1\land f_2)\lor (\lnot f_1\land f_2)$ is in disjunction normal form. For $\lnot p$ is satisfied, neither $f_1\land f_2$ nor
$ f_1\land\lnot f_2$ is satisfied, so it must be the case that either $\lnot f_1\land\lnot f_2$ or $\lnot f_1\land f_2$. We take the conjunction of the elements in the set $\{\lnot f_1\land\lnot f_2,\lnot f_1\land f_2\}$ formed by taking out the disjuncts appear in $p$ from the total set $\{f_1\land f_2, (\lnot f_1\land f_2,\lnot f_1\land\lnot f_2,\lnot f_1\land f_2\}$, it gives the formula $(\lnot f_1\land\lnot f_2)\lor (\lnot f_1\land f_2)$, which is equivalent to the negation of $p$.

Although it may be possible to stick to using our former tools \texttt{lit_list_to_form} and \texttt{list_list_to_form2}, it is much more natural to directly use the completement of set to deal with our issue here. Again, for a finite set $fs$, we will use literals to encode formulas in $fs$ or its negation. But instead of using list of literals, we will use sets of literals this time.

We define satisfication of a literal as:

\begin{holmath}
  \HOLConst{lsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;(\HOLFreeVar{f}\HOLSymConst{,}\HOLFreeVar{b})\;\HOLSymConst{\HOLTokenDefEquality{}}\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLFreeVar{b})
\end{holmath}

That is, for a model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and a world \HOLinline{\HOLFreeVar{w}}, a literal $(f,T)$ is satisfied at $w$ if \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f}}, and $(f,F)$ is satisfied at $w$ if \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f})}. We want to construct \HOLinline{\HOLConst{CONJ_OF}} formulas from well-formed sets of literals, such a well-formed set is called an `lset':

\begin{holmath}
  \HOLConst{is_lset}\;\HOLFreeVar{c}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{FINITE}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FINITE}\;\HOLFreeVar{c}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{CARD}\;\HOLFreeVar{c}\;\HOLSymConst{=}\;\HOLConst{CARD}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{IMAGE}\;\HOLConst{FST}\;\HOLFreeVar{c}\;\HOLSymConst{=}\;\HOLFreeVar{fs}
\end{holmath}

Note the condition of being an \texttt{lset} corresponds the condition on the list as in the story about the base case. An \texttt{lset} corresponds a conjunction, for instance, $ls:=\{(f_1,T),(f_2,T)\}$ corresponds to the formula $f_1\land f_2$. We care about when all the literals in the set are satisfied, and call a set $c$-satisfied for this situation. 

\begin{holmath}
  \HOLConst{csatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{c}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{l}.\;\HOLBoundVar{l}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{c}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{lsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLBoundVar{l}
\end{holmath}

If two \texttt{lset}s are different, the union of them must contains a literal of opposite sign, hence the union of two distinct \texttt{lsets} can never be $c$-satisfied:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{is_lset}\;\HOLFreeVar{c\sb{\mathrm{1}}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{is_lset}\;\HOLFreeVar{c\sb{\mathrm{2}}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{c\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLFreeVar{c\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{csatis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLFreeVar{c\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLFreeVar{c\sb{\mathrm{2}}})
\end{holmath}

By induction on \HOLinline{\HOLConst{CONJ_OF}} and the finiteness of \texttt{lset} respectively, we prove for any \texttt{lset}, it is $c$-satisfied at a world in a model iff its corresponding \HOLinline{\HOLConst{CONJ_OF}} formula is satisfied at the same point. Conversely, for any \HOLinline{\HOLConst{CONJ_OF}} formula, there is an \texttt{lset} that corresponds to it: 

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{CONJ_OF}\;\HOLFreeVar{c}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{ls}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{is_lset}\;\HOLBoundVar{ls}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{csatis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{ls}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{c})
  \ensuremath{\HOLTokenTurnstile}\HOLConst{is_lset}\;\HOLFreeVar{c}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{c}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{csatis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{c}))\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{CONJ_OF}\;\HOLBoundVar{f}\;\HOLFreeVar{fs}
\end{holmath}

A disjunction of \HOLinline{\HOLConst{CONJ_OF}} formula is captured by sets of literal sets. For instance, the set $\{\{(f_1,T),(f_2,T)\},\{(f_1,F),(f_2,T)\}\}$ encodes the formula $(f_1\land f_2)\lor (\lnot f_1\land f_2)$ of disjunction normal form on the set $\{f_1,f_2\}$. And the satisfication of \HOLinline{\HOLConst{DISJ_OF0}} formulas is captured by $d$-satisfication:

\begin{holmath}
  \HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{cs}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{c}.\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{cs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{csatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLBoundVar{c}
\end{holmath}

There is a set-version of the the previous proposition \texttt{ALL_POSSIBLE_VALUE_TRUE}, looks like:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{dsatis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLTokenLeftbrace{}\HOLBoundVar{c}\;\HOLTokenBar{}\;\HOLConst{is_lset}\;\HOLBoundVar{c}\;\HOLFreeVar{fs}\HOLTokenRightbrace{}
\end{holmath}

Using this as a lemma, we can prove the a critical statement about our idea of `complement', saying that a set of \texttt{lset}s are $d$-satisfied iff its complement in the `total set' of all the \texttt{lset}s is not $d$-satisfied.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{c}.\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{cs}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{is_lset}\;\HOLBoundVar{c}\;\HOLFreeVar{fs})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLConst{dsatis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{cs}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{dsatis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLTokenLeftbrace{}\HOLBoundVar{c}\;\HOLTokenBar{}\;\HOLConst{is_lset}\;\HOLBoundVar{c}\;\HOLFreeVar{fs}\HOLTokenRightbrace{}\;\HOLConst{DIFF}\;\HOLFreeVar{cs}))
\end{holmath}

Proof:
For the implication from left to right, suppose both \HOLinline{\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{cs}} and \HOLinline{\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}}$\{c\mid is\_lset\ cfs\}/cs$, then by definition of \HOLinline{\HOLConst{dsatis}}, it means two distinct \texttt{lset}s are $c$-satisfied at the same point, which contradicts \texttt{NEQ_lsets_FALSE}. For the implication from right to left, suppose \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{cs}}, by \texttt{dsatis_ALL_POSSIBLE_VALUE_TRUE}, the \texttt{lset} which holds on $w$ must lies in $\{c\mid is\_lset\ cfs\}/cs$. This completes the proof.



And we have a correspondence of set of \texttt{lset}s and \HOLinline{\HOLConst{DISJ_OF0}} formulas. 

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DISJ_OF0}\;\HOLFreeVar{d}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{fs\sb{\mathrm{0}}}.\\
\;\;\;\;\;\;\;\;\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLTokenLeftbrace{}\HOLBoundVar{c}\;\HOLTokenBar{}\;\HOLConst{CONJ_OF}\;\HOLBoundVar{c}\;\HOLBoundVar{fs\sb{\mathrm{0}}}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{cs}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{c}.\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{cs}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{is_lset}\;\HOLBoundVar{c}\;\HOLBoundVar{fs\sb{\mathrm{0}}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{d}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{c}.\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{cs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{csatis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{c})
\end{holmath}  

Altoghther, there are the correspondence results of set of \texttt{lset}s and \HOLinline{\HOLConst{DNF_OF}} formulas. The first one, which is a immediate consequence of \texttt{DISJ_OF0_cset}, says each \HOLinline{\HOLConst{DNF_OF}} formula corresponds a set of \texttt{lset}s.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{DNF_OF}\;\HOLFreeVar{d}\;\HOLFreeVar{fs}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{cs}.\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{c}.\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{cs}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{is_lset}\;\HOLBoundVar{c}\;\HOLFreeVar{fs})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{d}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{c}.\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{cs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{csatis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{c})
\end{holmath}


The second one says each set of \texttt{lset}s gives a \HOLinline{\HOLConst{DNF_OF}} formula:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{fs}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{FINITE}\;\HOLBoundVar{fs}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{fs}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{c}.\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{is_lset}\;\HOLBoundVar{c}\;\HOLBoundVar{fs})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{dsatis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{s}))\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{DNF_OF}\;\HOLBoundVar{f}\;\HOLBoundVar{fs}
\end{holmath}

Proof:
The proof is by induction on \HOLinline{\HOLConst{FINITE}\;\HOLFreeVar{s}}. For the base case that $s=\emptyset$, the required formula $f$ is obviously $\bot$. Suppose for $s$ a finite set of \texttt{lset}s and there exists a formula $f$ in disjunction normal form such that \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{s}} for any model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and any \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}, we find a formula $g$ such that \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{g}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;(\HOLFreeVar{e}\;\HOLConst{INSERT}\;\HOLFreeVar{s})}. By \texttt{is_lset_CONJ_OF_EXISTS}, there is a \HOLinline{\HOLConst{CONJ_OF}} formula $f'$ on $fs$ with the property that \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f\sp{\prime}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{csatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{e}} for arbitary \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}. If $f$ is equivalent to $\bot$, then $f'$ is the $g$ we want, and vice versa. If both of them are not equivalent to $\bot$, we can take $f'\lor f$ as the $g$ we want. The first desired condition is easy to check, it remains to prove $f'\lor f$ is in disjunction normal form, which is suffices by proving \HOLinline{\HOLConst{DISJ_OF0}\;\HOLFreeVar{f}} $\{c\mid CONJ\_OF\ c\ fs\}/ \{f'\}$. Suppose not, then there exists a $p$ such that \HOLinline{\HOLConst{DISJ_OF0}\;\HOLFreeVar{p}} $\{c\mid CONJ\_OF\ c \ fs\}/\{f'\}$ and \HOLinline{\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{f}\;(\HOLConst{DISJ}\;\HOLFreeVar{f\sp{\prime}}\;\HOLFreeVar{p})} by \texttt{DISJ_OF0_split}. To obtain a contradiction, we find a model with a world satisfies $f'$ but not $f$. With the equivalence conditions on $f$ and $f'$, it amounts to find a modal \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} with a world \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} such that \HOLinline{\HOLConst{csatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{e}} but \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{s}}. The claim is any world $c$-satisfying $e$ cannot $d$-satisfy $s$, otherwise it contradicts \texttt{dsatis_is_lset_completment}. Also since $f'$ is not equivalent to $\bot$, a model satisfying $f'$ exists, so we are done. 

Now we have all the ingredients to prove our last case.

Proof:
As \HOLinline{\HOLConst{DNF_OF}\;\HOLFreeVar{p}\;\HOLFreeVar{fs}}, by \texttt{DNF_OF_cset} we obtain a \texttt{lset} $cs$ such that \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{p}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{cs}} for any \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and $w$. Consider its complement $\{c\mid is\_lset\ c\ fs\}/cs$, by \texttt{is_lset_DNF_OF_EXISTS} we obtain a formula $f$ such that \HOLinline{\HOLConst{DNF_OF}\;\HOLFreeVar{f}\;\HOLFreeVar{fs}} and \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{f}} iff \HOLinline{\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}} $\{c\mid is\_lset\ c\ fs\}/cs$ for any \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and $w$. By \texttt{dsatis_is_lset_complement}, \HOLinline{\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}} $\{c\mid is\_lset\ c\ fs\}/cs$ iff \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLConst{dsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{cs}}, so $f$ is equivalent to $\lnot p$.


Here we are done with the proof of \texttt{prop_2_29_strengthen}. This is the end of the interlude.

This is time to return to discussion about the proof of finite model property. Recall in the last chapter, we have seen that a bisimulation gives arise to modal equivalence, modal equivalence is `satisfiying exactly the same formulas', but when we are building a finite model for a formula $\phi$, we do not care about the satisfication of any formula of degree above \HOLinline{\HOLConst{DEG}\;\HOLFreeVar{phi}}, since such formula cannot affect the satisfication of $\phi$. Therefore, a finite approximation of bisimulation is enough, a finite approximation of depth $n$ is called an $n$-bisimulation. Let \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}}, $w$ and $w'$ are $n$-bisimilar if there exists a sequence of relations $Z_n\subseteq \cdots\subseteq Z_0$ such that:
\begin{itemize}
  \item $w$ and $w'$ are related by $Z_n$
  \item If \HOLinline{\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{M'frame}.\HOLFieldName{world}} are related by $Z_0$, then $v$ and $v'$ satisfy the same propositional letters.
  \item If \HOLinline{\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{M'frame}.\HOLFieldName{world}} are related by $Z_{i+1}$ and we have \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{v}\;\HOLFreeVar{u}} for \HOLinline{\HOLFreeVar{u}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}, then there exists \HOLinline{\HOLFreeVar{u\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}} such that \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{v\sp{\prime}}\;\HOLFreeVar{u\sp{\prime}}} with $u$ and $u'$ related by $Z_i$.
  \item If \HOLinline{\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{M'frame}.\HOLFieldName{world}} are related by $Z_{i+1}$ and we have \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{v\sp{\prime}}\;\HOLFreeVar{u\sp{\prime}}} for \HOLinline{\HOLFreeVar{u\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}, then there exists \HOLinline{\HOLFreeVar{u}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} such that \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{v}\;\HOLFreeVar{u}} with $u$ and $u'$ related by $Z_i$.
\end{itemize}

Such a sequence of $Z_i$ is a family of relations indexed by natural numbers. When the world set of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} has type $\beta$ and the world set of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} has type $\gamma$, we encode such a family using functions $f:num\to \beta\to\gamma\to bool$. Such a function assigns each natural number a relation, so the \HOLinline{\HOLFreeVar{f}\;\HOLFreeVar{i}} is the relation $Z_i$ in the usual mathematical definition, and \HOLinline{\HOLConst{nbisim}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{f}\;\HOLFreeVar{n}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}} means $w$ and $w'$ are worlds in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} respectively which are $n$ bisimilar via the family of relations given by $f$.

\begin{holmath}
  \HOLConst{nbisim}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{f}\;\HOLFreeVar{n}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{m}\;\HOLBoundVar{a}\;\HOLBoundVar{b}.\\
\;\;\;\;\;\;\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{b}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\HOLBoundVar{m}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\HOLFreeVar{f}\;(\HOLBoundVar{m}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})\;\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\HOLFreeVar{f}\;\HOLBoundVar{m}\;\HOLBoundVar{a}\;\HOLBoundVar{b})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLFreeVar{n}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}\;\HOLBoundVar{v\sp{\prime}}.\\
\;\;\;\;\;\;\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\HOLFreeVar{f}\;\HOLNumLit{0}\;\HOLBoundVar{v}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p}.\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{v}\;(\HOLConst{VAR}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{v\sp{\prime}}\;(\HOLConst{VAR}\;\HOLBoundVar{p}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}\;\HOLBoundVar{v\sp{\prime}}\;\HOLBoundVar{u}\;\HOLBoundVar{i}.\\
\;\;\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{v}\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;(\HOLBoundVar{i}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})\;\HOLBoundVar{v}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{u\sp{\prime}}.\;\HOLBoundVar{u\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{v\sp{\prime}}\;\HOLBoundVar{u\sp{\prime}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLBoundVar{i}\;\HOLBoundVar{u}\;\HOLBoundVar{u\sp{\prime}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}\;\HOLBoundVar{v\sp{\prime}}\;\HOLBoundVar{u\sp{\prime}}\;\HOLBoundVar{i}.\\
\;\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\HOLBoundVar{u\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{v\sp{\prime}}\;\HOLBoundVar{u\sp{\prime}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;(\HOLBoundVar{i}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})\;\HOLBoundVar{v}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{u}.\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{v}\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLBoundVar{i}\;\HOLBoundVar{u}\;\HOLBoundVar{u\sp{\prime}}
\end{holmath} 


By induction on $n$, we see if two worlds \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}} are related by an $n$-bisimulation, then they agree on all modal formulas up to degree $n$:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLConst{nbisim}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{f}\;\HOLFreeVar{n}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\;\HOLConst{DEG}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w\sp{\prime}}\;\HOLBoundVar{phi})
\end{holmath}

The converse of the above holds when our modal language is defined on a finite set of propositional letters and the type of world sets of our models are infinite. It can be proved by an argument analogue to the proof of Hennessy-Milner theorem, with \HOLinline{\HOLTokenLambda{}\HOLBoundVar{n}\;\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{n\sb{\mathrm{2}}}.\\
\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\;\HOLConst{DEG}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{n\sb{\mathrm{2}}}\;\HOLBoundVar{phi})} gives an $n$-bisimulation relation linking $w$ and $w'$:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{INFINITE}\;\ensuremath{\cal{U}}(:\ensuremath{\beta})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{INFINITE}\;\ensuremath{\cal{U}}(:\ensuremath{\gamma})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FINITE}\;\ensuremath{\cal{U}}(:\ensuremath{\alpha})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\;\HOLConst{DEG}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w\sp{\prime}}\;\HOLBoundVar{phi}))\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLConst{nbisim}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{f}\;\HOLFreeVar{n}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}
\end{holmath} 


\HOLinline{\HOLConst{DEG}} is a concept that measure the depth of a formula, we also want a concept that measure the depth of a model, as `depth' is a relative concept measuring the distance of two points. To talk about the depth of a world \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}, we need \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} to be naturally equipped with a base point, so the `height' of a world only makes sense to rooted model. To tell the HOL about this definition, we start by defining \HOLinline{\HOLConst{heightLE}}:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLConst{heightLE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{x}\;\HOLBoundVar{n})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}\;\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{heightLE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w}\;\HOLBoundVar{n})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{heightLE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{v}\;(\HOLBoundVar{n}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLFreeVar{heightLE\sp{\prime}}\;\HOLFreeVar{x}\;\HOLBoundVar{n})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}\;\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{heightLE\sp{\prime}}\;\HOLBoundVar{w}\;\HOLBoundVar{n})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{heightLE\sp{\prime}}\;\HOLBoundVar{v}\;(\HOLBoundVar{n}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}))\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a\sb{\mathrm{0}}}\;\HOLBoundVar{a\sb{\mathrm{1}}}.\;\HOLConst{heightLE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{a\sb{\mathrm{0}}}\;\HOLBoundVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{heightLE\sp{\prime}}\;\HOLBoundVar{a\sb{\mathrm{0}}}\;\HOLBoundVar{a\sb{\mathrm{1}}}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{heightLE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLFreeVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLSymConst{=}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenDisj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{n}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{a\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLBoundVar{n}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLFreeVar{a\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{heightLE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w}\;\HOLBoundVar{n}
\end{holmath}

Recall how we defined rooted model: \HOLinline{\HOLConst{rooted_model}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} means `\HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is a rooted model generated by the world $x$ in the ambient model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}}'. As \HOLinline{\HOLConst{heightLE}} is designed to be only make sense for rooted models, we encode the information about the rootedness of the model we are talking about into this definition. \HOLinline{\HOLConst{heightLE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{n}} reads `for the rooted model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} generated by the root $x$ in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}}, the distance from the world \HOLinline{\HOLFreeVar{w}} to the root $x$ is less or equal to $n$. The height of such a world $w$ is the smallest natural number $n$ such that \HOLinline{\HOLConst{heightLE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{n}}. And a height of model is the maximum $n$ such that there is a world of height $n$ in the model.

\begin{holmath}
  \HOLConst{height}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{MIN_SET}\;\HOLTokenLeftbrace{}\HOLBoundVar{n}\;\HOLTokenBar{}\;\HOLConst{heightLE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLBoundVar{n}\HOLTokenRightbrace{}
  \HOLConst{model_height}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{MAX_SET}\;\HOLTokenLeftbrace{}\HOLBoundVar{n}\;\HOLTokenBar{}\;(\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{w}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{height}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w}\;\HOLSymConst{=}\;\HOLBoundVar{n})\HOLTokenRightbrace{}
\end{holmath}

Obviously, the root of any rooted model have height $0$. We are particularly interested in talking about heights in tree-like model. When \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is tree-like, if \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} has height $n$, then any world \HOLinline{\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} such that \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}} will have height $n+1$, this is proved using the induction principle \texttt{RTC_INDUCT_RIGHT1}:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{tree}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{height}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLSymConst{=}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{height}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{v}\;\HOLSymConst{=}\;\HOLFreeVar{n}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}
\end{holmath}

The restriction of a rooted model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} to the height $k$ is the submodel consisting of all the worlds in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} of height up to $k$. The restriction of a tree-like model is again a tree-like model:

\begin{holmath}
  \HOLConst{hrestriction}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{frame}\;:=\\
\;\;\;\;\HOLTokenLeftrec{}\HOLFieldName{world}\;:=\;\HOLTokenLeftbrace{}\HOLBoundVar{w}\;\HOLTokenBar{}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{height}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}\HOLTokenRightbrace{};\\
\;\;\;\;\;\;\HOLFieldName{rel}\;:=\;(\HOLTokenLambda{}\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{n\sb{\mathrm{2}}}.\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{n\sb{\mathrm{2}}})\HOLTokenRightrec{};\\
\;\;\HOLFieldName{valt}\;:=\;(\HOLTokenLambda{}\HOLBoundVar{phi}\;\HOLBoundVar{n}.\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{phi}\;\HOLBoundVar{n})\HOLTokenRightrec{}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{tree}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}\;\HOLFreeVar{x}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLConst{tree}\;(\HOLConst{hrestriction}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{n}).\HOLFieldName{frame}\;\HOLFreeVar{x}
\end{holmath}

Restriction of rooted model gives arise of $n$-bisimulation: If we restrict a rooted model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} to height $k$, then a world $w$ of height $m$ in the restricted model is $k-m$-bisimilar to itself in the original model:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{rooted_model}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLConst{hrestriction}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{k}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{nbisim}\;(\HOLConst{hrestriction}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{k})\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{f}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLFreeVar{k}\;\HOLSymConst{\ensuremath{-}}\;\HOLConst{height}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w})\;\HOLBoundVar{w}\;\HOLBoundVar{w}
\end{holmath}

Proof:
The $n$-bisimilar relation is give as \HOLinline{\HOLTokenLambda{}\HOLBoundVar{n}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}.\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{height}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{x}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{k}\;\HOLSymConst{\ensuremath{-}}\;\HOLBoundVar{n}}.

Now we can start building a finite model via selection:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLFreeVar{w\sb{\mathrm{1}}}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{FM}\;\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{FINITE}\;\HOLBoundVar{FM}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{FM}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLBoundVar{FM}\;\HOLBoundVar{v}\;\HOLFreeVar{phi}
\end{holmath}

Proof: Suppose \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{1}}}\;\HOLFreeVar{w\sb{\mathrm{1}}}\;\HOLFreeVar{phi}} where $w_1:\beta,\phi:\alpha\ form$, then by \texttt{prop_2_15_corollary}, there exists a tree-like model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}} with \HOLinline{\HOLFreeVar{phi}} satisfied at its root \HOLinline{\HOLFreeVar{w\sb{\mathrm{2}}}}. Such an \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}} obtained from \texttt{prop_2_15_corollary} has its world set of type $\beta\ list$, so all the lemmas proved before with a infinite universe assumption applies for any model with its world set a subset of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}.\HOLFieldName{frame}.\HOLFieldName{world}} . Define $M_3:=$\HOLinline{\HOLConst{hrestriction}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLFreeVar{w\sb{\mathrm{2}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLFreeVar{k}} to be the restriction of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}} to height $k$, then $M_3$ is rooted and there is a \HOLinline{\HOLConst{nbisim}\;\HOLFreeVar{M\sb{\mathrm{3}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}\sb{2}}}\;\HOLFreeVar{f}\;\HOLFreeVar{k}\;\HOLFreeVar{w\sb{\mathrm{2}}}\;\HOLFreeVar{w\sb{\mathrm{2}}}} by \texttt{lemma_2_33}. Hence \HOLinline{\HOLConst{satis}\;\HOLFreeVar{M\sb{\mathrm{3}}}\;\HOLFreeVar{w\sb{\mathrm{2}}}\;\HOLFreeVar{phi}} by \texttt{prop_2_31_half1}. By \texttt{exercise_1_3_1} proved in the first chapter, if a propositional letter does not appear in $\phi$, then it has no effect to the satisfication of $\phi$, so we can discard all the propositional letters in \HOLinline{\HOLFreeVar{M\sb{\mathrm{3}}}} which does not occur in $\phi$ to obtain the model \HOLinline{\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{frame}\;:=\;\HOLTokenLeftrec{}\HOLFieldName{world}\;:=\;\HOLFreeVar{M\sb{\mathrm{3}}}.\HOLFieldName{frame}.\HOLFieldName{world};\;\HOLFieldName{rel}\;:=\;\HOLFreeVar{M\sb{\mathrm{3}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\HOLTokenRightrec{};\\
\;\;\;\;\;\;\HOLFieldName{valt}\;:=\\
\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{p}\;\HOLBoundVar{v}.\;\HOLKeyword{if}\;\HOLConst{VAR}\;\HOLBoundVar{p}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLFreeVar{phi}\;\HOLKeyword{then}\;\HOLFreeVar{M\sb{\mathrm{3}}}.\HOLFieldName{valt}\;\HOLBoundVar{p}\;\HOLBoundVar{v}\;\HOLKeyword{else}\;\HOLConst{F})\HOLTokenRightrec{}}, and still have \HOLinline{\HOLConst{satis}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLFreeVar{w\sb{\mathrm{2}}}\;\HOLFreeVar{phi}}. We select a finite model inductively from \HOLinline{\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}}.

Let $s$ denote the set of propositional letters used by $\phi$, so $s$ is finite. By \texttt{prop_2_29_strengthen}, there are only finitely many non-equivalent formulas of degree less or equal to $k$ which only use propositional letters in $s$, that is, the set $distfp:=\{f \mid DEG\ f \le k \land \forall a. VAR\ a \in subforms\ f \implies a \in s\}//E\ \mu$ is a finite. We care about the equivalence classes in $distfp$ which are equivalence classes of formulas starting with a $\Diamond$. For such a equivalence class, taking the intersection with the set $\{d \mid ?d0. d = \Diamond d0\}$ does not give the empty set. Take the image of $distfp$ under the function $\lambda s. s\cap \{d \mid ?d0. d = \Diamond d0\}$ and delete the empty set from the image, we obtain a set $fs$ of sets of formulas, where for each $x\in fs$, $x$ consists of equivalent formulas of degree less or equal to $k$, only use propositional letters in $s$, and starts with diamond. Hence 
$rs:=(IMAGE\ CHOICE ((IMAGE \ (\lambda s. s \cap \{d \mid ?d0. d = \Diamond d0\}) \ distfp) \ DELETE \ \{\})$ can be taken as the set of representatives of formulas with desired properties, it is finite as an image of a finite set. 

We will construct sets $S_0,\cdots S_k$ of worlds in \HOLinline{\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}}, where the points in $S_n$ have height $n$. Start with $S_0:=\{w_2\}$, and inductively, assume $S_0,\cdots S_n$ has been defined, construct $S_{n+1}$ as follows: Consider an element in $v\in S_n$, for each $\Diamond \phi\in rs$ such that \HOLinline{\HOLConst{satis}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLFreeVar{w\sb{\mathrm{2}}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{phi})}, pick a world \HOLinline{\HOLFreeVar{u}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}.\HOLFieldName{frame}.\HOLFieldName{world}} such that \HOLinline{\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{v}\;\HOLFreeVar{u}} and \HOLinline{\HOLConst{satis}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLFreeVar{u}\;\HOLFreeVar{phi}}. Do the same thing to all the $v\in S_n$, then $S_{n+1}$ is the set of all the such $u$'s which are seleted in this way. 

The we we taken to formalise the definition of such $S_i$'s is to define a primitive recursive function: \begin{holmath}
\HOLConst{PRIM_REC}\;\HOLTokenLeftbrace{}\HOLFreeVar{w\sb{\mathrm{2}}}\HOLTokenRightbrace{}\\
\;\;(\HOLTokenLambda{}\HOLBoundVar{s\sb{\mathrm{0}}}\;\HOLBoundVar{n}.\\
\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLConst{CHOICE}\;\HOLBoundVar{uset}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{phi}\;\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLBoundVar{v}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{IMAGE}\;\HOLConst{CHOICE}\;(\HOLConst{IMAGE}\;(\HOLTokenLambda{}\HOLBoundVar{s}.\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLTokenLeftbrace{}\HOLBoundVar{d}\;\HOLTokenBar{}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{d\sb{\mathrm{0}}}.\;\HOLBoundVar{d}\;\HOLSymConst{=}\;\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{d\sb{\mathrm{0}}}\HOLTokenRightbrace{})\;\HOLFreeVar{distfp}\;\HOLConst{DELETE}\;\HOLSymConst{\HOLTokenEmpty{}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{s\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{uset}\;\HOLSymConst{=}\;\HOLTokenLeftbrace{}\HOLBoundVar{u}\;\HOLTokenBar{}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{v}\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{u}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLBoundVar{u}\;\HOLBoundVar{phi}\HOLTokenRightbrace{}\HOLTokenRightbrace{})
\end{holmath}
For each $i\le k$, $ss\ i$ will be our $S_i$. By induction on $i$, we can prove each $ss\ i$ is finite, so the set $W4 := \bigcup_i \{ss\ i\mid i \le k\}$ is finite. The resultant finite model we select is: \HOLinline{\HOLFreeVar{M\sb{\mathrm{4}}}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{frame}\;:=\;\HOLTokenLeftrec{}\HOLFieldName{world}\;:=\;\HOLFreeVar{W\sb{\mathrm{4}}};\;\HOLFieldName{rel}\;:=\;\HOLFreeVar{M\sb{\mathrm{3}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\HOLTokenRightrec{};\\
\;\;\;\;\;\;\HOLFieldName{valt}\;:=\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}.\HOLFieldName{valt}\HOLTokenRightrec{}}
To prove \HOLinline{\HOLConst{satis}\;\HOLFreeVar{M\sb{\mathrm{4}}}\;\HOLFreeVar{w\sb{\mathrm{2}}}\;\HOLFreeVar{phi}}, it suffices to give a $k$-bisimulation between \HOLinline{\HOLFreeVar{M\sb{\mathrm{4}}}} and \HOLinline{\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}} relating $w2$ to itself. Such a $k$-bisimulation is: \HOLinline{\HOLTokenLambda{}\HOLBoundVar{n}\;\HOLBoundVar{a\sb{\mathrm{1}}}\;\HOLBoundVar{a\sb{\mathrm{2}}}.\\
\;\;\;\;\HOLBoundVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{M\sb{\mathrm{4}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{a\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\HOLConst{height}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLFreeVar{w\sb{\mathrm{2}}}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLBoundVar{a\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLConst{height}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLFreeVar{w\sb{\mathrm{2}}}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLBoundVar{a\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\HOLConst{height}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLFreeVar{w\sb{\mathrm{2}}}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLBoundVar{a\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{k}\;\HOLSymConst{\ensuremath{-}}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\HOLConst{DEG}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLConst{VAR}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{subforms}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLBoundVar{a\sb{\mathrm{1}}}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{M\sb{\mathrm{3}}\sp{\prime}}\;\HOLBoundVar{a\sb{\mathrm{2}}}\;\HOLBoundVar{phi})}
The rest of the proof amounts to check the above indeed gives a $k$-bisimulation, the proof is not hard using a similar argument as we proved the Hennessy-Milner theorem.

As we took a detour through \texttt{prop_2_15_corollary}, this construction of finite model changes the type of model. 


\section{Reaching out to the world of first order logic}

Modal logic is not an isolated formal system, in this chapter, we start linking modal logic with the wider logical world by discussing about the relation to first order logic. In the first half of the chapter, we define standard translation as our link between modal logic and first order logic, and in the second half of the chapter, with the help of standard translation, we introduce another construction on models which will give modal equivalence, and lead to an elegant result about bisimulation: modal equivalence implies bisimilarity-somewhere-else.

\subsection{Standard Translation}

To discuss the relationship between modal logic and first order logic, firstly we need to build some basics of first order logic in the HOL. First order logic is formalised in HOL light in 1998 as in (reference), we take our construction of first-order model theory as in the paper.

For a first order language, a term is either a variable letter $x$ or a function symbol $f$ applied on a list of terms, which looks like $f(t_1,\cdots,t_n)$, where the $t$'s can either be variable letters or itself a function applied on some terms. To avoid specifying the type every where, we restrict our scope to countable language, by using only natural numbers to denote variable and function symbols:

\begin{holmath}
  \HOLTyOp{term}\;=\;\HOLConst{fV}\;\HOLTyOp{num}\;\HOLTokenBar{}\;\HOLConst{Fn}\;\HOLTyOp{num}\;(\HOLTyOp{term}\;\HOLTyOp{list})
\end{holmath}

Hence our terms will look like \HOLinline{\HOLConst{fV}\;\HOLNumLit{6}}, \HOLinline{\HOLConst{Fn}\;\HOLNumLit{1}\;[\HOLConst{fV}\;\HOLNumLit{1};\;\HOLConst{fV}\;\HOLNumLit{2}]}, \HOLinline{\HOLConst{Fn}\;\HOLNumLit{2}\;[\HOLConst{Fn}\;\HOLNumLit{0}\;[]]}, etc. A constant is just a nullary function symbol.

Our formulas are defined inductively as well, using minimal amount of logical connectives, by choosing the falsity, atoms, implication and universal quantification as primitive, predicate symbols are also represented by natural numbers. In particular, an $n$-ary relation symbol is a predicate symbol that takes lists of length $n$:

\begin{holmath}
  \HOLTyOp{\ensuremath{\phi}}\;=\;\HOLConst{fFALSE}\;\HOLTokenBar{}\;\HOLConst{Pred}\;\HOLTyOp{num}\;(\HOLTyOp{term}\;\HOLTyOp{list})\;\HOLTokenBar{}\;\HOLConst{IMP}\;\HOLTyOp{\ensuremath{\phi}}\;\HOLTyOp{\ensuremath{\phi}}\;\HOLTokenBar{}\;\HOLConst{FALL}\;\HOLTyOp{num}\;\HOLTyOp{\ensuremath{\phi}}
\end{holmath}

A quantified variable is called a bounded variable, otherwise it is called free. We define a function that returns the set of free variables of the formula, starting by collecting variables occur in the terms of formulas, and then delete the bounded ones:

\begin{holmath}
  \HOLConst{FVT}\;(\HOLConst{fV}\;\HOLFreeVar{v})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{v}\HOLTokenRightbrace{}\\
\HOLConst{FVT}\;(\HOLConst{Fn}\;\HOLFreeVar{s}\;\HOLFreeVar{ts})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{LIST_UNION}\;(\HOLConst{MAP}\;(\HOLTokenLambda{}\HOLBoundVar{a}.\;\HOLConst{FVT}\;\HOLBoundVar{a})\;\HOLFreeVar{ts})
  \HOLConst{FV}\;\HOLConst{fFALSE}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\HOLTokenEmpty{}}\\
\HOLConst{FV}\;(\HOLConst{Pred}\;\HOLFreeVar{v\sb{\mathrm{0}}}\;\HOLFreeVar{ts})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{LIST_UNION}\;(\HOLConst{MAP}\;\HOLConst{FVT}\;\HOLFreeVar{ts})\\
\HOLConst{FV}\;(\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\ensuremath{\rightarrow}}\;\HOLFreeVar{f\sb{\mathrm{2}}})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{FV}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLConst{FV}\;\HOLFreeVar{f\sb{\mathrm{2}}}\\
\HOLConst{FV}\;(\HOLConst{FALL}\;\HOLFreeVar{x}\;\HOLFreeVar{f})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{FV}\;\HOLFreeVar{f}\;\HOLConst{DELETE}\;\HOLFreeVar{x}
\end{holmath}
%add bounded ones?
Here \HOLinline{\HOLConst{LIST_UNION}} is a function that takes a list of sets, and give us the union of all the sets in the list:

\begin{holmath}
  \HOLConst{LIST_UNION}\;[]\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\HOLTokenEmpty{}}\\
\HOLConst{LIST_UNION}\;(\HOLFreeVar{h}\HOLSymConst{::}\HOLFreeVar{t})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLFreeVar{h}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLConst{LIST_UNION}\;\HOLFreeVar{t}
\end{holmath}

Similarly, we have functions called \texttt{form_functions} and \texttt{form_predicates}, that take a formula and give the set of functions and predicates appear in the formula respectively.


The non-primitive connectives are defined in the canonical way:

\begin{holmath}
  \HOLConst{fNOT}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLFreeVar{f}\;\HOLSymConst{\ensuremath{\rightarrow}}\;\HOLConst{fFALSE}
  \HOLConst{True}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{fNOT}\;\HOLConst{fFALSE}
  \HOLConst{fDISJ}\;\HOLFreeVar{p}\;\HOLFreeVar{q}\;\HOLSymConst{\HOLTokenDefEquality{}}\;(\HOLFreeVar{p}\;\HOLSymConst{\ensuremath{\rightarrow}}\;\HOLFreeVar{q})\;\HOLSymConst{\ensuremath{\rightarrow}}\;\HOLFreeVar{q}
  \HOLConst{fAND}\;\HOLFreeVar{p}\;\HOLFreeVar{q}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{fNOT}\;(\HOLConst{fDISJ}\;(\HOLConst{fNOT}\;\HOLFreeVar{p})\;(\HOLConst{fNOT}\;\HOLFreeVar{q}))
  \HOLConst{fEXISTS}\;\HOLFreeVar{x}\;\HOLFreeVar{p}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{fNOT}\;(\HOLConst{FALL}\;\HOLFreeVar{x}\;(\HOLConst{fNOT}\;\HOLFreeVar{p}))
\end{holmath}

To interpret these formulas, we need models for first order logic. A first order model of type $\alpha$ is a triple consists of an $\alpha$-set which is its domain, a interpretation of function symbols, and a interpretation of predicate symbols.

\begin{holmath}
  \ensuremath{\alpha}\;\HOLTyOp{model} = \HOLTokenLeftrec{}\\
\;\;\;\HOLFieldName{Dom}\;:\;\ensuremath{\alpha}\;\ensuremath{\rightarrow}\;\HOLTyOp{bool};\\
\;\;\;\HOLFieldName{Fun}\;:\;\HOLTyOp{num}\;\ensuremath{\rightarrow}\;\ensuremath{\alpha}\;\HOLTyOp{list}\;\ensuremath{\rightarrow}\;\ensuremath{\alpha};\\
\;\;\;\HOLFieldName{Pred}\;:\;\HOLTyOp{num}\;\ensuremath{\rightarrow}\;\ensuremath{\alpha}\;\HOLTyOp{list}\;\ensuremath{\rightarrow}\;\HOLTyOp{bool}\\
\HOLTokenRightrec{}
\end{holmath}

Given a first order model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, we can interpret formulas or terms by assigning each variable symbol an element in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}}. Such an assignment is given by a valuation, which is a function from the universe of natural numbers to the domain of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}:

\begin{holmath}
  \HOLConst{valuation}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLFreeVar{v}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}
\end{holmath} 

Interpretation of terms and formulas are given as \HOLinline{\HOLConst{termval}} and \texttt{feval}, where \HOLinline{\HOLConst{termval}} takes a model, an assignment of variable letters and a term, gives us an element of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}}. And \texttt{feval} takes a model, an assignment of variable letters and a first order formula, gives us the truth value whether the formula we give holds on the model under the current assignment of variable letters, we only care about when the an assignment of variable letters is indeed a valuation as defined above, when $\sigma$ is a valuation and \HOLinline{\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{fform}}, we say `$fform$ is satisfied in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} under the valuation $\sigma$'. In particular, if there is only one free variable $x$ in $fform$, then \HOLinline{\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{fform}} just means that \HOLinline{\HOLFreeVar{fform}} is satisfied at the point \HOLinline{\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{x}} in the model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}. The advantage of using the \HOLinline{\HOLFreeVar{\ensuremath{\sigma}}} is that it can simutinously cope with any number of free variables. 

\begin{defn}[Term Valuation]
Some text here.  The $\HOLinline{\HOLConst{termval}}\;:\;\HOLinline{\ensuremath{\alpha}\;\HOLTyOp{model}\;\ensuremath{\rightarrow}\;(\HOLTyOp{num}\;\ensuremath{\rightarrow}\;\ensuremath{\alpha})\;\ensuremath{\rightarrow}\;\HOLTyOp{term}\;\ensuremath{\rightarrow}\;\ensuremath{\alpha}}$.
\begin{holmath}
  \HOLConst{termval}\;(\HOLFreeVar{\ensuremath{\mathfrak{M}}} :\ensuremath{\alpha}\;\HOLTyOp{model})\;(\HOLFreeVar{v} :\HOLTyOp{num}\;\ensuremath{\rightarrow}\;\ensuremath{\alpha})\;(\HOLConst{fV}\;(\HOLFreeVar{x} :\HOLTyOp{num}))\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLFreeVar{v}\;\HOLFreeVar{x}\\
\HOLConst{termval}\;(\HOLFreeVar{\ensuremath{\mathfrak{M}}} :\ensuremath{\alpha}\;\HOLTyOp{model})\;(\HOLFreeVar{v} :\HOLTyOp{num}\;\ensuremath{\rightarrow}\;\ensuremath{\alpha})\\
\;\;(\HOLConst{Fn}\;(\HOLFreeVar{f} :\HOLTyOp{num})\;(\HOLFreeVar{l} :\HOLTyOp{term}\;\HOLTyOp{list}))\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Fun}\;\HOLFreeVar{f}\;(\HOLConst{MAP}\;(\HOLTokenLambda{}(\HOLBoundVar{a} :\HOLTyOp{term}).\;\HOLConst{termval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;\HOLBoundVar{a})\;\HOLFreeVar{l})
\end{holmath}
Some concluding comments here.
\end{defn}

\begin{holmath}
  \HOLConst{fsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{fform}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{valuation}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{fform}\\[3mm]
  \HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;\HOLConst{fFALSE}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{F}\\
\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;(\HOLConst{Pred}\;\HOLFreeVar{a}\;\HOLFreeVar{l})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLFreeVar{a}\;(\HOLConst{MAP}\;(\HOLConst{termval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v})\;\HOLFreeVar{l})\\
\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;(\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\ensuremath{\rightarrow}}\;\HOLFreeVar{f\sb{\mathrm{2}}})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;\HOLFreeVar{f\sb{\mathrm{2}}}\\
\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;(\HOLConst{FALL}\;\HOLFreeVar{x}\;\HOLFreeVar{f})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}.\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\ensuremath{\llparenthesis}\HOLFreeVar{x}\;\ensuremath{\mapsto}\;\HOLBoundVar{a}\ensuremath{\rrparenthesis}\;\HOLFreeVar{f}\\
\end{holmath}

 (Why the holds def not work?!)

By induction on first order formula, we show that the truth value of a first order formula only depends on where the valuation sends the free variables to:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{x}.\;\HOLBoundVar{x}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{FV}\;\HOLFreeVar{p}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{v\sb{\mathrm{1}}}\;\HOLBoundVar{x}\;\HOLSymConst{=}\;\HOLFreeVar{v\sb{\mathrm{2}}}\;\HOLBoundVar{x})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v\sb{\mathrm{1}}}\;\HOLFreeVar{p}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v\sb{\mathrm{2}}}\;\HOLFreeVar{p})
\end{holmath}


Models for modal language can be viewed as a first order model and hence be used to interpret some first order formula, and a first order model can be also viewed as a modal model. These conversions can be done using the following two functions:

\begin{holmath}
  \HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{Dom}\;:=\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world};\\
\;\;\HOLFieldName{Fun}\;:=\;(\HOLTokenLambda{}\HOLBoundVar{n}\;\HOLBoundVar{args}.\;\HOLConst{CHOICE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world});\\
\;\;\HOLFieldName{Pred}\;:=\\
\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{p}\;\HOLBoundVar{zs}.\\
\;\;\;\;\;\;\;\;\;\HOLKeyword{case}\;\HOLBoundVar{zs}\;\HOLKeyword{of}\\
\;\;\;\;\;\;\;\;\;\;\;[]\;\HOLTokenImp{}\;\HOLConst{F}\\
\;\;\;\;\;\;\;\;\;\HOLTokenBar{}\;[\HOLBoundVar{w}]\;\HOLTokenImp{}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{p}\;\HOLBoundVar{w}\\
\;\;\;\;\;\;\;\;\;\HOLTokenBar{}\;[\HOLBoundVar{w};\;\HOLBoundVar{w\sb{\mathrm{2}}}]\;\HOLTokenImp{}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{p}\;\HOLSymConst{=}\;\HOLNumLit{0}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\\
\;\;\;\;\;\;\;\;\;\HOLTokenBar{}\;\HOLBoundVar{w}\HOLSymConst{::}\HOLBoundVar{w\sb{\mathrm{2}}}\HOLSymConst{::}\HOLBoundVar{v\sb{\mathrm{10}}}\HOLSymConst{::}\HOLBoundVar{v\sb{\mathrm{11}}}\;\HOLTokenImp{}\;\HOLConst{F})\HOLTokenRightrec{}
  \HOLConst{folm2mm}\;\HOLFreeVar{FM}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{frame}\;:=\\
\;\;\;\;\HOLTokenLeftrec{}\HOLFieldName{world}\;:=\;\HOLFreeVar{FM}.\HOLFieldName{Dom};\\
\;\;\;\;\;\;\HOLFieldName{rel}\;:=\\
\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}.\;\HOLFreeVar{FM}.\HOLFieldName{Pred}\;\HOLNumLit{0}\;[\HOLBoundVar{w\sb{\mathrm{1}}};\;\HOLBoundVar{w\sb{\mathrm{2}}}]\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FM}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FM}.\HOLFieldName{Dom})\HOLTokenRightrec{};\\
\;\;\HOLFieldName{valt}\;:=\;(\HOLTokenLambda{}\HOLBoundVar{v}\;\HOLBoundVar{w}.\;\HOLFreeVar{FM}.\HOLFieldName{Pred}\;\HOLBoundVar{v}\;[\HOLBoundVar{w}]\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FM}.\HOLFieldName{Dom})\HOLTokenRightrec{}
\end{holmath}


Note a first order model from a modal model has no interesting information about function symbols and higher-ary predicate symbols. And by viewing a first order model as a modal model, we lose all the function symbols and predicate symbols except for the unary ones, and the binary one denoted by $0$. So the above constructions are not inverses in general. Also observe the range of formulas which makes sense to first order model obtained by converting a modal model is quite limited, we can only use these model to interpret formulas with only one binary predicate symbol corresponds to the relation in the model, denoted by $0$, and no function symbol. A first order model which do not have `superfluous' symbols contains the same amount of information as a modal model. For such a first order model, converting it to a modal model and then to a first order model again get the original model back, in the sense of the resultant model satisfied exactly the same first order formulas without function symbols. The fact that we that we need the assumption \HOLinline{\HOLConst{form_functions}\;\HOLFreeVar{f}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}} is not a real constrain, but merely an assumption for well-formedness, since any formulas with function symbol does not make sense to both the original model and the resultant model we get by conversion:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{form_functions}\;\HOLFreeVar{f}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[]\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{n}.\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[\HOLBoundVar{a};\;\HOLBoundVar{b}]\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLNumLit{0})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{c}\;\HOLBoundVar{d}\;\HOLBoundVar{n}.\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;(\HOLBoundVar{a}\HOLSymConst{::}\HOLBoundVar{b}\HOLSymConst{::}\HOLBoundVar{c}\HOLSymConst{::}\HOLBoundVar{d})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLConst{feval}\;(\HOLConst{mm2folm}\;(\HOLConst{folm2mm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}))\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{f})
\end{holmath}

Let us build intuition about how does modal formulas corresponds to first order formulas. Observe that unlike modal formulas which atomic formulas are propositional letters standing alone, even the atomic first order formula have a variable symbols involved. Hence to translate a modal formula into a first order formula, we must get variables involved as well. This variables is used to mark the state we are looking at. And moreover, once we see a $\Diamond$ in a modal formula, we start talking about some other state which is related to the current state, so we will need another variable symbol to mark the new state of interest. Hence in mathematical language, the natural correspondence of modal and first order formulas is given by:

$ST_x(p)= Px$

$ST_x(\bot)=\bot$

$ST_x(\lnot \phi)=\lnot ST_x(\phi)$

$ST_x(\phi\lor \psi) =ST_x(\phi)\lor ST_x(\psi)$

$ST_x(\Diamond\phi)=\exists y(Rxy\land ST_y(\phi))$



We can read $ST_x \phi$ as `the standard translation of $\phi$ at $x$'. In the following definition, the $x$, which is a variable symbol in our construction, is a natural number. Each time we see a $\Diamond$, we come with a fresh variable denotes by $x+1$:
\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{x}\;\HOLBoundVar{p}.\;\HOLConst{ST}\;\HOLBoundVar{x}\;(\HOLConst{VAR}\;\HOLBoundVar{p})\;\HOLSymConst{=}\;\HOLConst{fP}\;\HOLBoundVar{p}\;(\HOLConst{fV}\;\HOLBoundVar{x}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{x}.\;\HOLConst{ST}\;\HOLBoundVar{x}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{=}\;\HOLConst{fFALSE})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{x}\;\HOLBoundVar{phi}.\;\HOLConst{ST}\;\HOLBoundVar{x}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{phi})\;\HOLSymConst{=}\;\HOLConst{fNOT}\;(\HOLConst{ST}\;\HOLBoundVar{x}\;\HOLBoundVar{phi}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{x}\;\HOLBoundVar{phi}\;\HOLBoundVar{psi}.\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{ST}\;\HOLBoundVar{x}\;(\HOLConst{DISJ}\;\HOLBoundVar{phi}\;\HOLBoundVar{psi})\;\HOLSymConst{=}\;\HOLConst{fDISJ}\;(\HOLConst{ST}\;\HOLBoundVar{x}\;\HOLBoundVar{phi})\;(\HOLConst{ST}\;\HOLBoundVar{x}\;\HOLBoundVar{psi}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{x}\;\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{ST}\;\HOLBoundVar{x}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{phi})\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLConst{fEXISTS}\;(\HOLBoundVar{x}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{fAND}\;(\HOLConst{fR}\;(\HOLConst{fV}\;\HOLBoundVar{x})\;(\HOLConst{fV}\;(\HOLBoundVar{x}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})))\;(\HOLConst{ST}\;(\HOLBoundVar{x}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})\;\HOLBoundVar{phi}))
\end{holmath}

Here \HOLinline{\HOLTokenLambda{}\HOLBoundVar{p}\;\HOLBoundVar{t}.\;\HOLConst{fP}\;\HOLBoundVar{p}\;\HOLBoundVar{t}} is the abbrevation of \HOLinline{\HOLTokenLambda{}\HOLBoundVar{p}\;\HOLBoundVar{t}.\;\HOLConst{fP}\;\HOLBoundVar{p}\;\HOLBoundVar{t}}, and \HOLinline{\HOLTokenLambda{}\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}.\;\HOLConst{fR}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}} is the abbrevation of \HOLinline{\HOLTokenLambda{}\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}.\;\HOLConst{fR}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}}. Any formula obtained by standard translation only has one free variable $x$, and a standard translation can never have function symbols:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FV}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLFreeVar{f})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{x}\HOLTokenRightbrace{}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{form_functions}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLFreeVar{f})\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}
\end{holmath}

We can conjunct standard tranalations to get a standard translation. And the negation of standard translation is again a standard translation:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{x}.\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{phi}.\;\HOLBoundVar{f}\;\HOLSymConst{=}\;\HOLConst{ST}\;\HOLBoundVar{x}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{cf}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{cf}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{f}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{psi}.\;\HOLBoundVar{cf}\;\HOLSymConst{=}\;\HOLConst{ST}\;\HOLBoundVar{x}\;\HOLBoundVar{psi}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ST}\;\HOLFreeVar{x}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{f})\;\HOLSymConst{=}\;\HOLConst{fNOT}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLFreeVar{f})
\end{holmath}



Standard translation defined like this can be regarded as a first-order reformulation of modal satisfication, since we have the precise correspondence of modal satisfication and first-order satisfication for standard translations. A modal formula is satisfied a point $w$ in a modal model iff its standrad translation at $x$ is satisfied at the same modal viewed as a first order model when $x$ is valuated to $w$:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{IMAGE}\;\HOLFreeVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{x})\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{fsatis}\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{\ensuremath{\sigma}}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLFreeVar{phi}))
\end{holmath}

Hence we say the current definition of standard translation makes good semantical sense, but it has syntactical deficiency. The formula \HOLinline{\HOLSymConst{\ensuremath{\Diamond}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{f})} with $a_1$ marking its state is translated to $\exists a_2(R a_1 a_2\land\exists a_3(Ra_2a_3 \land ST_{a_3}(f)))$, it uses three variables $a_1,a_2$ and $a_3$, which is unnecessary: the formula above is equivalent to $\exists a_2(R a_1 a_2\land\exists a_1(Ra_2a_1\land ST_{a_1}(f)))$. With this observation, we conclude that we do not need to always come up with a variable symbol for each \HOLinline{\HOLSymConst{\ensuremath{\Diamond}}}, instead, we can use only two variable symbols alternating in each layer. As a consequence, we can redefine standard translation as follows:

\begin{holmath}
  \HOLConst{ST_alt}\;\HOLFreeVar{x}\;(\HOLConst{VAR}\;\HOLFreeVar{p})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{fP}\;\HOLFreeVar{p}\;(\HOLConst{fV}\;\HOLFreeVar{x})\\
\HOLConst{ST_alt}\;\HOLFreeVar{x}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{fFALSE}\\
\HOLConst{ST_alt}\;\HOLFreeVar{x}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{phi})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{fNOT}\;(\HOLConst{ST_alt}\;\HOLFreeVar{x}\;\HOLFreeVar{phi})\\
\HOLConst{ST_alt}\;\HOLFreeVar{x}\;(\HOLConst{DISJ}\;\HOLFreeVar{phi}\;\HOLFreeVar{psi})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{fDISJ}\;(\HOLConst{ST_alt}\;\HOLFreeVar{x}\;\HOLFreeVar{phi})\;(\HOLConst{ST_alt}\;\HOLFreeVar{x}\;\HOLFreeVar{psi})\\
\HOLConst{ST_alt}\;\HOLFreeVar{x}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{phi})\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{fEXISTS}\;(\HOLNumLit{1}\;\HOLSymConst{\ensuremath{-}}\;\HOLFreeVar{x})\\
\;\;\;\;(\HOLConst{fAND}\;(\HOLConst{fR}\;(\HOLConst{fV}\;\HOLFreeVar{x})\;(\HOLConst{fV}\;(\HOLNumLit{1}\;\HOLSymConst{\ensuremath{-}}\;\HOLFreeVar{x})))\;(\HOLConst{ST_alt}\;(\HOLNumLit{1}\;\HOLSymConst{\ensuremath{-}}\;\HOLFreeVar{x})\;\HOLFreeVar{phi}))
\end{holmath}

(prove only two variables?)

Note that the above definition is designed to only use $0$ or $1$ as the $x$. It is evident from the follow proposition that our new definition of translation is equally nice from the semantical aspect as the former one:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{IMAGE}\;\HOLFreeVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLNumLit{1})\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\HOLConst{fsatis}\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{\ensuremath{\sigma}}\;(\HOLConst{ST_alt}\;\HOLNumLit{1}\;\HOLFreeVar{phi}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLNumLit{0})\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\HOLConst{fsatis}\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{\ensuremath{\sigma}}\;(\HOLConst{ST_alt}\;\HOLNumLit{0}\;\HOLFreeVar{phi}))
\end{holmath}

By conclusion, every modal formula is equivalent to a first order formula containing only two variables.

\subsection{Modal Saturation via ultrafilter extensions}

In the second chapter, we have seen bisimilarity implies modal equivalence, but only proved the converse for image finite models. In this section, we are interested in another particular class of models which modal equivalence implies bisimilarity, which is the class of m-saturated models. 

A set of formulas \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} is called satisfiable in a set of worlds $X$ of a model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} if there exists a world in $X$ such that all the formulas in \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} are satisfied, and is called finitely satisfiable if any finite subset of \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} is satisfiable:

\begin{holmath}
  \HOLConst{satisfiable_in}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{X}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{x}.\;\HOLBoundVar{x}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\phi}}.\;\HOLBoundVar{\ensuremath{\phi}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{x}\;\HOLBoundVar{\ensuremath{\phi}}
  \HOLConst{fin_satisfiable_in}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLFreeVar{X}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{S}.\;\HOLBoundVar{S}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\Sigma}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FINITE}\;\HOLBoundVar{S}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satisfiable_in}\;\HOLBoundVar{S}\;\HOLFreeVar{X}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}
\end{holmath}

A model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is called m-saturated if for each \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and any set \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} of formulas, if \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} is finitely satisfiable in the set of successors of $w$, then it is satisfiable in the set of successors of $w$. 

\begin{holmath}
  \HOLConst{M_sat}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\Sigma}}.\\
\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLConst{fin_satisfiable_in}\;\HOLBoundVar{\ensuremath{\Sigma}}\\
\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{v}\;\HOLTokenBar{}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\HOLTokenRightbrace{}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLConst{satisfiable_in}\;\HOLBoundVar{\ensuremath{\Sigma}}\\
\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{v}\;\HOLTokenBar{}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\HOLTokenRightbrace{}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}
\end{holmath}

In fact, a class of model where modal equivalence implies bisimilarity has a name, it is called a Hennessy-Milner class. If we want to formalise the definition of Hennessy-Milner class in the HOL, we could write:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{HM_class}\;\HOLFreeVar{K}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w}\;\HOLBoundVar{w\sp{\prime}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{K}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{K}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{modal_eq}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w}\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{bisim_world}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w}\;\HOLBoundVar{w\sp{\prime}}
\end{holmath} 
  
But in fact, such a definition is useless, since we are not allowed to have a `class' in the HOL, we can only have set, and any set is only allowed to have elements of the same type. Hence if we use this definition, we will only be allowed to talk about bisimulations between models with the same type. As a consequence, we do not make usage of this definition in the following formalisation of the proposition which says the class of m-saturation has the Hennessy-Milner property, instead, we state it as:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{M_sat}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{M_sat}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{bisim_world}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}
\end{holmath}

\begin{proof}
Let \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} be $(\alpha,\beta),(\alpha,\gamma)$ models respectively. Under the assumptions, the bisimulation relation is given by \HOLinline{\HOLTokenLambda{}\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{n\sb{\mathrm{2}}}.\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\phi}}.\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{n\sb{\mathrm{1}}}\;\HOLBoundVar{\ensuremath{\phi}}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{n\sb{\mathrm{2}}}\;\HOLBoundVar{\ensuremath{\phi}}}. To only non-trivial clause of being a bisimulation to check is that for worlds $w,v$ of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and world $w'$ of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} such that \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{w}\;\HOLFreeVar{v}} and $w$ and $w'$ are modal equivalent, we can find a world $v'$ of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} such that \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{w\sp{\prime}}\;\HOLFreeVar{v\sp{\prime}}} and $v$ and $v'$ are modal equivalent. 

Let \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} denote the set of formulas satisfied by $v$, it suffices to find a successor of $w'$ that realises \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}}. As \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} is m-saturated, it suffices to prove each finite subset $\Delta\subseteq \Sigma$ is satisfied in some successor of $w'$. Take such a $\Delta$, then it is satisfied at $v$. As $\Delta$ is finite, we can prove that there exists a formula $ff$ such that for all $(\alpha,\beta)$-models, $ff$ is satisfied at a world if and only if all elements in $\Delta$ are satisfied:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{ff}.\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{ff}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{f})
\end{holmath}

We have \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{v}\;\HOLFreeVar{ff}}, and therefore \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{ff})}. By modal equivalence of $w$ and $w'$, we then get \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w\sp{\prime}}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{ff})}, so there exists a successor of $w'$ that satisfies $ff$. 

But it is not what we want! Instead, we need a successor of $w'$ which satisfies all elements in $\Sigma$, but we cannot get it if we just use the lemma above, since the equivalence of the set of formulas and its big conjunction we proved only works for $(\alpha,\beta)$ models, but we are in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} which is an $(\alpha,\gamma)$-model. By embedding any arbitary model into a common infinite type, it may possible to prove that under some condition on universe, if a big conjunction works for a model of one type, then it works for any other types. But it is way too complicated and will involve an ugly assumption. The key observation is that what we need is no more than a big conjunction formula that simutinously works for two distinct types. Therefore, it suffices to prove:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{ff}.\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{ff}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{f}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{ff}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{f})
\end{holmath}

This lemma works perfectly, so we will not get stuck at the former point and we are done with the proof.
\end{proof}

Since m-saturated models are nice, here is a natural question: How can we get such models. It turns out that every models can give arise to a m-saturated model, by taking its ultrafilter extension. In order to talk about ultrafilter extesnions, we need to build a theory of ultrafilers in HOL.

\subsection{Interlude II: Ultrafilters}

As its name suggests, an ultrafilter is a special kind of filter. Given a non-empty set $W$, a set $F$ which is a subset of the power set of $W$, written as $POW(W)$ in the HOL, is called a filter if it contains $W$ itself, closed under binary intersection, and closed upward.

\begin{holmath}
  \HOLConst{filter}\;\HOLFreeVar{FLT}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{FLT}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLConst{POW}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FLT}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{X}\;\HOLBoundVar{Y}.\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FLT}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{Y}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FLT}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLBoundVar{Y}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FLT})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{X}\;\HOLBoundVar{Z}.\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FLT}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{Z}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{Z}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{Z}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FLT}
\end{holmath}

By induction, closure under binary intersection implies that a filter is closed under finite intersection.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{U}\;\HOLBoundVar{W}.\;\HOLConst{filter}\;\HOLBoundVar{U}\;\HOLBoundVar{W}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{U}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{BIGINTER}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{U}
\end{holmath}

Obviously for any set $W$, $POW(W)$ is a filter on $W$. By upward closure, any filter which contains the empty set must be $POW(W)$.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{filter}\;(\HOLConst{POW}\;\HOLFreeVar{W})\;\HOLFreeVar{W}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{filter}\;\HOLFreeVar{U}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{U}\;\HOLSymConst{=}\;\HOLConst{POW}\;\HOLFreeVar{W}
\end{holmath}

But $POW(W)$ is very boring as a filter, we are mainly interested in filters which are not the whole power set, these filters are called proper filer:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{proper_filter}\;\HOLFreeVar{FLT}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{filter}\;\HOLFreeVar{FLT}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{FLT}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLConst{POW}\;\HOLFreeVar{W}
\end{holmath}

If we have a set proper filters such that for any two members $A,B$ of it, either $A\subset B$ or $B\subseteq A$, the union of this set is a proper filter.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{A}.\;\HOLBoundVar{A}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{proper_filter}\;\HOLBoundVar{A}\;\HOLFreeVar{W})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{A}\;\HOLBoundVar{B}.\;\HOLBoundVar{A}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{B}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{A}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{B}\;\HOLSymConst{\HOLTokenDisj{}}\;\HOLBoundVar{B}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{A})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{proper_filter}\;(\HOLConst{BIGUNION}\;\HOLFreeVar{U})\;\HOLFreeVar{W}
\end{holmath}

Another important kind of filter is the generated filter. For $W\ne \emptyset$ and $F_0\subseteq POW(W)$, the generated filter is the minimal filter on $W$ containing $F_0$.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{generated_filter}\;\HOLFreeVar{E}\;\HOLFreeVar{W}\;\HOLSymConst{=}\;\HOLConst{BIGINTER}\;\HOLTokenLeftbrace{}\HOLBoundVar{G}\;\HOLTokenBar{}\;\HOLFreeVar{E}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{G}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{filter}\;\HOLBoundVar{G}\;\HOLFreeVar{W}\HOLTokenRightbrace{}
\end{holmath}

The advantage of the above definition is that we get the fact that a generated filter is indeed a filter for free.

But sometimes we want to explicitly talk about elements in generated filter, then we can just spell out the its construction: We put any subset $W$ that contains a finite intersection of elements in $F$ in the generated filter of $F$, such subsets are precisely the ones that are required by the definition. We can prove generated filter is indeed a filter under this definition:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{F}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLConst{POW}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{filter}\\
\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{X}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;(\HOLBoundVar{X}\;\HOLSymConst{=}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenDisj{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{S}.\;\HOLBoundVar{S}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{F}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FINITE}\;\HOLBoundVar{S}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{S}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{BIGINTER}\;\HOLBoundVar{S}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{X})\HOLTokenRightbrace{}\\
\;\;\;\;\;\;\;\HOLFreeVar{W}
\end{holmath}

%modify the theorem to remove extra?

%prove all the three definitions agree?

For any element $w\in W$, the set of all the subset containing $w$ forms a filter, it is called the principle filter generated by $w$. In fact, principle filters are filter generated by singletons.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{W}\;\HOLSymConst{=}\;\HOLTokenLeftbrace{}\HOLBoundVar{X}\;\HOLTokenBar{}\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{X}\HOLTokenRightbrace{}
\end{holmath}

 An ultrafilter on a set $W$ is a proper filter $F$ such that for any $S\subseteq W$, either $S$ or $W/S$ is in $F$, but not both.

\begin{holmath}
  \HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{proper_filter}\;\HOLFreeVar{U}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{X}.\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{POW}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLFreeVar{W}\;\HOLConst{DIFF}\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenNotIn{}}\;\HOLFreeVar{U})
\end{holmath}

Principle filters are examples of the type of filters of our main interest, that is, the ultrafilters. 

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{ultrafilter}\;(\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{W})\;\HOLFreeVar{W}
\end{holmath}

Since ultrafilter are important, we may ask when can we get an ultrafilter on $W$ from a subset of $POW(W)$. We will prove later that the answer is for any subset of $POW(W)$ with finite intersection property, we can extend it into an ultrafilter. A subset of $POW(W)$ has finite intersection property if it is closed under finite intersection:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FIP}\;\HOLFreeVar{S}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\HOLFreeVar{S}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLConst{POW}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{S\sp{\prime}}.\;\HOLBoundVar{S\sp{\prime}}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{S}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FINITE}\;\HOLBoundVar{S\sp{\prime}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{S\sp{\prime}}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{BIGINTER}\;\HOLBoundVar{S\sp{\prime}}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}
\end{holmath}

Any proper filter $U$ has the finite intersection property. Moreover, for $B\subseteq W$ such that neither $B$ nor $W/B$ is in $U$, then inserting $B$ to $U$ does not destory the finite intersection property of $U$.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{proper_filter}\;\HOLFreeVar{U}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{FIP}\;\HOLFreeVar{U}\;\HOLFreeVar{W}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{proper_filter}\;\HOLFreeVar{U}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{B}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{POW}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{B}\;\HOLSymConst{\HOLTokenNotIn{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{W}\;\HOLConst{DIFF}\;\HOLFreeVar{B}\;\HOLSymConst{\HOLTokenNotIn{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{FIP}\;(\HOLTokenLeftbrace{}\HOLFreeVar{B}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLFreeVar{U})\;\HOLFreeVar{W}
\end{holmath}

Proof: \texttt{proper_filter_FIP} is immediate from closure under finite intersection. We prove \texttt{proper_filter_INSERT_FIP}. Take a finite subset $S\subseteq \{B\}\cup U$, if $B\notin S$, then we are done by \texttt{proper_filter_FIP}. Otherwise, if we have $\bigcap S = B \cap (\bigcap U')$ for some finite $U'\subseteq U$, which implies $\bigcap U'\subseteq W/ B$, hence $W/B\in U$ by upward closure, contradicting the assumption that $W/B\notin U$.

Towards the goal of extending a set with finite intersection property, we firstly prove that such sets can be extended into a proper filter.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FIP}\;\HOLFreeVar{S}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{V}.\;\HOLConst{proper_filter}\;\HOLBoundVar{V}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{S}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{V}
\end{holmath}

Proof: The desired proper filter is given by the generated filter of $S$, checking its property is straightfoward.

A proper filter which is not properly contained by any proper filter is called a maximal filter.
We can readily check ultrafilters are maximal. With the last two lemmas about finite intersection property, we can prove maximal filters are ultrafilters, so maximal filters and ultrafilters turns out to be the same thing.
% add a lemma about iff?
\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{proper_filter}\;\HOLFreeVar{U}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{S}.\;\HOLConst{filter}\;\HOLBoundVar{S}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenPSubset}\;\HOLBoundVar{S}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{S}\;\HOLSymConst{=}\;\HOLConst{POW}\;\HOLFreeVar{W})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{W}
\end{holmath}

Proof: If a maximal filter $U$ on $W$ is not an ultrafilter, then for some $A$, either $A\in U\land W/A\in U$ or $A\notin U\land W/A\notin U$. In the first case we have $\emptyset\in U$, contradicts the properness of maximal filter. In the second case, by \texttt{proper_filter_INSERT_FIP}, the set $U\cup \{A\}$ has the finite intersection property, hence extends to a proper filter $U'$ by \texttt{FIP_PSUBSET_proper_filter}. But then $U$ is properly contained in $U'$, contradicts the maximality of $U$. This completes the proof. 

Together with the Zorn's lemma which is already in the HOL library, now we have all ingredients of the proof of ultrafilter.
%talk about Zorn's lemma in the HOL?

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{proper_filter}\;\HOLFreeVar{f}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{U}.\;\HOLConst{ultrafilter}\;\HOLBoundVar{U}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{U}
\end{holmath}

Proof:Given a property filter $F$, we will find out a ultrafilter containing it. Consider the set $S$ of all the proper filters containing $F$, ordered by inclusion, we will apply Zorn's lemma on $S$. The Zorn's lemma in the HOL looks like:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{partial_order}\;\HOLFreeVar{r}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{t}.\;\HOLConst{chain}\;\HOLBoundVar{t}\;\HOLFreeVar{r}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{upper_bounds}\;\HOLBoundVar{t}\;\HOLFreeVar{r}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{x}.\;\HOLBoundVar{x}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{maximal_elements}\;\HOLFreeVar{s}\;\HOLFreeVar{r}
\end{holmath}

Here $s$ is a set, $r$ is a relation that takes a pair of elements $(a,b)$ with $a,b\in s$ and return the truth value whether $a$ and $b$ are related. For a set $t$ with the same type as $s$, we have \HOLinline{\HOLConst{chain}\;\HOLFreeVar{t}\;\HOLFreeVar{r}} if for any $a,b\in t$, we have either $(a,b)\in r$ or $(b,a)\in r$. Here our $s$ is the set $S$ defined above. $r$ is defined by inclusion. For $A,B\in S$, $(A,B)\in r$ iff $A\subseteq B$, so a chain $T$ on $S$ is a subset of $S$ such that $A\subseteq B$ or $B\subseteq A$ for any $A,B\in T$.

The thing to check is that any chain $T$ on $S$ has an upper bound. If the chain is empty, then the upper bound is clearly $F$. Otherwise, we claim the union of the chain is the upper bound. To prove the claim, it amounts to check:

\begin{itemize}
  \item $\bigcup T$ is a proper filer containing $F$.
  \item Any element in $T$ is a subset of $\bigcup T$.
\end{itemize}
  The second item is trivial, the first one is by \texttt{UNION_proper_proper}.

Applying the Zorn's lemma gives a proper filter $X\in S$ which is an maximal element of $S$, it suffices to prove $X$ is an ultrafilter. The fact that $X$ is the maximal element of $S$ proves $X$ is a maximal filter, hence we are done by \texttt{maximal_ultrafilter}.

As a corollary, we can extend any set with finite intersection into an ultrafilter:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FIP}\;\HOLFreeVar{s}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{u}.\;\HOLConst{ultrafilter}\;\HOLBoundVar{u}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{u}
\end{holmath}

Proof: For $S\subseteq POW(W)$ with finite intersection property, by \texttt{FIP_PSUBSET_proper_filter}, we have a proper filter $P$ containing $S$, and $P$ extends to an ultrafiler $S\subseteq P\subseteq U$ by \texttt{ultrafilter_theorem}.

%A special kind of ultrafilters, called countably incomplete ultrafilters, will play an important role in our discussion about ultraproducts in the next interlude, so we also give some basics about countably incomplete ultrafilters here. Firstly, the definition is:

As an application of \texttt{ultrafilter_theorem_corollary}, we prove the existence of countably incomplete ultrafilters. A countably incomplete ultrafilter is an ultrafilter which is not closed under countably infinite intersection.

\begin{holmath}
  \HOLConst{countably_incomplete}\;\HOLFreeVar{U}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{W}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{IFS}\;\HOLBoundVar{f}.\;\HOLBoundVar{IFS}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{BIJ}\;\HOLBoundVar{f}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLBoundVar{IFS}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{BIGINTER}\;\HOLBoundVar{IFS}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}
\end{holmath}

It is not hard to see any ultrafilter $U$ on the natural numbers $\mathbb N$ which does not contain any singleton is countably incomplete, since the countable intersection of the sets $\mathbb N/\{n\}$ which are members of $U$ yields the empty set.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLTokenLeftbrace{}\HOLBoundVar{n}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenNotIn{}}\;\HOLFreeVar{U})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{countably_incomplete}\;\HOLFreeVar{U}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})
\end{holmath}

We find out an ultrafilter on $\mathbb N$ which does not contain any singleton, we will done if we can prove the existence of an ultrafilter on $\mathbb N$ which does not contain any finite set. By \texttt{ultrafilter_theorem_corollary}, it suffices to prove:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FIP}\;\HOLTokenLeftbrace{}\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLConst{DIFF}\;\HOLBoundVar{X}\;\HOLTokenBar{}\;\HOLConst{FINITE}\;\HOLBoundVar{X}\HOLTokenRightbrace{}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})
\end{holmath}

Proof: By unfolding the definition of finite intersection property and induct on finiteness of the set we are intersecting.

A countably incomplete ultrafilter has useful features, one of them is that such an ultrafilter $U$ has a chain $I=I_0\supseteq I_1\supseteq I_2\supseteq\cdots$ such that each $I_i$ is in $U$, and $\bigcap_{n\in \mathbb N}I_n=\emptyset$.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{countably_incomplete}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{In}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{In}\;\HOLNumLit{0}\;\HOLSymConst{=}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLBoundVar{In}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{In}\;(\HOLBoundVar{n}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{In}\;\HOLBoundVar{n})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{BIGINTER}\;\HOLTokenLeftbrace{}\HOLBoundVar{In}\;\HOLBoundVar{n}\;\HOLTokenBar{}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\HOLTokenRightbrace{}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}
\end{holmath}

Proof: By definition of countably incompleteness, there exists a family $X_n$ in $U$ indexed by natural numbers such that $\bigcap_{n\in \mathbb N}X_n=\emptyset$. Define $J_n:=\bigcap_{m\le n}X_n$, so $J_{n+1}\supseteq J_n$ for all $n\in\mathbb N$, and moreover $\bigcap_{n\in \mathbb N}I_n=\emptyset$. In the HOL, the family $J_n$ is defined using a primitive recursive function, defined by \HOLinline{\HOLConst{PRIM_REC}\;(\HOLFreeVar{X}\;\HOLNumLit{0})\;(\HOLTokenLambda{}\HOLBoundVar{Xn}\;\HOLBoundVar{n}.\;\HOLBoundVar{Xn}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{X}\;(\HOLBoundVar{n}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1}))}. We get the desired chain $I_n$ by inserting $I$ at the begining of $J_n$.

 
Our theory of ultrafilters built above is to enable us to talk about ultrafilter extensions. Ultrafilter extension is defined as a function that takes a model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, and give the extended model. The world set of \HOLinline{\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is the set of all the ultrafilters on the world set of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}. And the relation of these worlds requires some explaination. For \HOLinline{\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}, there comes two interesting sets of worlds, one is the set of worlds that is linked to some world in $X$, and the other one is the set of worlds that are only linked to worlds in $X$. These two sets are dual to each other:

\begin{holmath}
  \HOLConst{can_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{w}\;\HOLTokenBar{}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{x}.\;\HOLBoundVar{x}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{x}\HOLTokenRightbrace{}
  \HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{w}\;\HOLTokenBar{}\\
\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{x}.\;\HOLBoundVar{x}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{x}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{x}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{X}\HOLTokenRightbrace{}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{can_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{X}\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLConst{DIFF}\;\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;(\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLConst{DIFF}\;\HOLFreeVar{X})
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{X}\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLConst{DIFF}\;\HOLConst{can_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;(\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLConst{DIFF}\;\HOLFreeVar{X})
\end{holmath}

Directly from their definitions, the worlds satisfying \HOLinline{\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{phi}} are the worlds that can see a world satisfying $\phi$. And the worlds satisfying \HOLinline{\HOLSymConst{\ensuremath{\Box}}\;\HOLFreeVar{phi}} are the worlds that can only see worlds that satisfies $\phi$, and the set of worlds which only see $X\cap Y$ is the intersection of worlds only see $X$ and worlds only see $Y$:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLTokenLeftbrace{}\HOLBoundVar{w}\;\HOLTokenBar{}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{\ensuremath{\phi}})\HOLTokenRightbrace{}\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\HOLConst{can_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLTokenLeftbrace{}\HOLBoundVar{v}\;\HOLTokenBar{}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{v}\;\HOLFreeVar{\ensuremath{\phi}}\HOLTokenRightbrace{}
  \ensuremath{\HOLTokenTurnstile}\HOLTokenLeftbrace{}\HOLBoundVar{w}\;\HOLTokenBar{}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;(\HOLSymConst{\ensuremath{\Box}}\;\HOLFreeVar{\ensuremath{\phi}})\HOLTokenRightbrace{}\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLTokenLeftbrace{}\HOLBoundVar{v}\;\HOLTokenBar{}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{v}\;\HOLFreeVar{\ensuremath{\phi}}\HOLTokenRightbrace{}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;(\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{Y})\;\HOLSymConst{=}\;\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{X}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{Y}
\end{holmath}



We define two ultrafilter $u,v$ to be related if any world set of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} in $v$ can only see world sets in $u$. Such a definition has a reformulation: for any world set of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, if the set of worlds that it can only see is in $u$, then this set is in $v$:

\begin{holmath}
  \HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{u}\;\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{ultrafilter}\;\HOLFreeVar{u}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{ultrafilter}\;\HOLFreeVar{v}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{X}.\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{can_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{X}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{u}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{u}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{ultrafilter}\;\HOLFreeVar{v}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{u}\;\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{Y}\;\HOLTokenBar{}\;\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{Y}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{u}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{Y}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{v})
\end{holmath}

The ultrafilter extension is defined as follows:

\begin{holmath}
  \HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{frame}\;:=\\
\;\;\;\;\HOLTokenLeftrec{}\HOLFieldName{world}\;:=\;\HOLTokenLeftbrace{}\HOLBoundVar{u}\;\HOLTokenBar{}\;\HOLConst{ultrafilter}\;\HOLBoundVar{u}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\HOLTokenRightbrace{};\\
\;\;\;\;\;\;\HOLFieldName{rel}\;:=\;\HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\HOLTokenRightrec{};\\
\;\;\HOLFieldName{valt}\;:=\\
\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{p}\;\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{ultrafilter}\;\HOLBoundVar{v}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{p}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{v})\HOLTokenRightrec{}
\end{holmath}

The ultrafilter extension also changes the type of model, namely, it change the type of world set from $\beta$ to $(\beta\to bool)\to bool$, it is indeed an extension, in the sense that \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is embedded in \HOLinline{\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}} by the function sending \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} to the principle ultrafilter \HOLinline{\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} generated by $w$. In general, this embedding does not necessarily give a generated submodel, nevertheless, we have an invariance result for this embedding:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{w}\;(\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world})
\end{holmath}

This is actually a special case of the following proposition, where $u$ is taken as \HOLinline{\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}. This proposition captures the idea that ultrafilters are used to describe the sense of `most of', where the sets in the ultrafilters can be regarded as `sets which are large enough'. From this aspect, the proposition says that a formula $\phi$ is satisfied in an ultrafilter $u$ iff $\phi$ is satisfied at most of worlds in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, where the sense of `most of' is measured by $u$.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{u}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLTokenLeftbrace{}\HOLBoundVar{w}\;\HOLTokenBar{}\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{phi}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{u}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{u}\;\HOLFreeVar{phi})
\end{holmath}

Proof:
By induction on \HOLinline{\HOLFreeVar{phi}}. Everything except for the diamond case is by unwinding the definitions of \HOLinline{\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and ultrafilter. We only give the proof of the diamond case. 

From right to left: Suppose \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{u}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{phi})}, then \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{u\sp{\prime}}\;\HOLFreeVar{psi}} for some \HOLinline{\HOLFreeVar{UE\HOLTokenUnderscore{}REL}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{u}\;\HOLFreeVar{u\sp{\prime}}}. By inductive hypothesis, \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{u\sp{\prime}}\;\HOLFreeVar{phi}} implies $\{w\mid w \in M.frame.world\land satis \ M \ w \ phi\}\in u'$. And then by definition of \HOLinline{\HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, this implies \HOLinline{\HOLConst{can_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}} $\{w\mid w \in M.frame.world\land satis \ M \ w \ phi\}\in u$. But this set is exactly the set $\{w | w \in M.frame.world \land satis\ M\ w\ (\Diamond \phi)\}$ by the observation in \texttt{valt_can_see}.

From left to right: Suppose  $\{w | w \in M.frame.world \land satis\ M\ w\ (\Diamond \phi)\}\in u$, we need to find out an ultrafilter $u'$ such that \HOLinline{\HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{u}\;\HOLFreeVar{u\sp{\prime}}} and \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{u\sp{\prime}}\;\HOLFreeVar{phi}}. Using \texttt{exercise_2_5_5}, \HOLinline{\HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{u}\;\HOLFreeVar{u\sp{\prime}}} is equivalent to $s:=\{Y\mid only\_see(Y)\in u\land Y\subseteq M.frame.world\}\subseteq u'$. We prove $s\cup\{w\mid  w \in M.frame.world\land satis \ M \ w \ phi\}$ has finite intersection property. It suffices to check (1) $s$ is closed under intersection, and (2) The interesection of any element in $s$ with $\{w\mid  w \in M.frame.world\land satis \ M \ w \ phi\}$ is non-empty. 

For (1), if $a,b\in s$, then both \HOLinline{\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{a}} and \HOLinline{\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{b}} are in $u$, and hence there intersection. By \texttt{only_see_INTER}, \HOLinline{\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{a}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{b}\;\HOLSymConst{=}\;\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;(\HOLFreeVar{a}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{b})}, hence $a\cap b\in u$.

For (2), let $Y\in s$, then \HOLinline{\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{Y}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{u}}, as also $\{w | w \in M.frame.world \land satis\ M\ w\ (\Diamond \phi)\}\in u$, by closure under intersection for an ultrafilter, $only\_see(Y)\cap \{w | w \in M.frame.world \land satis\ M\ w\ (\Diamond \phi)\}\ne \emptyset$, we obtaine an element of $Y\cap \{w\mid  w \in M.frame.world\land satis \ M \ w \ phi\}$ from any element $x$ of it. As $x\in \{w | w \in M.frame.world \land satis\ M\ w\ (\Diamond \phi)\}$, there exists \HOLinline{\HOLFreeVar{y}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} such that \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{y}\;\HOLFreeVar{phi}}, as $x\in only\_see(Y)$, we have $y\in Y$.

The rest of the proof of finite intersection property is done by induction. Hence by \texttt{ultrafilter_theorem_corollary}, there exists an ultrafilter $u'$ such that $s\cup\{w\mid  w \in M.frame.world\land satis \ M \ w \ phi\}\subseteq u'$. This is the $u'$ we want: We have \HOLinline{\HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{u}\;\HOLFreeVar{u\sp{\prime}}} since $\{Y\mid only\_see(Y)\in u\}=s\subseteq u'$, and $\{w\mid w \in M.frame.world\land satis \ M \ w \ phi\}\in u'$, we get \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{u\sp{\prime}}\;\HOLFreeVar{phi}} by inductive hypothesis.

The above proposition leads to a proof of m-saturatedness of ultrafilter extensions.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{M_sat}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})
\end{holmath}

Proof:
Suppose \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} is a set of formulas which is finitely satisfiable in the set of successors of a world \HOLinline{\HOLFreeVar{u}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}).\HOLFieldName{frame}.\HOLFieldName{world}}, we need to find a world \HOLinline{\HOLFreeVar{u\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}).\HOLFieldName{frame}.\HOLFieldName{world}} such that \HOLinline{\HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{u}\;\HOLFreeVar{u\sp{\prime}}} and \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{u\sp{\prime}}\;\HOLFreeVar{phi}} for all \HOLinline{\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}}. By \texttt{exercise_2_5_5} and \texttt{prop_2_59_i}, it amounts to find an ultrafilter $u'$ on \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} such that $\{Y\mid only\_see(Y)\in u\}\subseteq u'$ and $\{w\mid w \in M.frame.world\land satis \ M \ w \ phi\}\in u'$ for all \HOLinline{\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}}.

Consider the set $\Delta:= \{\{w\mid w \in M.frame.world \land \forall \phi.\phi\in s\implies satis \ M \ w\ \phi\}\mid FINITE \ s \land s\subseteq \Sigma\}\cup \{Y\mid only\_see\ M \ Y \in w\land Y\subseteq M.frame.world\}$. Similar as in the proof of \texttt{prop_2_59_i}, we check $\Delta$ has the finite intersection property. The only nontrivial thing to check is that for $a\in \{\{w\mid w \in M.frame.world \land \forall \phi.\phi\in s\implies satis \ M \ w\ \phi\}\mid FINITE \ s \land s\subseteq \Sigma\}$ and $b\in \{Y\mid only\_see\ M \ Y \in w\land Y\subseteq M.frame.world\}$, we have $a\cap b\ne\emptyset$.

Suppose $s \subseteq\Sigma$ is finite, and $b$ is a set of worlds in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} such that \HOLinline{\HOLConst{only_see}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{b}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{u}}, we show $\{w\mid w \in M.frame.world \land \forall\phi.\phi\in s\implies satis \ M \ w \phi\}\cap b\ne\emptyset$. Recall \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} is finitely satisfiable in the set of successors of $u$, we have a world $u''$ such that \HOLinline{\HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{u}\;\HOLFreeVar{u\sp{\prime\prime}}} and \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{u\sp{\prime\prime}}\;\HOLFreeVar{phi}} for all $\phi \in s$, in other worlds, $\{w\mid w \in M.frame.world\land satis \ M \ w \ phi\}\in u''$ for all $\phi\in s$. Then $\{w\mid w \in M.frame.world \land \forall\phi.\phi\in s\implies satis \ M \ w \phi\}\cap b\ne\emptyset$ is a big intersection of sets in $u''$, and hence is in $u''$. By \texttt{exercise_2_5_5} again, \HOLinline{\HOLConst{UE_rel}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{u}\;\HOLFreeVar{u\sp{\prime\prime}}} gives $\{Y\mid only\_see (Y)\in u\land Y\subseteq M.frame.world\}\subseteq u''$, so $b\in u''$ as well. As two elements in $u''$ has nonempty intersection, we are done.

Hence by \texttt{ultrafilter_theorem_corollary}, there exists an ultrafilter $u'$ contains $\Delta$, it is trivial to check $u'$ is what we want.


Finally, as claimed at the begining of this chapter, we arrive at the characterisation of modal equivalence as bisimilarity somewhere else:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\HOLConst{bisim_world}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}})\\
\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world})\\
\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{principle_UF}\;\HOLFreeVar{w\sp{\prime}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}))
\end{holmath}

Proof:Bisimulation implies modal equivalence by \texttt{thm_2_20}. For the reverse direction, if \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}} are modal equivalence, then \HOLinline{\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}).\HOLFieldName{frame}.\HOLFieldName{world}} is modal equivalent to \HOLinline{\HOLConst{principle_UF}\;\HOLFreeVar{w\sp{\prime}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}).\HOLFieldName{frame}.\HOLFieldName{world}}. As \HOLinline{\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} are m-saturated by \texttt{prop_2_61}, the result follows by \texttt{prop_2_54_DIST_TYPE}.

\section{Invariant under bisimulations and simulations}

In this chapter, we prove two characterisation results, they are related to the concepts `invariant under bisimulations' and `preserved by simulations' respectively. This whole chapter realies highly on first order logic, and we will swap between  modal models and first order models very frequently. Hence when we talk about first order models, we restrict our scope to the ones which contains the same amount of information as a modal model. And only talk about first order formulas which makes sense to such models. So when we say `a first order formula' in this chapter, we secretly refer to a first order formula with no function symbols and only have unary predicate symbols and only one binary predicate symbol.

\subsection{Standard translations vs invariant under bisimulations}

In the last chapter, we see the correspondence between modal formulas and first order formulas, and get known to the fact that every modal formula is equivalent to a first order formula. But actually, standard translation is really a small fragment of modal formulas. Even in our restricted scope, there are many first order formulas which is not equivalent to the standard translation of any formulas. Here we ask: What are the first order formulas which are equivalent to some standard translation? This section is to answer this question. 

The short answer to our question is that a first order is that a first order formula is equivalent to a modal formula iff it is invariant under bisimulations. A first order formula $\alpha(x)$ with at most one free variable $x$ is invarient for bisimulations if for all models \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{N}}, with \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{N}.\HOLFieldName{frame}.\HOLFieldName{world}}, if $w$ and $v$ are bisimilar, then $\alpha(x)$ holds in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} with $x$ sends to $w$ iff it holds in \HOLinline{\HOLFreeVar{N}} with $x$ sends to $v$. 

When we see a formula is invariant under bisimulation, we allow \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{N}} to be models of any type, and the type of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{N}} do not need to be identical. However, just like the issue we have seen when we defined \HOLinline{\HOLConst{equiv0}}, we are not allowed to have new type variables in only the right hand side of a definition. Thus in the HOL, we are not allowed to talk about invariance for bisimulation for any type of models, and have to refer to the type of models which are linked by the bisimulation, the definition is stated like this:

%(why cannot I put the definition of invar4bisim?!)

%add theorem in 2.4 that ST is preserved under bisimulations?

Modal formulas is preserved under bisimulation by \texttt{thm_2_20}, and hence their standard translations by \texttt{prop_2_47_i}. To justify the above answer to the question, the rest of this section devotes to prove any formulas which is invariant under bisimulation is equivalent to a standard translation:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FV}\;\HOLFreeVar{a}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{x}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{form_functions}\;\HOLFreeVar{a}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{invar4bisim}\;\HOLFreeVar{x}\;\HOLFreeVar{t\sb{\mathrm{1}}}\;\HOLFreeVar{t\sb{\mathrm{2}}}\;\HOLFreeVar{a}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[]\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{n}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[\HOLBoundVar{a};\;\HOLBoundVar{b}]\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLNumLit{0})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{c}\;\HOLBoundVar{d}\;\HOLBoundVar{n}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;(\HOLBoundVar{a}\HOLSymConst{::}\HOLBoundVar{b}\HOLSymConst{::}\HOLBoundVar{c}\HOLSymConst{::}\HOLBoundVar{d})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n\sb{\mathrm{0}}}\;\HOLBoundVar{l\sb{\mathrm{0}}}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Fun}\;\HOLBoundVar{n\sb{\mathrm{0}}}\;\HOLBoundVar{l\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{a})
\end{holmath}

The tools that this proof will use centered on saturated models, which we are introducing now:

Given a first order model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, we can add some new constants to it to equip the model with more information. By adding new constant, we mean add nullary function symbols, each corresponds to some point in its domain. A model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} is an expansion of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} if it is same as \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} except it has more constants. In the HOL, \HOLinline{\HOLConst{expansion}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{A}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{f}} means `M' is the expansion of M obtained by adding a bunch of constant, each corresponds an element in $A$'. 

\begin{holmath}
  \HOLConst{expansion}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{A}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{Dom}\;\HOLSymConst{=}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{BIJ}\;\HOLFreeVar{f}\;(\HOLConst{count}\;(\HOLConst{CARD}\;\HOLFreeVar{A}))\;\HOLFreeVar{A}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{Fun}\;\HOLSymConst{=}\\
\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{n}\;\HOLBoundVar{args}.\\
\;\;\;\;\;\;\;\;\;\;\;\HOLKeyword{if}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenLt{}}\;\HOLConst{CARD}\;\HOLFreeVar{A}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{args}\;\HOLSymConst{=}\;[]\;\HOLKeyword{then}\;\HOLFreeVar{f}\;\HOLBoundVar{n}\;\HOLKeyword{else}\;\HOLConst{CHOICE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{Pred}\;\HOLSymConst{=}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}
\end{holmath}

We are interested in the case that we are adding finitely many constants to a first order model without any function. So when we use this definition, \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} should be a model with no interesting information about constants, and $A$ is a finite set of worlds in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}. The \HOLinline{\HOLConst{count}\;\HOLFreeVar{n}} is the set of the $n$ natural numbers from $0$ to $n-1$. For \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} an $\alpha$-model, $f$ is of type $num\to \alpha$, its role is to assign each natural number an element in $A$. Hence \HOLinline{\HOLConst{expansion}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{A}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{f}} means \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} is a model that obtained by adding constants \HOLinline{\HOLConst{Fn}\;\HOLFreeVar{n}\;[]} with \HOLinline{\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenLt{}}\;\HOLConst{CARD}\;\HOLFreeVar{A}} which will evaluate to \HOLinline{\HOLFreeVar{f}\;\HOLFreeVar{n}}. For fixed \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{A}}, the model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} such that \HOLinline{\HOLConst{expansion}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{A}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{f}} is not unique, since the $f$ may varies. But it does not matter since all those models will be equivalent, so we can actually refer to `the' expansion of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}}. %better explaination?

A first order model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is called n-saturated if for any set \HOLinline{\HOLFreeVar{A}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} where \HOLinline{\HOLConst{CARD}\;\HOLFreeVar{A}\;\HOLSymConst{\HOLTokenLt{}}\;\HOLFreeVar{n}}, the any \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}'}}} such that \HOLinline{\HOLConst{expansion}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{A}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{f}} for valid $f$ realise every set \HOLinline{\HOLFreeVar{G}} of formulas where each formula in \HOLinline{\HOLFreeVar{G}} only have one free variable $x$ and is only possible to involve nullary function symbols corresponds to the elements in $A$. Here the definition of consistence is borrowed from first order logic. A set \HOLinline{\HOLFreeVar{G}} is consistent to the theory of a first order model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} iff any finite set of \HOLinline{\HOLFreeVar{G}} is realisable in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}. A model is countably saturated if it is n-saturated for all $n$.

\begin{holmath}
  \HOLConst{consistent}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{G}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{G\sb{\mathrm{0}}}.\\
\;\;\;\;\;\;\HOLConst{FINITE}\;\HOLBoundVar{G\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{G\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{G}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{G\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{fsatis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{phi}
  \HOLConst{n_saturated}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{A}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{G}\;\HOLBoundVar{x}\;\HOLBoundVar{f}.\\
\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{f}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FINITE}\;\HOLBoundVar{A}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{CARD}\;\HOLBoundVar{A}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\HOLBoundVar{A}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{expansion}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{A}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{G}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{c}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{form_functions}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{FST}\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{count}\;(\HOLConst{CARD}\;\HOLBoundVar{A})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{SND}\;\HOLBoundVar{c}\;\HOLSymConst{=}\;\HOLNumLit{0})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\HOLConst{ftype}\;\HOLBoundVar{x}\;\HOLBoundVar{G}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{consistent}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{G}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLConst{frealizes}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{x}\;\HOLBoundVar{G}
  \HOLConst{countably_saturated}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLConst{n_saturated}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{n}
\end{holmath}

The following result explains how can countably saturated models be related to bisimulations:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{countably_saturated}\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLConst{countably_saturated}\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{modal_eq}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{bisim_world}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}
\end{holmath}

By \texttt{prop_2_54}, to prove the above, it suffices to prove:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{countably_saturated}\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{M_sat}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}
\end{holmath}

\begin{proof}
 Suppose \HOLinline{\HOLConst{countably_saturated}\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})}. Let \HOLinline{\HOLFreeVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} a set of modal formulas which is finitely satisfiable in the set of successors of $a$. We find a successor of $a$ in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} realising all the formulas in \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}}. 


Define \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}\sp{\prime}}\;\HOLSymConst{=}\;\HOLTokenLeftbrace{}\HOLConst{fR}\;(\HOLConst{Fn}\;\HOLNumLit{0}\;[])\;(\HOLConst{fV}\;\HOLFreeVar{x})\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLConst{IMAGE}\;(\HOLConst{ST}\;\HOLFreeVar{x})\;\HOLFreeVar{\ensuremath{\Sigma}}} and \HOLinline{\HOLFreeVar{MA}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{Dom}\;:=\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}).\HOLFieldName{Dom};\\
\;\;\;\;\;\;\HOLFieldName{Fun}\;:=\\
\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{n}\;\HOLBoundVar{args}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLKeyword{if}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLNumLit{0}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{args}\;\HOLSymConst{=}\;[]\;\HOLKeyword{then}\;\HOLFreeVar{w}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLKeyword{else}\;\HOLConst{CHOICE}\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}).\HOLFieldName{Dom});\\
\;\;\;\;\;\;\HOLFieldName{Pred}\;:=\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}).\HOLFieldName{Pred}\HOLTokenRightrec{}}, then \HOLinline{\HOLConst{expansion}\;(\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLTokenLeftbrace{}\HOLFreeVar{w}\HOLTokenRightbrace{}\;\HOLFreeVar{MA}\;(\HOLTokenLambda{}\HOLBoundVar{n}.\;\HOLFreeVar{w})}. We claim \HOLinline{\HOLConst{consistent}\;\HOLFreeVar{MA}\;\HOLFreeVar{\ensuremath{\Sigma}\sp{\prime}}}. Take a finite set \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{\ensuremath{\Sigma}\sp{\prime}}}, we should find an element in \HOLinline{\HOLFreeVar{MA}} realising it. For each element in \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}\sb{\mathrm{0}}}} which is a standard translation, use \HOLinline{\HOLConst{CHOICE}} to choose a modal formula $p\in \Sigma$ that is translated to it, note that we do need the choice function since standard translation is not injective under our construction. Collect the formulas we choose into a set \HOLinline{\HOLFreeVar{ps}}, then \HOLinline{\HOLFreeVar{ps}} is a finite subset of \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}}. Recall we have assumed \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} is finitely satisfiable in the set of successors of \HOLinline{\HOLFreeVar{a}}, hence there exists \HOLinline{\HOLFreeVar{b}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLFreeVar{a}\;\HOLFreeVar{b}} such that \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{b}\;\HOLFreeVar{p}} for any \HOLinline{\HOLFreeVar{p}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}}. It follows by \texttt{prop_2_47_i} that no matter \HOLinline{\HOLConst{fR}\;(\HOLConst{Fn}\;\HOLNumLit{0}\;[])\;(\HOLConst{fV}\;\HOLFreeVar{x})} is in \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}}} or not, we have \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}\sb{\mathrm{0}}}} is realised at \HOLinline{\HOLFreeVar{b}} in \HOLinline{\HOLFreeVar{MA}}.

This proves \HOLinline{\HOLConst{consistent}\;\HOLFreeVar{MA}\;\HOLFreeVar{\ensuremath{\Sigma}\sp{\prime}}}. Since \HOLinline{\HOLConst{mm2folm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is countably saturated, \HOLinline{\HOLFreeVar{\ensuremath{\Sigma}\sp{\prime}}} itself is realised in some \HOLinline{\HOLFreeVar{b}} in \HOLinline{\HOLFreeVar{MA}}. The fact that \HOLinline{\HOLConst{fR}\;(\HOLConst{Fn}\;\HOLNumLit{0}\;[])\;(\HOLConst{fV}\;\HOLFreeVar{x})} is realised at $b$ implies $b$ is a successor of $a$ in \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}, and \HOLinline{\HOLConst{IMAGE}\;(\HOLConst{ST}\;\HOLFreeVar{x})\;\HOLFreeVar{\ensuremath{\Sigma}}} is realised at \HOLinline{\HOLFreeVar{b}} implies that \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{b}\;\HOLFreeVar{phi}} for any \HOLinline{\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Sigma}}} by \texttt{prop_2_47_i}.
\end{proof}

There remains two steps from our main characterisation result, which are discussed in the following two interludes.
\subsubsection{Interlude III: Countably saturated models via ultraproducts}

The procceding discussion about countably saturated models left us an important question: How do we get some countably saturated models? The fundamental construction underlying the theory of countably saturated models is that of ultraproduct. We firstly construct ultraproduct about sets, then about models. 

Suppose $I\ne\emptyset$ and $U$ is an ultrafilter on $I$. And for each $i\in I$, $A_i$ is a non-empty set. The Cartestian product is the set of functions with domain $I$ such that for all $i\in I$, $f(i)\in A_i$.
\begin{holmath}
  \HOLConst{Cart_prod}\;\HOLFreeVar{I}\;\HOLFreeVar{A}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLTokenLeftbrace{}\HOLBoundVar{f}\;\HOLTokenBar{}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{f}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{A}\;\HOLBoundVar{i}\HOLTokenRightbrace{}
\end{holmath}

For two functions $f,g$ in the Cartesian product, we say $f$ and $g$ are $U$-equivalent if $f$ and $g$ agrees on some set in $U$. This defined an equivalent relation on the Cartestian product of the $A_i$'s:
\begin{holmath}
  \HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{A}\;\HOLFreeVar{f}\;\HOLFreeVar{g}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{A}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{Cart_prod}\;\HOLFreeVar{I}\;\HOLFreeVar{A}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\HOLFreeVar{g}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{Cart_prod}\;\HOLFreeVar{I}\;\HOLFreeVar{A}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLBoundVar{i}\;\HOLSymConst{=}\;\HOLFreeVar{g}\;\HOLBoundVar{i}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{A}\;\HOLConst{equiv_on}\;\HOLConst{Cart_prod}\;\HOLFreeVar{I}\;\HOLFreeVar{A}
\end{holmath}

The ultraproduct of $A_i$ modulo $U$ is the set od equivalence classes partitioned by the relation \HOLinline{\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLConst{I}\;\HOLFreeVar{A}}:

\begin{holmath}
  \HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{A}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{partition}\;(\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{A})\;(\HOLConst{Cart_prod}\;\HOLFreeVar{I}\;\HOLFreeVar{A})
\end{holmath}

In the case where $A_i = A$ for all $i\in I$, the ultraproduct is called ultrapower of $W$ modulo $U$.

We deal with ultraproduct of modal models first. Given a family \HOLinline{\HOLFreeVar{MS}} of modal models indexed by $I$ and an ultrafilter $U$ on $I$, the ultraproduct model of \HOLinline{\HOLFreeVar{MS}} modulo $U$ is the model described as follows:

\begin{itemize}
  \item The world set is the ultraproduct of world sets of \HOLinline{\HOLFreeVar{Mi}}s modulo $U$.
  \item For two equivalence classes $f_U,g_U$ of functions in the ultraproduct, they are related iff there exists $f\in f_U,g\in g_U$ such that \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLTokenBar{}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{i})\;(\HOLFreeVar{g}\;\HOLBoundVar{i})\HOLTokenRightbrace{}} is in $U$.
  \item For a propositional letter $p$ and an equivalence class $f_U$, we have $p$ is satisfied at $f_U$ iff there exists $g\in f_U$ such that \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{valt}\;\HOLFreeVar{p}\HOLTokenRightbrace{}} is in $U$.
\end{itemize} 

The HOL definition looks like this:

\begin{holmath}
  \HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{frame}\;:=\\
\;\;\;\;\HOLTokenLeftrec{}\HOLFieldName{world}\;:=\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{models2worlds}\;\HOLFreeVar{MS});\\
\;\;\;\;\;\;\HOLFieldName{rel}\;:=\\
\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{fu}\;\HOLBoundVar{gu}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}\;\HOLBoundVar{g}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{fu}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{g}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{gu}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLBoundVar{f}\;\HOLBoundVar{i})\;(\HOLBoundVar{g}\;\HOLBoundVar{i})\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U})\HOLTokenRightrec{};\\
\;\;\HOLFieldName{valt}\;:=\\
\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{p}\;\HOLBoundVar{fu}.\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{fu}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{f}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{valt}\;\HOLBoundVar{p}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U})\HOLTokenRightrec{}
\end{holmath}

Note that since the choice of representatives does not make any difference since \HOLinline{\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLConst{I}\;\HOLFreeVar{A}} is an equivalence relation, we get an equivalent definition of ultraproduct models if we replace all the existential quantifers with universal quantifiers.

where the function \HOLinline{\HOLConst{models2worlds}} is used here to extract the underlying sets of models.

\begin{holmath}
  \HOLConst{models2worlds}\;\HOLFreeVar{MS}\;\HOLSymConst{\HOLTokenDefEquality{}}\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world})
\end{holmath}

Our central result about ultraproduct on modal models is a `modal verion' of the Los theorem. The standard version of Los theorem will be discussed in a moment.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}\;\HOLBoundVar{fc}.\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{fc}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{J}\;\HOLFreeVar{Ms}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{J}\;\HOLFreeVar{Ms})\;\HOLBoundVar{fc}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{fc}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;(\HOLBoundVar{f}\;\HOLBoundVar{i})\;\HOLBoundVar{phi}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U})
\end{holmath}
\begin{proof}
  Given an ultrafilter $U$ over $J$ and a family \HOLinline{\HOLFreeVar{Ms}} of models. We proceed by induction on \HOLinline{\HOLFreeVar{phi}}, the base case for \HOLinline{\HOLFreeVar{phi}\;\HOLSymConst{=}\;\HOLConst{VAR}\;\HOLFreeVar{p}} is directly by definition, and the case for \HOLinline{\HOLFreeVar{phi}\;\HOLSymConst{=}\;\HOLSymConst{\ensuremath{\bot}}} is by the fact that the empty set is not in the ultrafilter. The boolean cases are by basic property of ultrafilters. We only spell out the proof for diamond case. Suppose for any equivalence \HOLinline{\HOLFreeVar{fc}} in the ultraproduct, we have 
\HOLinline{\HOLConst{satis}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{J}\;\HOLFreeVar{Ms})\;\HOLFreeVar{fc}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{fc}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;(\HOLBoundVar{f}\;\HOLBoundVar{i})\;\HOLFreeVar{phi}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}}

Given a world in \HOLinline{\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{J}\;\HOLFreeVar{Ms}}, we prove \HOLinline{\HOLConst{satis}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{J}\;\HOLFreeVar{Ms})\;\HOLFreeVar{fc}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{phi})\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{fc}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;(\HOLBoundVar{f}\;\HOLBoundVar{i})\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLFreeVar{phi})\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}}

Left to right: The assumption says that there is an equivalence class that is related to \HOLinline{\HOLFreeVar{fc}} and satisfied \HOLinline{\HOLFreeVar{phi}}. Suppose the equivalence class $gc$ is represented by a function $g$, and $fc$ is represented by the function $f$. We check the $f$ can be taken as our $f$ as above. By defination of satisfication, our task is to check the set \HOLinline{\HOLFreeVar{A}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{i})\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;\HOLBoundVar{v}\;\HOLFreeVar{phi}\HOLTokenRightbrace{}} is in $U$. 

By inductive hypothesis, the fact that \HOLinline{\HOLFreeVar{phi}} is satisfied at $gc$ implies the existence of an element in $x$ \HOLinline{\HOLFreeVar{gc}} such that \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;(\HOLFreeVar{x}\;\HOLBoundVar{i})\;\HOLFreeVar{phi}\HOLTokenRightbrace{}} is in $U$, but as \HOLinline{\HOLConst{Uequiv}} is an equivalence relation, this implies \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;(\HOLFreeVar{g}\;\HOLBoundVar{i})\;\HOLFreeVar{phi}\HOLTokenRightbrace{}} is in $U$. As we can check: Since $x$ and $g$ lives in the same equivalence class, \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{g}\;\HOLBoundVar{i}\;\HOLSymConst{=}\;\HOLFreeVar{x}\;\HOLBoundVar{i}\HOLTokenRightbrace{}} is in $U$. As ultrafilters are closed under finite intersection, \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{g}\;\HOLBoundVar{i}\;\HOLSymConst{=}\;\HOLFreeVar{x}\;\HOLBoundVar{i}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenInter{}}\\
\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;(\HOLFreeVar{x}\;\HOLBoundVar{i})\;\HOLFreeVar{phi}\HOLTokenRightbrace{}} is in $U$, this is a subset of  \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;(\HOLFreeVar{g}\;\HOLBoundVar{i})\;\HOLFreeVar{phi}\HOLTokenRightbrace{}}, hence by upward closure, the result follows. As $fc$ and $gc$ is related, by a same procedure of checking independence of representatives, the set \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{i})\;(\HOLFreeVar{g}\;\HOLBoundVar{i})\HOLTokenRightbrace{}} is in $U$. Hence the intersection \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{i})\;(\HOLFreeVar{g}\;\HOLBoundVar{i})\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenInter{}}\\
\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;(\HOLFreeVar{g}\;\HOLBoundVar{i})\;\HOLFreeVar{phi}\HOLTokenRightbrace{}} is in $U$. As our $A$ is a supset of this set, $A$ is in $U$ as well.

Right to left: Suppose there is an $f\in fc$ such that \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{f}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{v}.\\
\;\;\;\;\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{i})\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;\HOLBoundVar{v}\;\HOLFreeVar{phi}\HOLTokenRightbrace{}} is in $U$, we need to find an equivalence class which is related to $fc$ and satisfies $\phi$, which by definition of relation in ultraproduct model, amounts to find a representative of such an equivalence class. The representative is given by :
\HOLinline{\HOLTokenLambda{}\HOLBoundVar{i}.\\
\;\;\;\;\HOLKeyword{if}\\
\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{i})\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;\HOLBoundVar{v}\;\HOLFreeVar{phi}\\
\;\;\;\;\HOLKeyword{then}\\
\;\;\;\;\;\;\HOLConst{CHOICE}\\
\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{v}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{rel}\;(\HOLFreeVar{f}\;\HOLBoundVar{i})\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i})\;\HOLBoundVar{v}\;\HOLFreeVar{phi}\HOLTokenRightbrace{}\\
\;\;\;\;\HOLKeyword{else}\;\HOLConst{CHOICE}\;(\HOLFreeVar{Ms}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}}

checking this is the correct representative is tedious, but just routine, using representative independence and the property of \HOLinline{\HOLConst{CHOICE}} function. 

\end{proof}

In the case that we are taking the ultraproduct of a constant family of models with \HOLinline{\HOLFreeVar{MS}\;\HOLFreeVar{i}\;\HOLSymConst{=}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}} for all $i\in I$, we get an ultrapower of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}}. Specialing \texttt{Los_modal_thm} to the case of ultrapowers yields the following proposition.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{Ms}\;\HOLBoundVar{i}\;\HOLSymConst{=}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{J}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}\;\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{J}\;\HOLFreeVar{Ms})\\
\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{fw}\;\HOLTokenBar{}\;\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLFreeVar{J}\;(\HOLConst{models2worlds}\;\HOLFreeVar{Ms})\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLBoundVar{w})\;\HOLBoundVar{fw}\HOLTokenRightbrace{}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{phi}
\end{holmath}

The construction of ultraproduct of first order models is similar to the construction for modal models. Restricting our scope only to first order models with `well-formed' conditions in the sense of it contains the same information as a modal model does not save much work, so we will just construct it for any first order models. This requires us to deal with function symbols and predicate symbols with any arity. 


\begin{itemize}
\item A function with its symbol denoted by natural number $n$ will send a list of equivalence class to the equivalence class represented by the function that sending $i\in I$ to \HOLinline{(\HOLFreeVar{FMS}\;\HOLFreeVar{i}).\HOLFieldName{Fun}\;\HOLFreeVar{n}\;(\HOLConst{MAP}\;(\HOLTokenLambda{}\HOLBoundVar{fc}.\;\HOLConst{CHOICE}\;\HOLBoundVar{fc}\;\HOLFreeVar{i})\;\HOLFreeVar{fs})}. That is, to see where does $i\in I$ goes to, evaluate each representative in the list $fs$ at $i$, collect them into a list, and use this list as the input of the function denoted by $n$ in the model \HOLinline{\HOLFreeVar{FMS}\;\HOLFreeVar{i}}.

\item A predicate with its symbol denoted by $p$ will hold for a list $zs$ of equivalence classes iff when we pick representatives in each member of $zs$ and evaluate these representatives at $i$, the predicate $p$ holds in \HOLinline{\HOLFreeVar{FMS}\;\HOLFreeVar{i}} when we evaluate it with the list \HOLinline{\HOLConst{MAP}\;(\HOLTokenLambda{}\HOLBoundVar{fc}.\;\HOLConst{CHOICE}\;\HOLBoundVar{fc}\;\HOLFreeVar{i})\;\HOLFreeVar{zs}} of the outputs. 
\end{itemize}

To avoid having quantifiers everywhere, we fix the representative for each equivalence class $fc$ to be \HOLinline{\HOLConst{CHOICE}\;\HOLFreeVar{fc}}.


The definition looks like this:

\begin{holmath}
  \HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{FMS}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLTokenLeftrec{}\HOLFieldName{Dom}\;:=\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{folmodels2Doms}\;\HOLFreeVar{FMS});\\
\;\;\HOLFieldName{Fun}\;:=\\
\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{n}\;\HOLBoundVar{fs}.\\
\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{y}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{y}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{y}\;\HOLBoundVar{i}\;\HOLSymConst{=}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Fun}\;\HOLBoundVar{n}\;(\HOLConst{MAP}\;(\HOLTokenLambda{}\HOLBoundVar{fc}.\;\HOLConst{CHOICE}\;\HOLBoundVar{fc}\;\HOLBoundVar{i})\;\HOLBoundVar{fs})\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}\HOLTokenRightbrace{});\\
\;\;\HOLFieldName{Pred}\;:=\\
\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{p}\;\HOLBoundVar{zs}.\\
\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Pred}\;\HOLBoundVar{p}\;(\HOLConst{MAP}\;(\HOLTokenLambda{}\HOLBoundVar{fc}.\;\HOLConst{CHOICE}\;\HOLBoundVar{fc}\;\HOLBoundVar{i})\;\HOLBoundVar{zs})\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\\
\;\;\;\;\;\;\;\;\;\HOLFreeVar{U})\HOLTokenRightrec{}
\end{holmath}

We now prove this construction has nice semantical behaviour. 

For an ultraproduct model of the family \HOLinline{\HOLFreeVar{FMS}} of first order models, an evaluation $\sigma$ assigns each variable symbol an equivalence class in the ultraproduct of the world sets of the family. A term $t$ will be sent to the equivalence class represented by the function obtained as follows. For $i\in I$, the function that assigns a variable symbol $n$ to the representative of \HOLinline{\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{n}} evaluated at $i$ will be an assignment of variable symbols to elements in \HOLinline{\HOLFreeVar{FMS}\;\HOLFreeVar{i}}, and $i$ is sent to the element in \HOLinline{(\HOLFreeVar{FMS}\;\HOLFreeVar{i}).\HOLFieldName{Dom}} we will get by evaluating $t$ in \HOLinline{\HOLFreeVar{FMS}\;\HOLFreeVar{i}} using this assignment of variable symbols.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{FMS}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{folmodels2Doms}\;\HOLBoundVar{FMS})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLBoundVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Fun}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLBoundVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{termval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLBoundVar{FMS})\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{t}\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{f}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{folmodels2Doms}\;\HOLBoundVar{FMS})\;\HOLBoundVar{f}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLConst{termval}\;(\HOLBoundVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{n}.\;\HOLConst{CHOICE}\;(\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{n})\;\HOLBoundVar{i})\;\HOLFreeVar{t})\HOLTokenRightbrace{}
\end{holmath}
\begin{proof}
 By complete induction on \texttt{term_size t}.
\end{proof}
The nice semantical behaviour of ultraproduct is evident from the Los theorem:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{FMS}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{folmodels2Doms}\;\HOLBoundVar{FMS})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLBoundVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Fun}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLBoundVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLConst{feval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLBoundVar{FMS})\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;(\HOLBoundVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\;\HOLFreeVar{phi}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{U})
\end{holmath}

\begin{proof}
 By induction on \HOLinline{\HOLFreeVar{phi}}. The base case for \HOLinline{\HOLConst{fFALSE}} comes from the fact that the empty set is not in an ultrafilter. And the atomic case reduces to check representative independence by unwinding the definitions. We should prove
\HOLinline{\HOLFreeVar{S\sb{\mathrm{1}}}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Pred}\;\HOLFreeVar{n}\\
\;\;\;\;\;\;\;(\HOLConst{MAP}\\
\;\;\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{x}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{CHOICE}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{termval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLConst{I}\;\HOLFreeVar{FMS})\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{i})\;\HOLFreeVar{l})\HOLTokenRightbrace{}} is in U iff
\HOLinline{\HOLFreeVar{S\sb{\mathrm{2}}}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Pred}\;\HOLFreeVar{n}\\
\;\;\;\;\;\;\;(\HOLConst{MAP}\;(\HOLConst{termval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i}))\;\HOLFreeVar{l})\HOLTokenRightbrace{}} is in U.

Let \HOLinline{\HOLFreeVar{I\sb{\mathrm{0}}}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLConst{MAP}\\
\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{x}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{CHOICE}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{termval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLConst{I}\;\HOLFreeVar{FMS})\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\\
\;\;\;\;\;\;\;\HOLFreeVar{l}\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\HOLConst{MAP}\;(\HOLConst{termval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i}))\;\HOLFreeVar{l}\HOLTokenRightbrace{}}, then 
\HOLinline{\HOLFreeVar{I\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{S\sb{\mathrm{1}}}\;\HOLSymConst{=}\;\HOLFreeVar{I\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{S\sb{\mathrm{2}}}}. If \HOLinline{\HOLFreeVar{I\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}}, suppose in addition that \HOLinline{\HOLFreeVar{S\sb{\mathrm{1}}}} is in $U$, then \HOLinline{\HOLFreeVar{S\sb{\mathrm{2}}}} is a supset of the set \HOLinline{\HOLFreeVar{I\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{S\sb{\mathrm{2}}}}, which is in $U$, and vice versa. So it suffices to prove \HOLinline{\HOLFreeVar{I\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}}.
Obviously, if the two maps we are interested in agree on each member of \HOLinline{\HOLFreeVar{l}}, then the resultant list we get will be equal. That gives \HOLinline{\HOLFreeVar{A}\;\HOLSymConst{=}\\
\;\;\HOLConst{BIGINTER}\\
\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\HOLConst{CHOICE}\;(\HOLConst{termval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLConst{I}\;\HOLFreeVar{FMS})\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{a})\;\HOLBoundVar{i}\;\HOLSymConst{=}\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{termval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\;\HOLBoundVar{a}\HOLTokenRightbrace{}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\HOLConst{MEM}\;\HOLBoundVar{a}\;\HOLFreeVar{l}\HOLTokenRightbrace{}} is a subset of \HOLinline{\HOLFreeVar{I\sb{\mathrm{0}}}}, reduces our task to prove \HOLinline{\HOLFreeVar{A}} is in $U$. But by \texttt{thm_A_19_i}, for each member $a$ of $l$, \HOLinline{\HOLConst{termval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLConst{I}\;\HOLFreeVar{FMS})\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{a}} is the equivalence class represents by \HOLinline{\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLConst{termval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{n}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{n})\;\HOLBoundVar{i})\;\HOLFreeVar{a}}. Hence \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\HOLConst{CHOICE}\;(\HOLConst{termval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLConst{I}\;\HOLFreeVar{FMS})\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{a})\;\HOLBoundVar{i}\;\HOLSymConst{=}\\
\;\;\;\HOLConst{termval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\;\HOLFreeVar{a}\HOLTokenRightbrace{}} is in $U$ for each $a$. So $A$ is in $U$ as a finite intersection of sets in $U$.

The implication case is trivial from inductive hypothesis. Finally, we prove the case for universal quantifier. 
From left to right, suppose \HOLinline{\HOLFreeVar{phi}} is satisfied at any equivalence class in the ultraproduct model for \HOLinline{\HOLFreeVar{FMS}}. We need \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\;(\HOLConst{FALL}\;\HOLFreeVar{n}\;\HOLFreeVar{phi})\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}}. Suppose not, then as $U$ is an ultrafilter, \HOLinline{\HOLFreeVar{B}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\;(\HOLConst{fEXISTS}\;\HOLFreeVar{n}\;(\HOLConst{fNOT}\;\HOLFreeVar{phi}))\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\\
\HOLFreeVar{U}}. Use choice, define the function $f$ to send $i\in I$ to a chosen point in \HOLinline{(\HOLFreeVar{FMS}\;\HOLFreeVar{i}).\HOLFieldName{Dom}} where \HOLinline{\HOLFreeVar{phi}} is not satisfied. Such a function in HOL looks like:
\HOLinline{\HOLFreeVar{f}\;\HOLSymConst{=}\\
\;\;(\HOLTokenLambda{}\HOLBoundVar{i}.\\
\;\;\;\;\;\;\;\;\;\HOLKeyword{if}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{a}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\ensuremath{\llparenthesis}\HOLFreeVar{n}\;\ensuremath{\mapsto}\;\HOLBoundVar{a}\ensuremath{\rrparenthesis}\;\HOLFreeVar{phi}\\
\;\;\;\;\;\;\;\;\;\HOLKeyword{then}\\
\;\;\;\;\;\;\;\;\;\;\;\HOLConst{CHOICE}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{a}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\ensuremath{\llparenthesis}\HOLFreeVar{n}\;\ensuremath{\mapsto}\;\HOLBoundVar{a}\ensuremath{\rrparenthesis}\;\HOLFreeVar{phi}\HOLTokenRightbrace{}\\
\;\;\;\;\;\;\;\;\;\HOLKeyword{else}\;\HOLConst{CHOICE}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom})}.
Then \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLSymConst{\HOLTokenNeg{}}\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\ensuremath{\llparenthesis}\HOLFreeVar{n}\;\ensuremath{\mapsto}\;\HOLFreeVar{f}\;\HOLBoundVar{i}\ensuremath{\rrparenthesis}\;\HOLFreeVar{phi}\HOLTokenRightbrace{}\;\HOLSymConst{=}\\
\;\;\HOLFreeVar{B}}, and hence  is in U. Then by the inductive hypothesis, we can show the equivalence class represented by $f$ does not satisfy \HOLinline{\HOLFreeVar{phi}}, contradiction. 

From right to left. It is straightforward to check \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\;(\HOLConst{FALL}\;\HOLFreeVar{n}\;\HOLFreeVar{phi})\HOLTokenRightbrace{}} is a subset of \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\ensuremath{\llparenthesis}\HOLFreeVar{n}\;\ensuremath{\mapsto}\;\HOLFreeVar{a}\ensuremath{\rrparenthesis}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\;\HOLFreeVar{phi}\HOLTokenRightbrace{}}, for any equivalence class $a$. So the former one is in $U$ implies the later one is in $U$. 

\end{proof}

The way we stated the Los theorem will looks not such satisfactory, since it seems to restrict us for the choice of representatives, but it is not. We can be very free with our choice of representatives, as indicated in the following result:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{IMAGE}\;\HOLFreeVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{folmodels2Doms}\;\HOLFreeVar{FMS})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}\;\HOLBoundVar{rv}.\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}.\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{FV}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{rv}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{v})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{x}.\;\HOLConst{CHOICE}\;(\HOLFreeVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\;\HOLBoundVar{i})\;\HOLBoundVar{phi}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{v}.\;\HOLBoundVar{rv}\;\HOLBoundVar{v}\;\HOLBoundVar{i})\;\HOLBoundVar{phi}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U})
\end{holmath}

If the world of models in \HOLinline{\HOLFreeVar{FMS}} are of type $\beta$, then \HOLinline{\HOLFreeVar{rv}} here is of type $num\to\beta$. The $\sigma$ here is an assignment of variable symbols to worlds of the ultraproduct model, which are equivalence classes. And \HOLinline{\HOLFreeVar{rv}} here assigns each variable symbol $v$ an element \HOLinline{\HOLFreeVar{rv}\;\HOLFreeVar{v}} in the equivalence class assigned to $v$ by $\sigma$.%better explanation?
For its proof, it actually amounts to check representative independency, which is of the same flavor of the second base case in the proof of Los theorem.

The independence of representative provide us convenience of actually putting our Los theorem into usage. Since then if we want to find an assignments of elements in a ultraproduct model satisfying a first order formula $\phi$, instead of assigning equivalence classes directly, it suffices to use the \HOLinline{\HOLFreeVar{rv}} below  to assign each $v$ a suitable representative functions in the Cartesian product :

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Fun}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{rv}.\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}\;\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{rv}\;\HOLBoundVar{v}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{v}.\;\HOLBoundVar{rv}\;\HOLBoundVar{v}\;\HOLBoundVar{i})\;\HOLBoundVar{phi}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{FMS})\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{g}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{folmodels2Doms}\;\HOLFreeVar{FMS})\;\HOLBoundVar{g}\;(\HOLBoundVar{rv}\;\HOLBoundVar{v})\HOLTokenRightbrace{})\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}
\end{holmath}


With the help of \texttt{ultraproduct_rep_independence_lemma}, we can prove a classical corollary of Los theorem, which says any first order model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} is embedded in any of its ultraproduct model by sending a world to the equivalence class represented by the constant function on that world:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{FMS}\;\HOLBoundVar{i}\;\HOLSymConst{=}\;\HOLFreeVar{FM})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{FM}.\HOLFieldName{Fun}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{FM}.\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{FM}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;\HOLFreeVar{FM}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{FMS})\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{x}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{g}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{folmodels2Doms}\;\HOLFreeVar{FMS})\;\HOLBoundVar{g}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{x})\HOLTokenRightbrace{})\;\HOLBoundVar{phi}
\end{holmath}

All the construction we done above serves to paving a way to getting a countably saturated model:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{countably_incomplete}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{countably_saturated}\;(\HOLConst{mm2folm}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS}))
\end{holmath}

With all the setups about ultraproduct models, we may feel confident that this will be a consequence of Los theorem. But if we take a closer look of it, we will find out the Los theorem cannot be directly applied here. The definition of countably saturated asks us to prove the realisation of a set of first order formulas in an expanded first order model, and the first order model itself is from turning a modal model into a first order model. The obstrucles here will become clear when we compare what we want to prove to the statement of Los theorem: The Los theorem tells us the result for an ultraproduct of first order models, and says nothing about expansion. But we are proving a statement for an expanded model obtained from viewing an ultraproduct of modal models as a first order model. However, as we shell see now, it cannot stop us from applying the Los theorem.%quote the goal?

The first issue is to remove the expansion on the outmost layer of expansion. The key observation is that we have an alternative approach to capture the idea of `constants'. Constant are nothing more than forcing some symbols to be sent to some point in a model under any valuation, hence rather then use nullary function symbols, we fixed a set of variable letters, each corresponds to a function symbol, and only consider the valuations that sends these variable letters to fixed certain points. With this idea, we can remove all the constants in a formula, and hence swap from an expanded model back to the unexpanded model. For our aim for proving \texttt{lemma_2_73}, we only care about the case that we only have finitely many function symbols. To get rid of $n$-function symbols, we need to come up with $n$ fresh variable symbols to be sent to certain places. The easiest way to ensure that the variable symbols we use for constants do not clash with the variable symbols we use for usual aim is to force those $n$-variable symbols to be represented by $0,\cdots, n$, and then add $n$ to all the variable symbols which originally appear in a formula. The construction of discarding constants in a formula can be done by a function:

\begin{holmath}
  \HOLConst{shift_term}\;\HOLFreeVar{n}\;(\HOLConst{fV}\;\HOLFreeVar{m})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{fV}\;(\HOLFreeVar{m}\;\HOLSymConst{\ensuremath{+}}\;\HOLFreeVar{n})\\
\HOLConst{shift_term}\;\HOLFreeVar{n}\;(\HOLConst{Fn}\;\HOLFreeVar{m}\;\HOLFreeVar{l})\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLKeyword{if}\;\HOLFreeVar{l}\;\HOLSymConst{=}\;[]\;\HOLKeyword{then}\;\HOLConst{fV}\;\HOLFreeVar{m}\;\HOLKeyword{else}\;\HOLConst{Fn}\;\HOLFreeVar{m}\;(\HOLConst{MAP}\;(\HOLTokenLambda{}\HOLBoundVar{a}.\;\HOLConst{shift_term}\;\HOLFreeVar{n}\;\HOLBoundVar{a})\;\HOLFreeVar{l})
  \HOLConst{shift_form}\;\HOLFreeVar{n}\;\HOLConst{fFALSE}\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{fFALSE}\\
\HOLConst{shift_form}\;\HOLFreeVar{n}\;(\HOLConst{Pred}\;\HOLFreeVar{m}\;\HOLFreeVar{l})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{Pred}\;\HOLFreeVar{m}\;(\HOLConst{MAP}\;(\HOLConst{shift_term}\;\HOLFreeVar{n})\;\HOLFreeVar{l})\\
\HOLConst{shift_form}\;\HOLFreeVar{n}\;(\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\ensuremath{\rightarrow}}\;\HOLFreeVar{f\sb{\mathrm{2}}})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{shift_form}\;\HOLFreeVar{n}\;\HOLFreeVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\ensuremath{\rightarrow}}\;\HOLConst{shift_form}\;\HOLFreeVar{n}\;\HOLFreeVar{f\sb{\mathrm{2}}}\\
\HOLConst{shift_form}\;\HOLFreeVar{n}\;(\HOLConst{FALL}\;\HOLFreeVar{x}\;\HOLFreeVar{f})\;\HOLSymConst{\HOLTokenDefEquality{}}\;\HOLConst{FALL}\;(\HOLFreeVar{x}\;\HOLSymConst{\ensuremath{+}}\;\HOLFreeVar{n})\;(\HOLConst{shift_form}\;\HOLFreeVar{n}\;\HOLFreeVar{f})
\end{holmath}

Here we will need to prove the termination for the function \texttt{shift_term}. The termination relation is given by \HOLinline{\HOLConst{measure}\;(\HOLConst{term_size}\;\HOLSymConst{\HOLTokenCompose}\;\HOLConst{SND})}. %need to talk about termination?

We get the syntactical result we want: All the function symbols are removed by applying the shifting construction, and the set of free variables is also under control.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{c}.\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{form_functions}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{FST}\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{count}\;(\HOLConst{CARD}\;\HOLFreeVar{A})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{SND}\;\HOLBoundVar{c}\;\HOLSymConst{=}\;\HOLNumLit{0})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{form_functions}\;(\HOLConst{shift_form}\;(\HOLConst{CARD}\;\HOLFreeVar{A})\;\HOLFreeVar{phi})\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FV}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{s}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{c}.\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{form_functions}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLConst{FST}\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{count}\;(\HOLConst{CARD}\;\HOLFreeVar{A})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{SND}\;\HOLBoundVar{c}\;\HOLSymConst{=}\;\HOLNumLit{0})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{FV}\;(\HOLConst{shift_form}\;(\HOLConst{CARD}\;\HOLFreeVar{A})\;\HOLFreeVar{phi})\;\HOLConst{DIFF}\;\HOLConst{count}\;(\HOLConst{CARD}\;\HOLFreeVar{A})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{x}\;\HOLSymConst{\ensuremath{+}}\;\HOLConst{CARD}\;\HOLFreeVar{A}\;\HOLTokenBar{}\;\HOLBoundVar{x}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}\HOLTokenRightbrace{}
\end{holmath}

Now if we want to use an arbitary valuation to evaluate a shifted formula, something will go wrong, because $0,\cdots,n-1$ are now designed to be sent to fixed place $f \ 0,\cdots,f \ n$, it does not make sense to assign it to anywhere else. Hence to talk about valuations, the first thing is to make sure that they sends the variables which acturally denotes constants to the right place, therefore, we need to shift them accordingly:

\begin{holmath}
  \HOLConst{shift_valuation}\;\HOLFreeVar{n}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;(\HOLTokenLambda{}\HOLBoundVar{m}.\;\HOLKeyword{if}\;\HOLBoundVar{m}\;\HOLSymConst{\HOLTokenLt{}}\;\HOLFreeVar{n}\;\HOLKeyword{then}\;\HOLFreeVar{f}\;\HOLBoundVar{m}\;\HOLKeyword{else}\;\HOLFreeVar{\ensuremath{\sigma}}\;(\HOLBoundVar{m}\;\HOLSymConst{\ensuremath{-}}\;\HOLFreeVar{n}))
\end{holmath}

Recall our aim is to get rid of constants and hence avoid talking about expansion of models, the following proposition proves our construction does a good job:

\begin{holmath}
  \HOLConst{shift_valuation}\;\HOLFreeVar{n}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;(\HOLTokenLambda{}\HOLBoundVar{m}.\;\HOLKeyword{if}\;\HOLBoundVar{m}\;\HOLSymConst{\HOLTokenLt{}}\;\HOLFreeVar{n}\;\HOLKeyword{then}\;\HOLFreeVar{f}\;\HOLBoundVar{m}\;\HOLKeyword{else}\;\HOLFreeVar{\ensuremath{\sigma}}\;(\HOLBoundVar{m}\;\HOLSymConst{\ensuremath{-}}\;\HOLFreeVar{n}))
\end{holmath}

The shifting construction get us out of the expansion, leaving us in a model obtained by coverting a ultraproduct modal model to a first model. How can we apply Los theorem to it? We do have a modal version of Los theorem, but we are not restricted to talking about standard translations, so \texttt{Los_modal_thm} is unhelpful. The correct way to apply first order version Los theorem on modal ultraproduct model is actually prove the ultraproduct construction on modal and first order models are capatible, in the sense that they are equivalent when we talk about formulas which makes sense to both of them. The capitability results are also witnesses of our success on construction of ultraproduct models. %recall function symbols does not make sense to modal models, so once modal models get involved, we cannot talk about constants anymore except in the case that we expand the model?

Firstly, if we start with a family of modal models and take their ultraproduct in modal sense, then turn the resultant model into a first order model, then this model satisfies the same well-formed formula as the model we get by firstly turning the family of modal models into a family of first order models, then apply the ultraproduct construction in first order sense.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{form_functions}\;\HOLFreeVar{phi}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{models2worlds}\;\HOLFreeVar{MS})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLConst{feval}\;(\HOLConst{mm2folm}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS}))\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLConst{mm2folm}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i})))\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{phi})
\end{holmath}

Moreover, for a family of well-formed first order models, if we take their ultraproducts of them in first order sense, it satisfies the same well-formed formulas as the model we get by firstly regard this family as a family of modal models, take their ultraproduct in modal sense, and then turn the resultant ultraproduct modal model into a first order model.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{ultrafilter}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{form_functions}\;\HOLFreeVar{phi}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}\;\HOLBoundVar{n}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;((\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[]\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F}))\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}\;\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{n}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[\HOLBoundVar{a};\;\HOLBoundVar{b}]\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLNumLit{0})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}\;\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{c}\;\HOLBoundVar{d}\;\HOLBoundVar{n}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;((\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{Pred}\;\HOLBoundVar{n}\;(\HOLBoundVar{a}\HOLSymConst{::}\HOLBoundVar{b}\HOLSymConst{::}\HOLBoundVar{c}\HOLSymConst{::}\HOLBoundVar{d})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F}))\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n\sb{\mathrm{0}}}\;\HOLBoundVar{l\sb{\mathrm{0}}}\;\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{Fun}\;\HOLBoundVar{n\sb{\mathrm{0}}}\;\HOLBoundVar{l\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{folmodels2Doms}\;\HOLFreeVar{MS})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLConst{feval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS})\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{mm2folm}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLConst{folm2mm}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}))))\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{phi})
\end{holmath}


Actually, the \texttt{ultraproduct_comm_feval} and \texttt{expansion_shift_feval} reduces our task into prove:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{countably_incomplete}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{f}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{folmodels2Doms}\;\HOLFreeVar{FMS})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Fun}\;\HOLBoundVar{ff}\;\HOLBoundVar{ll}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{s}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{form_functions}\;\HOLBoundVar{phi}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FV}\;\HOLBoundVar{phi}\;\HOLConst{DIFF}\;\HOLFreeVar{N}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{x}\HOLTokenRightbrace{})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{ss}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{FINITE}\;\HOLBoundVar{ss}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{ss}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{FMS}).\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{N}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLBoundVar{f}\;\HOLBoundVar{n})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{ss}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{FMS})\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{FMS}).\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{N}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLBoundVar{f}\;\HOLBoundVar{n})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{FMS})\;\HOLBoundVar{\ensuremath{\sigma}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}
\end{holmath}

\begin{proof}
Suppose $s$ is a set of formulas such that each element has no function symbol and only one free varible $x$ other then the ones in $N$ which are actually used to capture constants. Suppose in addition that for all finite $ss\subseteq s$, exists a valuation \HOLinline{\HOLFreeVar{\ensuremath{\sigma}}} such that \HOLinline{\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{n}\;\HOLSymConst{=}\;\HOLFreeVar{f}\;\HOLFreeVar{n}} for all $n\in N$, and \HOLinline{\HOLConst{feval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLConst{I}\;\HOLFreeVar{FMS})\;\HOLFreeVar{phi}} for each \HOLinline{\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{s}}. If $s$ is finite, there is nothing to prove, so we assume $s$ is infinite. As we are using a countable first order language, there exists a bijection \HOLinline{\HOLFreeVar{enum}} from the natural number to the set $s$. We prove there exists a valuation \HOLinline{\HOLFreeVar{\ensuremath{\sigma}}} such that agree with $f$ on $N$ and moreover, \HOLinline{\HOLConst{feval}\;(\HOLConst{ultraproduct_folmodel}\;\HOLFreeVar{U}\;\HOLConst{I}\;\HOLFreeVar{FMS})\;(\HOLFreeVar{enum}\;\HOLFreeVar{n})} for all natural number $n$. Such a valuation is an assignment of variables to equivalence class, by \texttt{ultraproduct_suffices_rep} and the Los theorem, it suffices to find out a function \HOLinline{\HOLFreeVar{rv}} that assigning each natural number a representative of some equivalence class, such that it satisfies:

\begin{itemize}
  \item \HOLinline{\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}\;\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLFreeVar{rv}\;\HOLBoundVar{v}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom}}
  \item \HOLinline{\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\\
\;\;\;\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{N}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{g}\;\HOLTokenBar{}\;\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLConst{I}\;(\HOLConst{folmodels2Doms}\;\HOLFreeVar{FMS})\;\HOLBoundVar{g}\;(\HOLFreeVar{rv}\;\HOLBoundVar{n})\HOLTokenRightbrace{}\;\HOLSymConst{=}\;\HOLFreeVar{f}\;\HOLBoundVar{n}}
  \item \HOLinline{\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{k}.\\
\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{v}.\;\HOLFreeVar{rv}\;\HOLBoundVar{v}\;\HOLBoundVar{i})\;(\HOLFreeVar{conj}\;\HOLBoundVar{k})\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}}
\end{itemize}

The first item says what $rv$ assign to each natural number must be an element in the Cartesion product. And the second item says that the equivalence class assigned to free variables in $N$ has already been fixed by $f$. We devote to satisfy the third condition. 

By \texttt{countbly_incomplete_chain} proved in interlude II, we have a chain \HOLinline{\HOLFreeVar{In}} where \HOLinline{\HOLFreeVar{In}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}} and \HOLinline{\HOLFreeVar{In}\;(\HOLFreeVar{n}\;\HOLSymConst{\ensuremath{+}}\;\HOLNumLit{1})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLFreeVar{In}\;\HOLFreeVar{n}} for each \HOLinline{\HOLFreeVar{n}}, and moreover, the intersection of this chain is empty. Let \HOLinline{\HOLFreeVar{conj}\;\HOLSymConst{=}\;\HOLConst{PRIM_REC}\;\HOLConst{True}\;(\HOLTokenLambda{}\HOLBoundVar{conjn}\;\HOLBoundVar{n}.\;\HOLConst{fAND}\;\HOLBoundVar{conjn}\;(\HOLFreeVar{enum}\;\HOLBoundVar{n}))}, hence \HOLinline{\HOLFreeVar{conj}\;\HOLNumLit{0}\;\HOLSymConst{=}\;\HOLConst{True}}, and \HOLinline{\HOLFreeVar{conj}\;\HOLFreeVar{n}} is the conjunction from \HOLinline{\HOLFreeVar{enum}\;\HOLNumLit{0}} to \HOLinline{\HOLFreeVar{enum}\;(\HOLFreeVar{n}\;\HOLSymConst{\ensuremath{-}}\;\HOLNumLit{1})}. Define \HOLinline{\HOLFreeVar{Jn}\;\HOLSymConst{=}\\
\;\;(\HOLTokenLambda{}\HOLBoundVar{n}.\\
\;\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{k}.\;\HOLBoundVar{k}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{N}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{k}\;\HOLSymConst{=}\;\HOLConst{CHOICE}\;(\HOLFreeVar{f}\;\HOLBoundVar{k})\;\HOLBoundVar{i})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;\HOLBoundVar{\ensuremath{\sigma}}\;(\HOLConst{fEXISTS}\;\HOLFreeVar{x}\;(\HOLFreeVar{conj}\;\HOLBoundVar{n}))\HOLTokenRightbrace{})}, then \HOLinline{\HOLFreeVar{Jn}} is also a descending chain. And moreover, the Los theorem implies that \HOLinline{\HOLFreeVar{Jn}\;\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{U}} for any $n$. Define \HOLinline{\HOLFreeVar{Xn}\;\HOLSymConst{=}\;(\HOLTokenLambda{}\HOLBoundVar{n}.\;\HOLFreeVar{In}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenInter{}}\;\HOLFreeVar{Jn}\;\HOLBoundVar{n})}, then \HOLinline{\HOLFreeVar{Xn}} is a descending chain in $U$ starting with \HOLinline{\HOLConst{I}} and intersects to the empty set. For such a chain, each element \HOLinline{\HOLFreeVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}} can only belong to finitely many of \HOLinline{\HOLFreeVar{Xn}}s. Hence there exists a function \HOLinline{\HOLFreeVar{Ni}} that send an element \HOLinline{\HOLFreeVar{i}} to smallest set in the chain that \HOLinline{\HOLFreeVar{i}} belongs to. That is, for all \HOLinline{\HOLFreeVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{I}} \HOLinline{\HOLFreeVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{Xn}\;(\HOLFreeVar{Ni}\;\HOLFreeVar{i})} and \HOLinline{\HOLFreeVar{i}\;\HOLSymConst{\HOLTokenNotIn{}}\;\HOLFreeVar{Xn}\;\HOLFreeVar{a}} for any \HOLinline{\HOLFreeVar{a}\;\HOLSymConst{\HOLTokenGt{}}\;\HOLFreeVar{Ni}\;\HOLFreeVar{i}}.

The \HOLinline{\HOLFreeVar{rv}} we are looking for can be taken as:
\HOLinline{\HOLTokenLambda{}\HOLBoundVar{v}\;\HOLBoundVar{i}.\\
\;\;\;\;\HOLKeyword{if}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{N}\;\HOLKeyword{then}\;\HOLConst{CHOICE}\;(\HOLFreeVar{f}\;\HOLBoundVar{v})\;\HOLBoundVar{i}\\
\;\;\;\;\HOLKeyword{else}\\
\;\;\;\;\;\;\HOLConst{CHOICE}\\
\;\;\;\;\;\;\;\;\HOLTokenLeftbrace{}\HOLBoundVar{a}\;\HOLTokenBar{}\\
\;\;\;\;\;\;\;\;\;\HOLBoundVar{a}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i}).\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\\
\;\;\;\;\;\;\;\;\;\;\;(\HOLTokenLambda{}\HOLBoundVar{n}.\;\HOLKeyword{if}\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{N}\;\HOLKeyword{then}\;\HOLConst{CHOICE}\;(\HOLFreeVar{f}\;\HOLBoundVar{n})\;\HOLBoundVar{i}\;\HOLKeyword{else}\;\HOLBoundVar{a})\\
\;\;\;\;\;\;\;\;\;\;\;(\HOLFreeVar{conj}\;(\HOLFreeVar{Ni}\;\HOLBoundVar{i}))\HOLTokenRightbrace{}}
The first two conditions are immediate to check. It remains to show \HOLinline{\HOLTokenLeftbrace{}\HOLBoundVar{i}\;\HOLTokenBar{}\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{In}\;\HOLNumLit{0}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLBoundVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{v}.\;\HOLFreeVar{\ensuremath{\sigma}r}\;\HOLBoundVar{v}\;\HOLBoundVar{i})\;(\HOLFreeVar{conj}\;\HOLFreeVar{k})\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenIn{}}\\
\HOLFreeVar{U}} for any $k$. As \HOLinline{\HOLFreeVar{Xn}\;\HOLFreeVar{k}} is in $U$, it suffices to check this is a supset of \HOLinline{\HOLFreeVar{Xn}\;\HOLFreeVar{k}}. For any \HOLinline{\HOLFreeVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{Xn}\;\HOLFreeVar{k}}, by definition of the function \HOLinline{\HOLFreeVar{Ni}}, we have \HOLinline{\HOLFreeVar{k}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{Ni}\;\HOLFreeVar{i}}. As \HOLinline{\HOLFreeVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{Xn}\;(\HOLFreeVar{Ni}\;\HOLFreeVar{i})}, in particular, \HOLinline{\HOLFreeVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{Jn}\;(\HOLFreeVar{Ni}\;\HOLFreeVar{i})}. Hence \HOLinline{\HOLConst{feval}\;(\HOLFreeVar{FMS}\;\HOLFreeVar{i})\;(\HOLTokenLambda{}\HOLBoundVar{v}.\;\HOLFreeVar{\ensuremath{\sigma}r}\;\HOLBoundVar{v}\;\HOLFreeVar{i})\;(\HOLFreeVar{conj}\;(\HOLFreeVar{Ni}\;\HOLFreeVar{i}))}. As \HOLinline{\HOLFreeVar{conj}\;\HOLFreeVar{m}} implies \HOLinline{\HOLFreeVar{conj}\;\HOLFreeVar{n}} for \HOLinline{\HOLFreeVar{n}\;\HOLSymConst{\HOLTokenLeq{}}\;\HOLFreeVar{m}}, we are done.

\end{proof}

We can step on the two stairs we built above to get \texttt{lemma_2_73}, using the capatibility lemma, we migrant the above lemma to ultraproduct of modal models:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{countably_incomplete}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{IMAGE}\;\HOLFreeVar{f}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{models2worlds}\;\HOLFreeVar{MS})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{s}.\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{form_functions}\;\HOLBoundVar{phi}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{FV}\;\HOLBoundVar{phi}\;\HOLConst{DIFF}\;\HOLFreeVar{N}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{x}\HOLTokenRightbrace{})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{ss}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{FINITE}\;\HOLBoundVar{ss}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{ss}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{mm2folm}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS})).\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{N}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLFreeVar{f}\;\HOLBoundVar{n})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{ss}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{mm2folm}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS}))\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{mm2folm}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS})).\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLBoundVar{n}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{N}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLFreeVar{f}\;\HOLBoundVar{n})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;(\HOLConst{mm2folm}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS}))\;\HOLBoundVar{\ensuremath{\sigma}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}
\end{holmath}

And use the shifting, we then migrant to expanded models:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{countably_incomplete}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{i}.\;\HOLBoundVar{i}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{I}\;\HOLSymConst{\HOLTokenImp{}}\;(\HOLFreeVar{MS}\;\HOLBoundVar{i}).\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenNotEqual{}}\;\HOLSymConst{\HOLTokenEmpty{}})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{A}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{f}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{expansion}\;(\HOLConst{mm2folm}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS}))\;\HOLBoundVar{A}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{f}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLConst{ultraproduct}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;(\HOLConst{models2worlds}\;\HOLFreeVar{MS})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{s}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{c}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{form_functions}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{FST}\;\HOLBoundVar{c}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLConst{count}\;(\HOLConst{CARD}\;\HOLBoundVar{A})\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{SND}\;\HOLBoundVar{c}\;\HOLSymConst{=}\;\HOLNumLit{0})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{FV}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{x}\HOLTokenRightbrace{})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{ss}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{FINITE}\;\HOLBoundVar{ss}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{ss}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{mm2folm}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS})).\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{ss}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{mm2folm}\;(\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLFreeVar{I}\;\HOLFreeVar{MS})).\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{s}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLBoundVar{phi}
\end{holmath}


we can deduce \texttt{lemma_2_73} trivially from here.


The last step towards the main theorem is used to pass from infinite set to finite set.
\subsubsection{Interlude IV: Compactness theorem}


haven't written it yet...
talk about 1. JH's work on compactness, skip the proof, and talk a bit about its corollary, and how to use the corollary as `suffices to prove is implies by a set of formulas'. Prove modal compactness since we are doing modal logic. And prove modal version of the useful corollary.


With all these set-ups, we give a fully justified answer to the question in the begining of the section. 

%explain why only prove it for the same type.
\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FV}\;\HOLFreeVar{a}\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{x}\HOLTokenRightbrace{}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{form_functions}\;\HOLFreeVar{a}\;\HOLSymConst{=}\;\HOLSymConst{\HOLTokenEmpty{}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLConst{invar4bisim}\;\HOLFreeVar{x}\;\HOLFreeVar{t\sb{\mathrm{1}}}\;\HOLFreeVar{t\sb{\mathrm{2}}}\;\HOLFreeVar{a}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{phi}.\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[]\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{n}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[\HOLBoundVar{a};\;\HOLBoundVar{b}]\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLNumLit{0})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{c}\;\HOLBoundVar{d}\;\HOLBoundVar{n}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;(\HOLBoundVar{a}\HOLSymConst{::}\HOLBoundVar{b}\HOLSymConst{::}\HOLBoundVar{c}\HOLSymConst{::}\HOLBoundVar{d})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n\sb{\mathrm{0}}}\;\HOLBoundVar{l\sb{\mathrm{0}}}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Fun}\;\HOLBoundVar{n\sb{\mathrm{0}}}\;\HOLBoundVar{l\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{a})
\end{holmath}

\begin{proof}
 Suppose $a$ is a first order formula invariant for bisimulation with only one free variable $x$. Consider the modal consequence of $a$, which is the set of standard translations implied by $a$ on well-formed first order models, defined in the HOL as \HOLinline{\HOLFreeVar{MOC}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftbrace{}\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLBoundVar{phi}\;\HOLTokenBar{}\\
\;\;\;\;\;\HOLBoundVar{phi}\;\HOLTokenBar{}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}.\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[]\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{n}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;[\HOLBoundVar{a};\;\HOLBoundVar{b}]\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{n}\;\HOLSymConst{=}\;\HOLNumLit{0})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{a}\;\HOLBoundVar{b}\;\HOLBoundVar{c}\;\HOLBoundVar{d}\;\HOLBoundVar{n}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Pred}\;\HOLBoundVar{n}\;(\HOLBoundVar{a}\HOLSymConst{::}\HOLBoundVar{b}\HOLSymConst{::}\HOLBoundVar{c}\HOLSymConst{::}\HOLBoundVar{d})\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{F})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{n\sb{\mathrm{0}}}\;\HOLBoundVar{l\sb{\mathrm{0}}}.\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Fun}\;\HOLBoundVar{n\sb{\mathrm{0}}}\;\HOLBoundVar{l\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{IMAGE}\;\HOLBoundVar{\ensuremath{\sigma}}\;\ensuremath{\cal{U}}(:\HOLTyOp{num})\;\HOLSymConst{\HOLTokenSubset{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{Dom}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;\HOLFreeVar{a}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\HOLConst{feval}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\sigma}}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLBoundVar{phi})\HOLTokenRightbrace{}}
According to the discussion about compactness theorem proved as in interlude IV, it suffices to prove \HOLinline{\HOLFreeVar{a}} is implies by \HOLinline{\HOLFreeVar{MOC}}. Now, fix a model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and suppose \HOLinline{\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{f}} for any \HOLinline{\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{MOC}}, we prove \HOLinline{\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{a}}. 

Consider of the set \HOLinline{\HOLFreeVar{Tx}} of formulas \HOLinline{\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLFreeVar{phi}} such that \HOLinline{\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLFreeVar{phi})}. We prove there is a well-formed model \HOLinline{\HOLFreeVar{N}} with an evaluation \HOLinline{\HOLFreeVar{\ensuremath{\sigma}n}} such that for all \HOLinline{\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{Tx}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{a}\HOLTokenRightbrace{}}, we have \HOLinline{\HOLConst{feval}\;\HOLFreeVar{N}\;\HOLFreeVar{\ensuremath{\sigma}n}\;\HOLFreeVar{f}}. 
Suppose, in order to get a contradiction, that such a model does not exists, then for any well-formed model, once all the formulas in \HOLinline{\HOLFreeVar{Tx}} are satisfied, then \HOLinline{\HOLFreeVar{a}} is not satisfied. Then by compactness, there exists a finite subset of \HOLinline{\HOLFreeVar{Tx}} implies $\lnot a$. Taking its contrapositive, then \HOLinline{\HOLFreeVar{a}} implies the negation of the big conjunction\HOLinline{\HOLFreeVar{psi}} of finitely many elements in \HOLinline{\HOLFreeVar{Tx}}. By \texttt{ST_BIGCONJ} and \HOLinline{\HOLFreeVar{ST\HOLTokenUnderscore{}fNOT}}, a negated big conjunction of standard translations is again a standard translation. Hence \HOLinline{\HOLConst{fNOT}\;\HOLFreeVar{psi}} is in \HOLinline{\HOLFreeVar{MOC}}. Recall we have assumed \HOLinline{\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{f}} for any \HOLinline{\HOLFreeVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{MOC}}, so \HOLinline{\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;(\HOLConst{fNOT}\;\HOLFreeVar{psi})}, but also \HOLinline{\HOLConst{feval}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{psi}} by definition of \HOLinline{\HOLFreeVar{Tx}}, we have a contradiction. 

Hence we obtain a model $N$ and a valuation \HOLinline{\HOLFreeVar{\ensuremath{\sigma}n}} with desired property. Now let \HOLinline{\HOLFreeVar{w}} denote \HOLinline{\HOLFreeVar{\ensuremath{\sigma}}\;\HOLFreeVar{x}} and \HOLinline{\HOLFreeVar{v}} denote \HOLinline{\HOLFreeVar{\ensuremath{\sigma}n}\;\HOLFreeVar{x}}, we claim that if we regard both \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{N}} as modal models, then \HOLinline{\HOLFreeVar{w}} and \HOLinline{\HOLFreeVar{v}} are modal equivalent. To prove this, suppose \HOLinline{\HOLConst{satis}\;(\HOLFreeVar{fol2mm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{w}\;\HOLFreeVar{phi}}, then \HOLinline{\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLFreeVar{phi}} is in \HOLinline{\HOLFreeVar{Tx}} by definition of \HOLinline{\HOLFreeVar{Tx}}, hence \HOLinline{\HOLConst{feval}\;\HOLFreeVar{N}\;\HOLFreeVar{\ensuremath{\sigma}n}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLFreeVar{phi})}. By \texttt{mm2folm_folm2mm_feval}, this is equivalent to \HOLinline{\HOLConst{feval}\;(\HOLConst{mm2folm}\;(\HOLConst{folm2mm}\;\HOLFreeVar{N}))\;\HOLFreeVar{\ensuremath{\sigma}n}\;(\HOLConst{ST}\;\HOLFreeVar{x}\;\HOLFreeVar{phi})}, and if follows from \texttt{prop_2_47_i} that \HOLinline{\HOLConst{satis}\;(\HOLConst{folm2mm}\;\HOLFreeVar{N})\;\HOLFreeVar{v}\;\HOLFreeVar{phi}}. This proves \HOLinline{\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\\
\;\;\;\;\HOLConst{satis}\;(\HOLConst{folm2mm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;\HOLFreeVar{w}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLConst{satis}\;(\HOLConst{folm2mm}\;\HOLFreeVar{N})\;\HOLFreeVar{v}\;\HOLBoundVar{phi}}. The other direction is by a symmetry argument. 

If modal equivalence implies bisimularity, then we are done: Suppose modal equivalence implies bisimularity, then as \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLConst{folm2mm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}).\HOLFieldName{frame}.\HOLFieldName{world}} and \HOLinline{\HOLFreeVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;(\HOLConst{folm2mm}\;\HOLFreeVar{N}).\HOLFieldName{frame}.\HOLFieldName{world}} are modal equivalent, there exists a bisimulation between them. And as \HOLinline{\HOLFreeVar{a}} is invariant for bisimulation and is satisfied at \HOLinline{\HOLFreeVar{v}}, then it is also satisfied at \HOLinline{\HOLFreeVar{w}}. 

But actually it is not always the case. Hence we apply our strategy of taking a detour through some m-saturated model where modal equivalence and bisimularity coincides. Consider the ultraproduct modal models:
\HOLinline{\HOLFreeVar{Mst}\;\HOLSymConst{=}\;\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLConst{I}\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLConst{folm2mm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})}
,
\HOLinline{\HOLFreeVar{Nst}\;\HOLSymConst{=}\;\HOLConst{ultraproduct_model}\;\HOLFreeVar{U}\;\HOLConst{I}\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLConst{folm2mm}\;\HOLFreeVar{N})} for a countably incomplete ultrafilter $U$ on $I$, we proved in interlude II that such ultrafilters exists. 
Embed the worlds $w,v$ into these models by \HOLinline{\HOLFreeVar{wst}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{fw}\;\HOLTokenBar{}\;\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLConst{I}\;(\HOLConst{models2worlds}\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLConst{folm2mm}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}))\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLFreeVar{w})\;\HOLBoundVar{fw}\HOLTokenRightbrace{}},
\HOLinline{\HOLFreeVar{vst}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{fv}\;\HOLTokenBar{}\;\HOLConst{Uequiv}\;\HOLFreeVar{U}\;\HOLConst{I}\;(\HOLConst{models2worlds}\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLConst{folm2mm}\;\HOLFreeVar{N}))\;(\HOLTokenLambda{}\HOLBoundVar{i}.\;\HOLFreeVar{v})\;\HOLBoundVar{fv}\HOLTokenRightbrace{}} respectively. We claim \HOLinline{\HOLConst{bisim_world}\;\HOLFreeVar{Mst}\;\HOLFreeVar{Nst}\;\HOLFreeVar{wst}\;\HOLFreeVar{vst}}. As we can check: by \texttt{lemma_2_73} and \texttt{lemma_2_65}, \HOLinline{\HOLFreeVar{Mst}} and \HOLinline{\HOLFreeVar{Nst}} are m-saturated, hence bisimularity and modal equivalence coincides. Hence we just need to prove that \HOLinline{\HOLFreeVar{wst}} and \HOLinline{\HOLFreeVar{vst}} are modal equivalent. By \texttt{ultraproduct_mm2folm_folm2mm_comm_feval}, $w$ and $wst$ satisfied the same well-formed formulas, and same for $v$ and $vst$. As standard translations are well formed first order formulas, modal equivalence between \HOLinline{\HOLFreeVar{w}} and \HOLinline{\HOLFreeVar{v}} proved before implies modal equivalence between \HOLinline{\HOLFreeVar{wst}} and \HOLinline{\HOLFreeVar{vst}}. We obtain a modal equivalence and hence a bisimulation between \HOLinline{\HOLFreeVar{wst}} and \HOLinline{\HOLFreeVar{vst}}.

As \HOLinline{\HOLFreeVar{a}} is satisfied as \HOLinline{\HOLFreeVar{v}}, it is satisfied at \HOLinline{\HOLFreeVar{vst}} by \texttt{ultraproduct_mm2folm_folm2mm_comm_feval}, as \HOLinline{\HOLFreeVar{a}} is invariant for bisimulation, \HOLinline{\HOLFreeVar{a}} is satisfied at \HOLinline{\HOLFreeVar{wst}} as well. By \texttt{ultraproduct_mm2folm_folm2mm_comm_feval} again, it shows \HOLinline{\HOLFreeVar{a}} is satisfied at \HOLinline{\HOLFreeVar{w}}. This complete the proof.


\end{proof}
\subsection{Positive existential formula vs preserved under simulations}
In this section, we use a similar proof strategy as we did in \texttt{thm_2_68_half1} to present a result about the concept `half of a bisimulation', which is called `simulation'.
\begin{holmath}
  \HOLConst{sim}\;\HOLFreeVar{Z}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{w}\;\HOLBoundVar{w\sp{\prime}}.\\
\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{Z}\;\HOLBoundVar{w}\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{valt}\;\HOLBoundVar{p}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{valt}\;\HOLBoundVar{p})\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{v}.\\
\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w}\;\HOLBoundVar{v}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{v\sp{\prime}}.\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{Z}\;\HOLBoundVar{v}\;\HOLBoundVar{v\sp{\prime}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{rel}\;\HOLBoundVar{w\sp{\prime}}\;\HOLBoundVar{v\sp{\prime}}
\end{holmath}

The concept corresponds to `invariant for bisimulation' is called `preserved by simulation', it takes the types of models as parameters by exactly the same reason why we need those parameters for the definition \texttt{invar4bisim}:

\begin{holmath}
  \HOLConst{preserved_under_sim}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{\ensuremath{\nu}}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenDefEquality{}}\\
\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{Z}\;\HOLBoundVar{w}\;\HOLBoundVar{w\sp{\prime}}.\\
\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{sim}\;\HOLBoundVar{Z}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\HOLBoundVar{Z}\;\HOLBoundVar{w}\;\HOLBoundVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w\sp{\prime}}\;\HOLFreeVar{phi}
\end{holmath}

The aim of the rest of the section is to characterise formulas preserved under bisimulation as positively existential formulas. A positive existential formula is a modal formula which it either equal to $\top$ or $\bot$, or is built up using only contains positive connectives, namely `$\land$',`$\lor$' or `$\Diamond$'. Its definition is formalised as an inductive relation.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{PE}\;\HOLSymConst{\ensuremath{\bot}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{PE}\;\HOLConst{TRUE}\;\HOLSymConst{\HOLTokenConj{}}\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{p}.\;\HOLConst{PE}\;(\HOLConst{VAR}\;\HOLBoundVar{p}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}.\;\HOLConst{PE}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{PE}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{PE}\;(\HOLConst{AND}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}.\;\HOLConst{PE}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{PE}\;\HOLBoundVar{f\sb{\mathrm{2}}}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{PE}\;(\HOLConst{DISJ}\;\HOLBoundVar{f\sb{\mathrm{1}}}\;\HOLBoundVar{f\sb{\mathrm{2}}}))\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLConst{PE}\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{PE}\;(\HOLSymConst{\ensuremath{\Diamond}}\;\HOLBoundVar{f})
\end{holmath}

A useful syntactial feature of such formulas is that any finite conjunction or disjunction of positive existential formulas is again a positive existential formula. Again, instead of explicitly define big conjunction and big disjunction, we use the following propositions to captures this idea:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{ss}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{ss}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{PE}\;\HOLBoundVar{f})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{ff}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{PE}\;\HOLBoundVar{ff}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{ff}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{ss}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{f})
  \ensuremath{\HOLTokenTurnstile}\HOLConst{FINITE}\;\HOLFreeVar{ss}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{ss}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{PE}\;\HOLBoundVar{f})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{ff}.\\
\;\;\;\;\;\;\;\;\;\HOLConst{PE}\;\HOLBoundVar{ff}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\\
\;\;\;\;\;\;\;\;\;\;\;\;\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\;\;\;\;\;\;\;\;(\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{ff}\;\HOLSymConst{\HOLTokenEquiv{}}\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{f}.\;\HOLBoundVar{f}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{ss}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{f})
\end{holmath}


%Intuitively, positive existential formula is presersed because... if I can do this..
By induction using \texttt{PE_ind}, it is easy to proof half of our main theorem:

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{PE}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mu}}\;\HOLBoundVar{\ensuremath{\nu}}.\;\HOLConst{preserved_under_sim}\;\HOLBoundVar{\ensuremath{\mu}}\;\HOLBoundVar{\ensuremath{\nu}}\;\HOLFreeVar{phi}
\end{holmath}

The reverse direction of \texttt{thm_2_78_half1_lemma} will get m-saturated to be involved, since m-saturated models are not only good for bisimulations, but also give nice result for simulations.

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{M_sat}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{M_sat}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLFreeVar{w\sp{\prime}}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;(\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\;\HOLConst{PE}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLFreeVar{w\sp{\prime}}\;\HOLBoundVar{phi})\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{Z}.\;\HOLConst{sim}\;\HOLBoundVar{Z}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLBoundVar{Z}\;\HOLFreeVar{w}\;\HOLFreeVar{w\sp{\prime}}
\end{holmath}
\begin{proof}
   Under the assumptions, \HOLinline{\HOLTokenLambda{}\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{w\sb{\mathrm{2}}}.\\
\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{phi}.\;\HOLConst{PE}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w\sb{\mathrm{1}}}\;\HOLBoundVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}'}}\;\HOLBoundVar{w\sb{\mathrm{2}}}\;\HOLBoundVar{phi}} gives a simulation relation. Checking it is indeed a simulation is completely analogue to the proof of \texttt{prop_2_54}.
\end{proof}

%Although we have give the definition as allow \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{N}} to be of distinct type. For the same reason that we only prove the characterisation for models of the same type, we only consider \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{N}} to be of the same type in our main theorem. explain in the begining of chapter?

We will take a detour through m-saturated models again, but since this time we are working within a modal language instead of first order logic, we only need to use ultrafilter extensions rather than ultrapowers.%if possible, talk more about this difference

\begin{holmath}
  \ensuremath{\HOLTokenTurnstile}\HOLConst{preserved_under_sim}\;\HOLFreeVar{\ensuremath{\nu}}\;\HOLFreeVar{\ensuremath{\nu}}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenExists{}}\HOLBoundVar{phi\sb{\mathrm{0}}}.\;\HOLConst{equiv0}\;\HOLFreeVar{\ensuremath{\mu}}\;\HOLFreeVar{phi}\;\HOLBoundVar{phi\sb{\mathrm{0}}}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{PE}\;\HOLBoundVar{phi\sb{\mathrm{0}}}
\end{holmath}

At first glance, the statement may looks awkward because the assumption is about preservsion under simulation for models of type $(\beta\to bool)\to bool$, but the conclusion is about equivalent to a formula on models of type $\beta$. This is because our detour through ultrafilter extensions, which embeds a model with $\beta$-worlds into a model with $(\beta\to bool)\to bool$-worlds. It means that for the usual language statement, although the hypothesis is talking about preserved under simulation for any types, what we actually require in the proof is only the fact that the formula is preserved under simulation for a certain type.
\begin{proof}
  Suppose $\phi$ is preserved under simulation. Consider the set of positive existential consequence of $\phi$, defined as \HOLinline{\HOLFreeVar{PEC}\;\HOLSymConst{=}\\
\;\;\HOLTokenLeftbrace{}\HOLBoundVar{psi}\;\HOLTokenBar{}\\
\;\;\;\;\;\HOLConst{PE}\;\HOLBoundVar{psi}\;\HOLSymConst{\HOLTokenConj{}}\\
\;\;\;\;\;\HOLSymConst{\HOLTokenForall{}}\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}.\;\HOLBoundVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLFreeVar{phi}\;\HOLSymConst{\HOLTokenImp{}}\;\HOLConst{satis}\;\HOLBoundVar{\ensuremath{\mathfrak{M}}}\;\HOLBoundVar{w}\;\HOLBoundVar{psi}\HOLTokenRightbrace{}}
By \texttt{modal_compactness_corollary} proved by the last interlude, if we can prove for any model \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{w}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}, \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{psi}} for all \HOLinline{\HOLFreeVar{psi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{PEC}} implies \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{phi}}, then there exists a finite subset $S$ of \HOLinline{\HOLFreeVar{PEC}} that entails $\phi$. This will prove $\phi$ is equivalent to the conjunction of all the formulas in $S$, which is again a positive existential formula.

So we prove the entailment from \HOLinline{\HOLFreeVar{PEC}} to $\phi$. Suppose \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{psi}} for all \HOLinline{\HOLFreeVar{psi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{PEC}} , we prove \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{phi}}. Define \HOLinline{\HOLFreeVar{\ensuremath{\Gamma}}\;\HOLSymConst{=}\;\HOLTokenLeftbrace{}\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{psi}\;\HOLTokenBar{}\;\HOLConst{PE}\;\HOLBoundVar{psi}\;\HOLSymConst{\HOLTokenConj{}}\;\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLBoundVar{psi})\HOLTokenRightbrace{}}. We claim that there exists a model that realises the set \HOLinline{\HOLFreeVar{\ensuremath{\Gamma}}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{phi}\HOLTokenRightbrace{}}. By \texttt{modal_compactness_thm}, it suffices to prove each finite subset of \HOLinline{\HOLFreeVar{\ensuremath{\Gamma}}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{phi}\HOLTokenRightbrace{}} is realised by some model. Suppose there exists a finite subset of \HOLinline{\HOLFreeVar{\ensuremath{\Gamma}}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{phi}\HOLTokenRightbrace{}} which cannot be realised by any model, then there exists $\lnot\psi_0,\cdots,\lnot\psi_n\in \Gamma$ such that for any model \HOLinline{\HOLFreeVar{N}} and any world $v$ of it, \HOLinline{\HOLConst{satis}\;\HOLFreeVar{N}\;\HOLFreeVar{v}\;\HOLFreeVar{psii}} for some $i$. By \texttt{PE_BIGDISJ}, as all these $\psi$'s are positive existential, there exists a positive existential formula $\psi$ which is satisfied precisely when some $\psi_i$ is satisfied. Hence \HOLinline{\HOLFreeVar{psi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{PEC}}. As \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} entails \HOLinline{\HOLFreeVar{PEC}}, we have \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{psi}}. But then it means \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{psii}} for some $i$, but from the definition of the $\psi$'s, \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{psii})} for any $\psi_i$, this is a contradiction. 

Hence we obtain a model \HOLinline{\HOLFreeVar{N}} realising \HOLinline{\HOLFreeVar{\ensuremath{\Gamma}}\;\HOLSymConst{\HOLTokenUnion{}}\;\HOLTokenLeftbrace{}\HOLFreeVar{phi}\HOLTokenRightbrace{}} at point $v$. For any positive existential formula $\psi$ such that \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{psi}}, we have \HOLinline{\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{psi}\;\HOLSymConst{\HOLTokenIn{}}\;\HOLFreeVar{\ensuremath{\Gamma}}}, so \HOLinline{\HOLConst{satis}\;\HOLFreeVar{N}\;\HOLFreeVar{v}\;(\HOLSymConst{\HOLTokenNeg{}}\HOLFreeVar{psi})}. Hence for any positive existential $\psi$, if \HOLinline{\HOLConst{satis}\;\HOLFreeVar{N}\;\HOLFreeVar{v}\;\HOLFreeVar{psi}}, then \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{psi}}. We migrant this implication onto ultrafilter extensions: Now take the ultrafilter extension of \HOLinline{\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLFreeVar{N}} respectively. By \texttt{prop_2_59_ii}, for any positive existential $\psi$, \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{N})\;(\HOLConst{principle_UF}\;\HOLFreeVar{v}\;\HOLFreeVar{N}.\HOLFieldName{frame}.\HOLFieldName{world})\;\HOLFreeVar{psi}} implies \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;(\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world})\;\HOLFreeVar{psi}}. As \HOLinline{\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}} and \HOLinline{\HOLConst{UE}\;\HOLFreeVar{N}} are m-saturated by \texttt{prop_2_61}, by \texttt{exercise_2_7_1}, we have a simulation linking \HOLinline{\HOLConst{principle_UF}\;\HOLFreeVar{v}\;\HOLFreeVar{N}.\HOLFieldName{frame}.\HOLFieldName{world}} to \HOLinline{\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world}}. 

As \HOLinline{\HOLConst{satis}\;\HOLFreeVar{N}\;\HOLFreeVar{v}\;\HOLFreeVar{phi}}, \texttt{prop_2_59_ii} gives \HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{N})\;(\HOLConst{principle_UF}\;\HOLFreeVar{v}\;\HOLFreeVar{N}.\HOLFieldName{frame}.\HOLFieldName{world})\;\HOLFreeVar{phi}}, as $\phi$ is preserved under simulation, we have 
\HOLinline{\HOLConst{satis}\;(\HOLConst{UE}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}})\;(\HOLConst{principle_UF}\;\HOLFreeVar{w}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}.\HOLFieldName{frame}.\HOLFieldName{world})\;\HOLFreeVar{phi}}. Again by  \texttt{prop_2_59_ii} , it implies \HOLinline{\HOLConst{satis}\;\HOLFreeVar{\ensuremath{\mathfrak{M}}}\;\HOLFreeVar{w}\;\HOLFreeVar{phi}}. This completes the proof.
\end{proof}
\end{document}

% Local variables:
% mode: latex
% End:
